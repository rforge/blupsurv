<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-type" content="text/html; charset=ISO-8859-1" />
<link rel="stylesheet" href="../robodoc.css" type="text/css" />
<title>./blupsurv/R/bivrec.r</title>
<!-- Source: ./blupsurv/R/bivrec.r -->
<!-- Generated with ROBODoc Version 4.99.36 (Jun 17 2008) -->
</head>
<body>
<div id="logo">
<a name="robo_top_of_doc">blupsurv</a>
</div> <!-- logo -->
<div id="navigation">
<a class="menuitem" href="./bivrec_rbivrecFit2Festimation.html#robo6">estimation</a><a class="menuitem" href="../robo_functions.html#robo_top_of_doc">Functions</a></div> <!-- navigation -->
<div id="content">
<h3>TABLE OF CONTENTS</h3>
<ul>
<li>1. <a href="#robo17">estimation/updatedispohls</a></li>
</ul>
<hr />
<a name="estimation2fupdatedispohls"></a>
<a name="robo17"></a><h2>estimation/updatedispohls [ Functions ]</h2>

<p class="item_name">NAME</p>
<pre>    <strong>updatedispohls</strong> --- Ohlsson-type dispersion parameter estimators
</pre>
<p class="item_name">FUNCTION</p>
<p>   Compute dispersion parameter estimators using the method proposed by Ohlsson 
   et al. See the paper for the reference.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">956 </span><strong>updatedispohls</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> datamatd<span class="sign">,</span> alphars<span class="sign">,</span> alpharsd<span class="sign">,</span> 
<span class="line_number">957 </span>                            as<span class="sign">,</span> asd<span class="sign">,</span> betahat<span class="sign">,</span> betadhat<span class="sign">,</span> fixzero<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m              number of clusters
    Ji             cluster sizes
    datamat    data matrix generated by <a href="./bivrec_rinitialization2Fmakedatamat.html#robo37">makedatamat</a> for event 1
    datamatd   data matrix generated by <a href="./bivrec_rinitialization2Fmakedatamat.html#robo37">makedatamat</a> for event 2
    alphars    matrix of baseline hazard parameters for event 1
    alpharsd   matrix of baseline hazard parameters for event 2
    as         matrix of discretization breakpoints for event 1
    asd        matrix of discretization breakpoints for event 2
    betahat    regression coefficient estimates for event 1
    betadhat   regression coefficient estimates for event 2
    fixzero    list of estimators that should be fixed at zero (testing only)
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    sigma2hat      cluster-level dispersion for process 1
    sigma2dhat     cluster-level dispersion for process 2
    nu2hat             subject-level dispersion for process 1
    nu2dhat            subject-level dispersion for process 2
    thetahat       subject-level covariance
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number"> 960 </span><span class="sign">{</span>
<span class="line_number"> 961 </span>    jimax <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>Ji<span class="sign">)</span>
<span class="line_number"> 962 </span>    Smu <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>Sdelta <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>
<span class="line_number"> 963 </span>    Seta <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>SDelta <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>
<span class="line_number"> 964 </span>    
<span class="line_number"> 965 </span>    <span class="comment"># Prepare data for Fortran function <a href="../src/bivrec_ffortran2Ffsmuij.html#robo31">fsmuij</a> to compute sum for event 1</span>
<span class="line_number"> 966 </span>    covs <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>datamat<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 8<span class="sign">)</span>
<span class="line_number"> 967 </span>    ncovs <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span>
<span class="line_number"> 968 </span>    d <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span>
<span class="line_number"> 969 </span>    index <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span><span class="quote">"i"</span><span class="sign">,</span> <span class="quote">"j"</span><span class="sign">,</span> <span class="quote">"k"</span><span class="sign">,</span> <span class="quote">"r"</span><span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">)</span><span class="sign">]</span>
<span class="line_number"> 970 </span>    delta <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span><span class="sign">,</span> <span class="quote">"delta"</span><span class="sign">]</span>
<span class="line_number"> 971 </span>    
<span class="line_number"> 972 </span>    <span class="comment"># The FORTRAN function <a href="../src/bivrec_ffortran2Ffsmuij.html#robo31">fsmuij</a> computes a matrix of size m x max(Ji), whose </span>
<span class="line_number"> 973 </span>    <span class="comment"># (i, j) entry is sum(mu_rijks) over all r,k,s</span>
<span class="line_number"> 974 </span>    Sm <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span><span class="sign">.</span>Fortran<span class="sign">(</span><span class="quote">"<a href="../src/bivrec_ffortran2Ffsmuij.html#robo31">fsmuij</a>"</span><span class="sign">,</span>
<span class="line_number"> 975 </span>            betahat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 976 </span>            index <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>index<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 977 </span>            delta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>delta<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 978 </span>            Z <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 979 </span>            alphars <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>alphars<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 980 </span>            as <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 981 </span>            d <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>d<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 982 </span>            ncovs <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ncovs<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 983 </span>            nr <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>alphars<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 984 </span>            ns <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>alphars<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 985 </span>            m <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>m<span class="sign">)</span><span class="sign">,</span> maxj <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>max<span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 986 </span>            Smu <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Smu<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 987 </span>            Sdelta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Sdelta<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number"> 988 </span>
<span class="line_number"> 989 </span>    <span class="comment"># extract sums from FORTRAN output</span>
<span class="line_number"> 990 </span>    Smu <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>Sm<span class="sign">$</span>Smu<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number"> 991 </span>    Sdelta <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>Sm<span class="sign">$</span>Sdelta<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number"> 992 </span>    
<span class="line_number"> 993 </span>    <span class="comment"># Repeat FORTRAN call for event 2</span>
<span class="line_number"> 994 </span>    covs <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>datamatd<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamatd<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamatd<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 8<span class="sign">)</span>
<span class="line_number"> 995 </span>    ncovs <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span>
<span class="line_number"> 996 </span>    d <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span>
<span class="line_number"> 997 </span>    index <span class="sign">&lt;</span><span class="sign">-</span> datamatd<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span><span class="quote">"i"</span><span class="sign">,</span> <span class="quote">"j"</span><span class="sign">,</span> <span class="quote">"k"</span><span class="sign">,</span> <span class="quote">"r"</span><span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">)</span><span class="sign">]</span>
<span class="line_number"> 998 </span>    Delta <span class="sign">&lt;</span><span class="sign">-</span> datamatd<span class="sign">[</span><span class="sign">,</span> <span class="quote">"delta"</span><span class="sign">]</span>
<span class="line_number"> 999 </span>    
<span class="line_number">1000 </span>    <span class="comment"># Compute sum of eta_ij analogously</span>
<span class="line_number">1001 </span>    Se <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span><span class="sign">.</span>Fortran<span class="sign">(</span><span class="quote">"<a href="../src/bivrec_ffortran2Ffsmuij.html#robo31">fsmuij</a>"</span><span class="sign">,</span>
<span class="line_number">1002 </span>            betahat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>betadhat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1003 </span>            index <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>index<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1004 </span>            delta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Delta<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1005 </span>            Z <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1006 </span>            alphars <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>alpharsd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1007 </span>            as <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>asd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1008 </span>            d <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>d<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1009 </span>            ncovs <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ncovs<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1010 </span>            nr <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>alpharsd<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1011 </span>            ns <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>alpharsd<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1012 </span>            m <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>m<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1013 </span>            maxj <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>max<span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1014 </span>            Smu <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Seta<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1015 </span>            Sdelta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>SDelta<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1016 </span>
<span class="line_number">1017 </span>    Seta <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>Se<span class="sign">$</span>Smu<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number">1018 </span>    SDelta <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>Se<span class="sign">$</span>Sdelta<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number">1019 </span>    
<span class="line_number">1020 </span>    <span class="comment"># Compute sum(mu_i*) for both processes</span>
<span class="line_number">1021 </span>    Smui <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">apply</span><span class="sign">(</span>Smu<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">)</span>
<span class="line_number">1022 </span>    Setai <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">apply</span><span class="sign">(</span>Seta<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">)</span>
<span class="line_number">1023 </span>    
<span class="line_number">1024 </span>    <span class="comment"># Begin computing the Ohlsson-type estimates</span>
<span class="line_number">1025 </span>    Xtild <span class="sign">&lt;</span><span class="sign">-</span> Sdelta <span class="sign">/</span> Smu
<span class="line_number">1026 </span>    Ztild <span class="sign">&lt;</span><span class="sign">-</span> SDelta <span class="sign">/</span> Seta
<span class="line_number">1027 </span>    Xtildi <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">apply</span><span class="sign">(</span>Sdelta<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">)</span> <span class="sign">/</span> Smui
<span class="line_number">1028 </span>    Ztildi <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">apply</span><span class="sign">(</span>SDelta<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">)</span> <span class="sign">/</span> Setai
<span class="line_number">1029 </span>    Ztildii <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>Ztildi<span class="sign">,</span> Ji<span class="sign">)</span>
<span class="line_number">1030 </span>
<span class="line_number">1031 </span>    <span class="comment"># This is a simplistic correction to attempt to resolve some occasional</span>
<span class="line_number">1032 </span>    <span class="comment"># computational problems caused by too large or too small estimated means.</span>
<span class="line_number">1033 </span>    <span class="comment"># This line replaces subject estimates which are in the most extreme 5\% by</span>
<span class="line_number">1034 </span>    <span class="comment"># the cluster-level estimate for the corresponding cluster.</span>
<span class="line_number">1035 </span>     Ztild<span class="sign">[</span>Ztild <span class="sign">&gt;</span> <span class="keyword">quantile</span><span class="sign">(</span>Ztild<span class="sign">,</span> <span class="sign">.</span>975<span class="sign">)</span> <span class="sign">|</span> Ztild <span class="sign">&lt;</span> <span class="keyword">quantile</span><span class="sign">(</span>Ztild<span class="sign">,</span> <span class="sign">.</span>025<span class="sign">)</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 
<span class="line_number">1036 </span>         Ztildii<span class="sign">[</span>Ztild <span class="sign">&gt;</span> <span class="keyword">quantile</span><span class="sign">(</span>Ztild<span class="sign">,</span> <span class="sign">.</span>975<span class="sign">)</span> <span class="sign">|</span> Ztild <span class="sign">&lt;</span> <span class="keyword">quantile</span><span class="sign">(</span>Ztild<span class="sign">,</span> <span class="sign">.</span>025<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">1037 </span>    
<span class="line_number">1038 </span>    <span class="comment"># Subject-level Ohlsson estimates</span>
<span class="line_number">1039 </span>    nu2hat <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">;</span>nu2dhat <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">;</span>thetahat <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">;</span>thetadenom <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">;</span>sigma2hat <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">;</span>sigma2dhat <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">;</span>
<span class="line_number">1040 </span>    <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span>m<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1041 </span>        <span class="keyword">for</span><span class="sign">(</span>j in 1<span class="sign">:</span>Ji<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1042 </span>            nu2hat <span class="sign">&lt;</span><span class="sign">-</span> nu2hat <span class="sign">+</span> Smu<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">*</span> <span class="sign">(</span>Xtild<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">-</span> Xtildi<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">^</span>2 
<span class="line_number">1043 </span>            nu2dhat <span class="sign">&lt;</span><span class="sign">-</span> nu2dhat <span class="sign">+</span> Seta<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">*</span> <span class="sign">(</span>Ztild<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">-</span> Ztildi<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">^</span>2 
<span class="line_number">1044 </span>            thetahat <span class="sign">&lt;</span><span class="sign">-</span> thetahat <span class="sign">+</span> <span class="sign">(</span>Xtild<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">-</span> Xtildi<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span>
<span class="line_number">1045 </span>                            <span class="sign">(</span>Ztild<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">-</span> Ztildi<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1046 </span>            thetadenom <span class="sign">&lt;</span><span class="sign">-</span> thetadenom <span class="sign">+</span> <span class="sign">(</span>1 <span class="sign">+</span> 1 <span class="sign">/</span> Smui<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">/</span> Setai<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">*</span>
<span class="line_number">1047 </span>                    <span class="keyword">sum</span><span class="sign">(</span>Smu<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">]</span> <span class="sign">*</span> Seta<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">]</span><span class="sign">)</span><span class="sign">)</span> <span class="sign">-</span> <span class="sign">(</span>Smu<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">/</span> Smui<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span>
<span class="line_number">1048 </span>                    Seta<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">/</span> Setai<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1049 </span>        <span class="sign">}</span>
<span class="line_number">1050 </span>    <span class="sign">}</span>
<span class="line_number">1051 </span>    <span class="comment"># Complete the estimates of the dispersion parameters.</span>
<span class="line_number">1052 </span>    nu2hat <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>nu2hat <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>Ji <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">)</span> <span class="sign">/</span>
<span class="line_number">1053 </span>            <span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span>Smui<span class="sign">)</span> <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span><span class="keyword">apply</span><span class="sign">(</span>Smu<span class="sign">^</span>2<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">)</span> <span class="sign">/</span> Smui<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1054 </span>    nu2dhat <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>nu2dhat <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>Ji <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">)</span> <span class="sign">/</span>
<span class="line_number">1055 </span>            <span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span>Setai<span class="sign">)</span> <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span><span class="keyword">apply</span><span class="sign">(</span>Seta<span class="sign">^</span>2<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">)</span> <span class="sign">/</span> Setai<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1056 </span>    thetahat <span class="sign">&lt;</span><span class="sign">-</span> thetahat <span class="sign">/</span> thetadenom
<span class="line_number">1057 </span>
<span class="line_number">1058 </span>    <span class="comment"># Fix parameters at 0 if desired</span>
<span class="line_number">1059 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="comment">!is.null(fixzero)){</span>
<span class="line_number">1060 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="quote">"nu2hat"</span><span class="sign">%</span>in<span class="sign">%</span>fixzero<span class="sign">)</span> nu2hat <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">1061 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="quote">"nu2dhat"</span><span class="sign">%</span>in<span class="sign">%</span>fixzero<span class="sign">)</span> nu2dhat <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">1062 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="quote">"thetahat"</span><span class="sign">%</span>in<span class="sign">%</span>fixzero<span class="sign">)</span> thetahat <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">1063 </span>    <span class="sign">}</span>
<span class="line_number">1064 </span>    
<span class="line_number">1065 </span>    <span class="comment"># The Ohlsson - type estimators do not guarantee that the esimated covariance </span>
<span class="line_number">1066 </span>    <span class="comment"># matrix is valid. This code truncates the estimate of thetahat if needed</span>
<span class="line_number">1067 </span>    <span class="keyword">if</span><span class="sign">(</span>nu2hat<span class="sign">&lt;</span><span class="sign">.</span>001<span class="sign">)</span> nu2hat <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">.</span>001
<span class="line_number">1068 </span>    <span class="keyword">if</span><span class="sign">(</span>nu2dhat<span class="sign">&lt;</span><span class="sign">.</span>001<span class="sign">)</span> nu2dhat <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">.</span>001
<span class="line_number">1069 </span>    badtheta <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span>thetahat <span class="sign">/</span> <span class="keyword">sqrt</span><span class="sign">(</span>nu2hat <span class="sign">*</span> nu2dhat<span class="sign">)</span> <span class="sign">&gt;</span> 1 <span class="sign">|</span> 
<span class="line_number">1070 </span>        thetahat <span class="sign">/</span> <span class="keyword">sqrt</span><span class="sign">(</span>nu2hat <span class="sign">*</span> nu2dhat<span class="sign">)</span><span class="sign">&lt;</span> <span class="sign">-</span>1<span class="sign">)</span>
<span class="line_number">1071 </span>    <span class="keyword">if</span><span class="sign">(</span>inherits<span class="sign">(</span>badtheta<span class="sign">,</span> <span class="quote">"try - error"</span><span class="sign">)</span> <span class="sign">|</span> is<span class="sign">.</span>na<span class="sign">(</span>badtheta<span class="sign">)</span><span class="sign">)</span> <span class="sign">{</span>browser<span class="sign">(</span><span class="sign">)</span><span class="sign">;</span> <span class="keyword">return</span><span class="sign">(</span>0<span class="sign">)</span><span class="sign">}</span>
<span class="line_number">1072 </span>    <span class="keyword">if</span><span class="sign">(</span>badtheta<span class="sign">)</span> thetahat <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span>sign<span class="sign">(</span>thetahat<span class="sign">)</span> <span class="sign">*</span> <span class="keyword">sqrt</span><span class="sign">(</span>nu2hat <span class="sign">*</span> nu2dhat<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1073 </span>    <span class="keyword">if</span><span class="sign">(</span>inherits<span class="sign">(</span>thetahat<span class="sign">,</span> <span class="quote">"try - error"</span><span class="sign">)</span><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>0<span class="sign">)</span>
<span class="line_number">1074 </span>    
<span class="line_number">1075 </span>    <span class="comment">#! Estimate the cluster - level dispersion parameters </span>
<span class="line_number">1076 </span>    zij <span class="sign">&lt;</span><span class="sign">-</span> Smu <span class="sign">/</span> <span class="sign">(</span>Smu <span class="sign">+</span> 1 <span class="sign">/</span> nu2hat<span class="sign">)</span>
<span class="line_number">1077 </span>    zi <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">apply</span><span class="sign">(</span>zij<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">)</span>
<span class="line_number">1078 </span>    zijd <span class="sign">&lt;</span><span class="sign">-</span> Seta <span class="sign">/</span> <span class="sign">(</span>Seta <span class="sign">+</span> 1 <span class="sign">/</span> nu2dhat<span class="sign">)</span>
<span class="line_number">1079 </span>    zid <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">apply</span><span class="sign">(</span>zijd<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">)</span>
<span class="line_number">1080 </span>    
<span class="line_number">1081 </span>    Xztildi <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">apply</span><span class="sign">(</span>zij <span class="sign">*</span> Xtild<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">)</span> <span class="sign">/</span> zi
<span class="line_number">1082 </span>    Zztildi <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">apply</span><span class="sign">(</span>zijd <span class="sign">*</span> Ztild<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">)</span> <span class="sign">/</span> zid
<span class="line_number">1083 </span>    
<span class="line_number">1084 </span>    Xztild <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>zi <span class="sign">*</span> Xztildi<span class="sign">)</span> <span class="sign">/</span> <span class="keyword">sum</span><span class="sign">(</span>zi<span class="sign">)</span>
<span class="line_number">1085 </span>    Zztild <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>zid <span class="sign">*</span> Zztildi<span class="sign">)</span> <span class="sign">/</span> <span class="keyword">sum</span><span class="sign">(</span>zid<span class="sign">)</span>
<span class="line_number">1086 </span>    
<span class="line_number">1087 </span>    sigma2hat <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span>zi <span class="sign">*</span> <span class="sign">(</span>Xztildi <span class="sign">-</span> Xztild<span class="sign">)</span><span class="sign">^</span>2<span class="sign">)</span> <span class="sign">-</span> nu2hat <span class="sign">*</span> <span class="sign">(</span>m <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">)</span> <span class="sign">/</span>
<span class="line_number">1088 </span>                <span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span>zi<span class="sign">)</span> <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>zi<span class="sign">^</span>2<span class="sign">)</span> <span class="sign">/</span> <span class="keyword">sum</span><span class="sign">(</span>zi<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1089 </span>    sigma2dhat <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span>zid <span class="sign">*</span> <span class="sign">(</span>Zztildi <span class="sign">-</span> Zztild<span class="sign">)</span><span class="sign">^</span>2<span class="sign">)</span> <span class="sign">-</span> nu2dhat <span class="sign">*</span> <span class="sign">(</span>m <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">)</span> <span class="sign">/</span>
<span class="line_number">1090 </span>                <span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span>zid<span class="sign">)</span> <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>zid<span class="sign">^</span>2<span class="sign">)</span> <span class="sign">/</span> <span class="keyword">sum</span><span class="sign">(</span>zid<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1091 </span>
<span class="line_number">1092 </span>    <span class="comment"># Fix parameters at 0 if desired</span>
<span class="line_number">1093 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="comment">!is.null(fixzero)){</span>
<span class="line_number">1094 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="quote">"sigma2hat"</span><span class="sign">%</span>in<span class="sign">%</span>fixzero<span class="sign">)</span> sigma2hat <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">1095 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="quote">"sigma2dhat"</span><span class="sign">%</span>in<span class="sign">%</span>fixzero<span class="sign">)</span> sigma2dhat <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">1096 </span>    <span class="sign">}</span>
<span class="line_number">1097 </span>    
<span class="line_number">1098 </span>    <span class="comment"># Format for output    </span>
<span class="line_number">1099 </span>    <span class="keyword">return</span><span class="sign">(</span><span class="keyword">list</span><span class="sign">(</span>sigma2hat <span class="sign">=</span> sigma2hat<span class="sign">,</span>
<span class="line_number">1100 </span>                sigma2dhat <span class="sign">=</span> sigma2dhat<span class="sign">,</span>
<span class="line_number">1101 </span>                nu2hat <span class="sign">=</span> nu2hat<span class="sign">,</span>
<span class="line_number">1102 </span>                nu2dhat <span class="sign">=</span> nu2dhat<span class="sign">,</span>
<span class="line_number">1103 </span>                thetahat <span class="sign">=</span> thetahat<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1104 </span><span class="sign">}</span>
</pre>

</div> <!-- content -->
<div id="footer">
<p>Generated from ./blupsurv/R/bivrec.r with <a href="http://www.xs4all.nl/~rfsber/Robo/robodoc.html">ROBODoc</a> V4.99.36 on Sun Jun 29 2008 13:34:50
</p>
</div> <!-- footer -->

<!-- Start of StatCounter Code -->
<script type="text/javascript">
var sc_project=3825293; 
var sc_invisible=1; 
var sc_partition=34; 
var sc_click_stat=1; 
var sc_security="2dd2334a"; 
</script>

<script type="text/javascript"
src="http://www.statcounter.com/counter/counter_xhtml.js"></script><noscript><div
class="statcounter"><a href="http://www.statcounter.com/"
target="_blank"><img class="statcounter"
src="http://c.statcounter.com/3825293/0/2dd2334a/1/" alt="free html hit
counter" ></a></div></noscript>
<!-- End of StatCounter Code -->
</body>

</html>
