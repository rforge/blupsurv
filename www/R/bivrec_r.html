<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-type" content="text/html; charset=ISO-8859-1" />
<link rel="stylesheet" href="../robodoc.css" type="text/css" />
<title>./blupsurv/R/bivrec.r</title>
<!-- Source: ./blupsurv/R/bivrec.r -->
<!-- Generated with ROBODoc Version 4.99.36 (Jun 19 2008) -->
</head>
<body>
<div id="logo">
<a name="robo_top_of_doc">blupsurv</a>
</div> <!-- logo -->
<div id="navigation">
<a class="menuitem" href="../toc_index.html#top">Table of Contents</a>
<a class="menuitem" href="../robo_sourcefiles.html#top">Sourcefiles</a>
<a class="menuitem" href="../masterindex.html#top">Index</a>
<a class="menuitem" href="../robo_functions.html#top">Functions</a>
<a class="menuitem" href="../robo_modules.html#top">Modules</a>
<a class="menuitem" href="../robo_methods.html#top">Methods</a>
</div> <!-- navigation -->
<div id="content">
<h3>TABLE OF CONTENTS</h3>
<ul>
<li>1. <a href="#robo0">/00main</a></li>
<ul>
<li>1.1. <a href="#robo11">00main/bivrec.agdata</a></li>
</ul>
<li>2. <a href="#robo1">/bivrecFit</a></li>
<ul>
<li>2.1. <a href="#robo6">bivrecFit/estimation</a></li>
<ul>
<li>2.1.1. <a href="#robo12">estimation/fmakealphars2</a></li>
<li>2.1.2. <a href="#robo13">estimation/fupdatefrailties4</a></li>
<li>2.1.3. <a href="#robo14">estimation/getdispmarg3</a></li>
<li>2.1.4. <a href="#robo15">estimation/smoothalpha</a></li>
<li>2.1.5. <a href="#robo16">estimation/updatedispmarg2</a></li>
<li>2.1.6. <a href="#robo17">estimation/updatedispohls</a></li>
<li>2.1.7. <a href="#robo18">estimation/updatedisppears</a></li>
<li>2.1.8. <a href="#robo19">estimation/updateregprof</a></li>
</ul>
<li>2.2. <a href="#robo7">bivrecFit/fortranwrappers</a></li>
<ul>
<li>2.2.1. <a href="#robo32">fortranwrappers/fmakeSens2</a></li>
<li>2.2.2. <a href="#robo33">fortranwrappers/fmkprofgr2</a></li>
<li>2.2.3. <a href="#robo34">fortranwrappers/fmkproflik2</a></li>
<li>2.2.4. <a href="#robo35">fortranwrappers/fmkstderr</a></li>
</ul>
<li>2.3. <a href="#robo8">bivrecFit/initialization</a></li>
<ul>
<li>2.3.1. <a href="#robo36">initialization/makeas</a></li>
<li>2.3.2. <a href="#robo37">initialization/makedatamat</a></li>
</ul>
<li>2.4. <a href="#robo9">bivrecFit/utility</a></li>
<ul>
<li>2.4.1. <a href="#robo67">utility/A</a></li>
<li>2.4.2. <a href="#robo68">utility/ab2g</a></li>
<li>2.4.3. <a href="#robo69">utility/g2ab</a></li>
<li>2.4.4. <a href="#robo70">utility/makeUijframe</a></li>
</ul>
<li>2.5. <a href="#robo10">bivrecFit/ZZdebug</a></li>
<ul>
<li>2.5.1. <a href="#robo71">ZZdebug/fmakemrs</a></li>
<li>2.5.2. <a href="#robo72">ZZdebug/fmkprofgr</a></li>
<li>2.5.3. <a href="#robo73">ZZdebug/fmkproflik</a></li>
<li>2.5.4. <a href="#robo74">ZZdebug/fupdatefrailties3</a></li>
<li>2.5.5. <a href="#robo75">ZZdebug/makealphars2</a></li>
<li>2.5.6. <a href="#robo76">ZZdebug/makemrs</a></li>
<li>2.5.7. <a href="#robo77">ZZdebug/makeSens2</a></li>
<li>2.5.8. <a href="#robo78">ZZdebug/mkprofgr</a></li>
<li>2.5.9. <a href="#robo79">ZZdebug/mkproflik</a></li>
<li>2.5.10. <a href="#robo80">ZZdebug/Smud2</a></li>
<li>2.5.11. <a href="#robo81">ZZdebug/Smuij</a></li>
</ul>
</ul>
</ul>
<hr />
<a name="2f00main"></a>
<a name="robo0"></a><h2>/00main [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>    blupsurv --- package root
</pre>
<p class="item_name">FUNCTION</p>
<p>   The blupsurv package contains 
   tools for fitting proportional hazards models to clustered
   recurrent events data. Nested frailties are modeled by their
   best linear unbiased predictors under an auxiliary Poisson model.
   Univariate and bivariate recurrent events processes are permitted.
</p>

<p>   The most important function is <a href="#robo11">bivrec.agdata</a>, which does most of the
   model fitting. After initializing, fitting consists of iteratively
   calling <a href="#robo13">fupdatefrailties4</a> to update frailty estimates,
   <a href="#robo18">updatedisppears</a> to update dispersion parameter estimtes,
   and <a href="#robo19">updateregprof</a> to update regression parameter estimates. The
   function <a href="#robo35">fmkstderr</a> computes standard errors at the end.
</p>
  
<p>   Modules bivmethods and unimethods contain the R S3 methods for fitting
   bivariate and univariate models respectively.
</p>
 
<p>   The call graph below is rather small and unhelpful. See a larger but 
   equally unhelpful pdf version here:
   <a href="callgraph.pdf">callgraph.pdf</a>
</p>

<p><img src="dot_graph_1.png">
</p>
<p class="item_name">USAGE</p>
<pre>   For usage instructions, see the R package documentation
</pre>
<p class="item_name">AUTHOR</p>
<p>  Emmanuel Sharef
</p>

<hr />
<a name="2fbivrecFit"></a>
<a name="robo1"></a><h2>/bivrecFit [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <a href="./bivmethods_r.html#robo38">bivrec</a> -- Fitter for bivariate recurrent events
</pre>
<p class="item_name">FUNCTION</p>
<p>   The <a href="./bivmethods_r.html#robo38">bivrec</a> module contains the workhorse functions to fit bivariate
   event process models. Since univariate models are just a special
   case, they can be fit by these functions as well.
</p>
   
<p>   The main fitting routine is 
</p>
<pre>       <a href="#robo11">bivrec.agdata</a>
</pre>
<p>   and an overview of the algorithm implementation is given in the
   documentation for that function.
</p>

<hr />
<a name="bivrecFit2festimation"></a>
<a name="robo6"></a><h2>bivrecFit/estimation [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo1">bivrecFit</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>    Estimation functions
</pre>
<p class="item_name">FUNCTION</p>
<p>   Functions used directly as part of the model-fitting procedure
</p>

<hr />
<a name="bivrecFit2ffortranwrappers"></a>
<a name="robo7"></a><h2>bivrecFit/fortranwrappers [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo1">bivrecFit</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>    Wrapper functions
</pre>
<p class="item_name">FUNCTION</p>
<p>   Functions that act purely as FORTRAN wrappers
</p>

<hr />
<a name="bivrecFit2finitialization"></a>
<a name="robo8"></a><h2>bivrecFit/initialization [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo1">bivrecFit</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>    Initialization functions
</pre>
<p class="item_name">FUNCTION</p>
<p>   Functions used to initialize the algorithm
</p>

<hr />
<a name="bivrecFit2futility"></a>
<a name="robo9"></a><h2>bivrecFit/utility [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo1">bivrecFit</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>    Utility functions
</pre>
<p class="item_name">FUNCTION</p>
<p>   Functions used to convert matrices and data formats
</p>

<hr />
<a name="bivrecFit2fZZdebug"></a>
<a name="robo10"></a><h2>bivrecFit/ZZdebug [ Modules ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo1">bivrecFit</a> ] [ <a href="../robo_modules.html#robo_top_of_doc">Modules</a> ]</p>
<p class="item_name">NAME</p>
<pre>    Debugging functions
</pre>
<p class="item_name">FUNCTION</p>
<p>   Functions used only for debugging
</p>

<hr />
<a name="00main2fbivrec2eagdata"></a>
<a name="robo11"></a><h2>00main/bivrec.agdata [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo0">00main</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>bivrec.agdata</strong> --- fitter for bivariate models
</pre>
<p class="item_name">FUNCTION</p>
<p>   The main fitting function. Fits the model, given an Anderson-Gill data set
   and other parameters, iterating between updating frailty, dispersion and
   regression parameters until convergence.  After initializing, fitting
   consists of iteratively calling <a href="#robo13">fupdatefrailties4</a> to update frailty
   estimates, <a href="#robo18">updatedisppears</a> to update dispersion parameter estimtes, and
   <a href="#robo19">updateregprof</a> to update regression parameter estimates. The function
   <a href="#robo35">fmkstderr</a> computes standard errors at the end.
</p>
  
<p>   See also the call graph linked from <a href="#robo0">00main</a>.
</p>
   
<p>   This function should not be called directly, rather, the interface
   provided by the <a href="./bivmethods_r.html#robo40">bivrec.formula</a> and <a href="./unimethods_r.html#robo58">unirec.formula</a> methods should be used.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2386 </span><strong>bivrec.agdata</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>x<span class="sign">,</span> K1 <span class="sign">=</span> 10<span class="sign">,</span> K2 <span class="sign">=</span> 10<span class="sign">,</span> excludevars1 <span class="sign">=</span> NULL<span class="sign">,</span> 
<span class="line_number">2387 </span>        excludevars2 <span class="sign">=</span> NULL<span class="sign">,</span> verbose <span class="sign">=</span> 1<span class="sign">,</span> alternating <span class="sign">=</span> FALSE<span class="sign">,</span>
<span class="line_number">2388 </span>        dispest <span class="sign">=</span> <span class="quote">"pearson"</span><span class="sign">,</span> correction <span class="sign">=</span> <span class="quote">"none"</span><span class="sign">,</span> computesd <span class="sign">=</span> TRUE<span class="sign">,</span>
<span class="line_number">2389 </span>        fullS <span class="sign">=</span> TRUE<span class="sign">,</span> fixzero <span class="sign">=</span> NULL<span class="sign">,</span> smooth <span class="sign">=</span> FALSE<span class="sign">,</span> maxiter <span class="sign">=</span> 200<span class="sign">,</span>
<span class="line_number">2390 </span>        convergence <span class="sign">=</span> 1e<span class="sign">-</span>3<span class="sign">,</span> initial <span class="sign">=</span> NULL<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>       x           a data frame with the following columns:
                   i       cluster index
                   j       subject index
                   k       event counter
                   r       stratum index
                   start   interval start time
                   stop    interval stop time
                   delta   indicator for event 1
                   Delta   indicator for event 2
                   ...     columns of all covariates used in the model
       K1          if &gt; 1, number of discretization breakpoints for event 1
                   if &lt; 1, proportion relative to maximum
                   can be of length &gt; 1 for different strata
       K2          analogous for event 2
       excludevars1    vector of strings giving covariate names that should
                       not be included for process 1
       excludevars2    analogous for process 2
       verbose     integer from 1-5 specifying the amount of output printed
       alternating  boolean indicating whether the data are episodic
       dispest     dispersion parameter estimators to use. Options are
                   "pearson", "marginal" and "ohlsson"
       correction  determines whether to use Ma's correction. Options are
                   "none", "single" or "double"
       computesd   boolean, determines whether to compute standard errors
       fullS       boolean, determines whether to compute the full 
                   sensitivity matrix
       fixzero     list of parameters that should be fixed at 0. For
                   univariate models, this should contain "sigma2dhat",
                   "nu2dhat" and "thetahat"
       smooth      boolean, whether to smooth the baseline hazards
       maxiter     maximum number of iterations permitted before failing
       convergence  convergence criterion, absolute change in all params
       initial     optionally a list containing initial values for
                   betahat, betadhat, Uihat, Vihat, Uijhat, Vijhat and dispparams
</pre>
<p class="item_name">OUTPUTS</p>
<pre>       an object of class <a href="./bivmethods_r.html#robo38">bivrec</a>, see the package documentation for details
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2393 </span><span class="sign">{</span>
<span class="line_number">2394 </span>    <span class="comment"># Read in the input and make basic adjustments</span>
<span class="line_number">2395 </span>    agdata <span class="sign">&lt;</span><span class="sign">-</span> x
<span class="line_number">2396 </span>    K <span class="sign">&lt;</span><span class="sign">-</span> K1<span class="sign">;</span>Kd <span class="sign">&lt;</span><span class="sign">-</span> K2<span class="sign">;</span>
<span class="line_number">2397 </span>    <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>excludevars1<span class="sign">)</span><span class="sign">)</span> vars1 <span class="sign">&lt;</span><span class="sign">-</span> NULL <span class="keyword">else</span> 
<span class="line_number">2398 </span>        vars1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">which</span><span class="sign">(</span><span class="comment">!colnames(x)[ - (1:8)]%in%excludevars1)</span>
<span class="line_number">2399 </span>    <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>excludevars2<span class="sign">)</span><span class="sign">)</span> vars2 <span class="sign">&lt;</span><span class="sign">-</span> NULL <span class="keyword">else</span> 
<span class="line_number">2400 </span>        vars2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">which</span><span class="sign">(</span><span class="comment">!colnames(x)[ - (1:8)]%in%excludevars2)</span>
<span class="line_number">2401 </span>    maxiter<span class="sign">.</span>outer <span class="sign">&lt;</span><span class="sign">-</span> maxiter<span class="sign">;</span> thresh<span class="sign">.</span>outer <span class="sign">&lt;</span><span class="sign">-</span> convergence<span class="sign">;</span>
<span class="line_number">2402 </span>    fixzero <span class="sign">&lt;</span><span class="sign">-</span> fixzero<span class="sign">[</span>fixzero<span class="sign">%</span>in<span class="sign">%</span>c<span class="sign">(</span><span class="quote">"clust1"</span><span class="sign">,</span> <span class="quote">"clust2"</span><span class="sign">,</span> <span class="quote">"subj1"</span><span class="sign">,</span> <span class="quote">"subj2"</span><span class="sign">,</span> <span class="quote">"cov"</span><span class="sign">)</span><span class="sign">]</span>
<span class="line_number">2403 </span>    fixzero<span class="sign">[</span>fixzero <span class="sign">=</span><span class="sign">=</span> <span class="quote">"clust1"</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"sigma2hat"</span>
<span class="line_number">2404 </span>    fixzero<span class="sign">[</span>fixzero <span class="sign">=</span><span class="sign">=</span> <span class="quote">"clust2"</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"sigma2dhat"</span>
<span class="line_number">2405 </span>    fixzero<span class="sign">[</span>fixzero <span class="sign">=</span><span class="sign">=</span> <span class="quote">"subj1"</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"nu2hat"</span>
<span class="line_number">2406 </span>    fixzero<span class="sign">[</span>fixzero <span class="sign">=</span><span class="sign">=</span> <span class="quote">"subj2"</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"nu2dhat"</span>
<span class="line_number">2407 </span>    fixzero<span class="sign">[</span>fixzero <span class="sign">=</span><span class="sign">=</span> <span class="quote">"cov"</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"thetahat"</span>
<span class="line_number">2408 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>fixzero<span class="sign">)</span> <span class="sign">=</span><span class="sign">=</span> 0<span class="sign">)</span> fixzero <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">2409 </span>    
<span class="line_number">2410 </span>    <span class="comment"># Check whether a univariate model is being fit</span>
<span class="line_number">2411 </span>    <span class="keyword">if</span><span class="sign">(</span>all<span class="sign">(</span>c<span class="sign">(</span><span class="quote">"sigma2dhat"</span><span class="sign">,</span> <span class="quote">"nu2dhat"</span><span class="sign">,</span> <span class="quote">"thetahat"</span><span class="sign">)</span><span class="sign">%</span>in<span class="sign">%</span>fixzero<span class="sign">)</span><span class="sign">)</span> 
<span class="line_number">2412 </span>        univariate <span class="sign">&lt;</span><span class="sign">-</span> TRUE <span class="keyword">else</span> univariate <span class="sign">&lt;</span><span class="sign">-</span> FALSE
<span class="line_number">2413 </span>        
<span class="line_number">2414 </span>    <span class="keyword">call</span> <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">.</span><span class="keyword">call</span><span class="sign">(</span><span class="sign">)</span>
<span class="line_number">2415 </span>    <span class="comment"># Get the values of m and Ji from the agdata matrix, and set </span>
<span class="line_number">2416 </span>    <span class="comment"># global variables with those values.</span>
<span class="line_number">2417 </span>    m <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>agdata<span class="sign">$</span>i<span class="sign">)</span>
<span class="line_number">2418 </span>    Jilocal <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span>
<span class="line_number">2419 </span>    <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span>m<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2420 </span>        Jilocal<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>agdata<span class="sign">$</span>j<span class="sign">[</span>agdata<span class="sign">$</span>i <span class="sign">=</span><span class="sign">=</span> i<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2421 </span>    <span class="sign">}</span>
<span class="line_number">2422 </span>    Ji <span class="sign">&lt;</span><span class="sign">-</span> Jilocal
<span class="line_number">2423 </span>    <span class="comment"># If the provided K, Kd are of length 1, then assume all strata should </span>
<span class="line_number">2424 </span>    <span class="comment"># have the same number of breakpoints</span>
<span class="line_number">2425 </span>    nr <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span><span class="keyword">unique</span><span class="sign">(</span>agdata<span class="sign">$</span>r<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2426 </span>     
<span class="line_number">2427 </span>    <span class="comment">###########################</span>
<span class="line_number">2428 </span>    <span class="comment">#### Begin find initial values for frailties and coefficients</span>
<span class="line_number">2429 </span>    
<span class="line_number">2430 </span>    <span class="comment"># Initial values are computed using coxph. </span>
<span class="line_number">2431 </span>    <span class="comment"># For recurrent events, the response time is the interevent time stop - start, </span>
<span class="line_number">2432 </span>    <span class="comment"># and event indicator delta. </span>
<span class="line_number">2433 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 2<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"Get initial values\n"</span><span class="sign">)</span>
<span class="line_number">2434 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>agdata<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">&gt;</span> 9<span class="sign">)</span> <span class="keyword">if</span><span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span>agdata<span class="sign">[</span><span class="sign">,</span> 10<span class="sign">]</span> <span class="comment">!= 0) == 0) agdata &lt;- agdata[, -10]</span>
<span class="line_number">2435 </span>    
<span class="line_number">2436 </span>    <span class="comment"># create separate data frames for each process</span>
<span class="line_number">2437 </span>    agdata1 <span class="sign">&lt;</span><span class="sign">-</span> agdata<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span>8<span class="sign">]</span>
<span class="line_number">2438 </span>    agdata2 <span class="sign">&lt;</span><span class="sign">-</span> agdata<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span>7<span class="sign">]</span><span class="sign">;</span><span class="keyword">colnames</span><span class="sign">(</span>agdata2<span class="sign">)</span><span class="sign">[</span>7<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"delta"</span>
<span class="line_number">2439 </span>    
<span class="line_number">2440 </span>    <span class="comment"># remove duplicate rows in each of the two data frames, and adjust the</span>
<span class="line_number">2441 </span>    <span class="comment"># times accordingly</span>
<span class="line_number">2442 </span>    <span class="keyword">if</span><span class="sign">(</span>alternating<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2443 </span>        atrisk1 <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>TRUE<span class="sign">,</span><span class="comment">!duplicated(agdata[, 1:2])[ - 1]) | </span>
<span class="line_number">2444 </span>                c<span class="sign">(</span>TRUE<span class="sign">,</span> agdata<span class="sign">$</span>Delta<span class="sign">[</span> <span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>agdata<span class="sign">$</span>Delta<span class="sign">)</span><span class="sign">]</span> <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span>
<span class="line_number">2445 </span>        agdata1 <span class="sign">&lt;</span><span class="sign">-</span> agdata<span class="sign">[</span>atrisk1<span class="sign">,</span> <span class="sign">]</span>
<span class="line_number">2446 </span>        agdata2 <span class="sign">&lt;</span><span class="sign">-</span> agdata<span class="sign">[</span><span class="comment">!atrisk1, ]</span>
<span class="line_number">2447 </span>        agdata1 <span class="sign">&lt;</span><span class="sign">-</span> agdata1<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span>8<span class="sign">]</span>
<span class="line_number">2448 </span>        agdata2 <span class="sign">&lt;</span><span class="sign">-</span> agdata2<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span>7<span class="sign">]</span><span class="sign">;</span><span class="keyword">colnames</span><span class="sign">(</span>agdata2<span class="sign">)</span><span class="sign">[</span>7<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"delta"</span>
<span class="line_number">2449 </span>    <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">2450 </span>        <span class="comment"># new method</span>
<span class="line_number">2451 </span>        dup <span class="sign">&lt;</span><span class="sign">-</span> duplicated<span class="sign">(</span>agdata1<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span>c<span class="sign">(</span>3<span class="sign">,</span> 5<span class="sign">,</span> 6<span class="sign">,</span> 7<span class="sign">)</span><span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2452 </span>        dup <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>dup<span class="sign">[</span> <span class="sign">-</span> 1<span class="sign">]</span><span class="sign">,</span> FALSE<span class="sign">)</span> <span class="sign">&amp;</span> agdata1<span class="sign">$</span>delta <span class="comment">!= 1</span>
<span class="line_number">2453 </span>        agdata1 <span class="sign">&lt;</span><span class="sign">-</span> agdata1<span class="sign">[</span><span class="comment">!dup, ]</span>
<span class="line_number">2454 </span>        agdata1<span class="sign">$</span>start<span class="sign">[</span> <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> agdata1<span class="sign">$</span>stop<span class="sign">[</span> <span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>agdata1<span class="sign">$</span>stop<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">2455 </span>        agdata1<span class="sign">$</span>start<span class="sign">[</span><span class="comment">!duplicated(agdata1[, 1:2])] &lt;- 0</span>
<span class="line_number">2456 </span>    
<span class="line_number">2457 </span>        dup <span class="sign">&lt;</span><span class="sign">-</span> duplicated<span class="sign">(</span>agdata2<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span>c<span class="sign">(</span>3<span class="sign">,</span> 5<span class="sign">,</span> 6<span class="sign">,</span> 7<span class="sign">)</span><span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2458 </span>        dup <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>dup<span class="sign">[</span> <span class="sign">-</span> 1<span class="sign">]</span><span class="sign">,</span> FALSE<span class="sign">)</span> <span class="sign">&amp;</span> agdata2<span class="sign">$</span>delta <span class="comment">!= 1</span>
<span class="line_number">2459 </span>        agdata2 <span class="sign">&lt;</span><span class="sign">-</span> agdata2<span class="sign">[</span><span class="comment">!dup, ]</span>
<span class="line_number">2460 </span>        agdata2<span class="sign">$</span>start<span class="sign">[</span> <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> agdata2<span class="sign">$</span>stop<span class="sign">[</span> <span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>agdata2<span class="sign">$</span>stop<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">2461 </span>        agdata2<span class="sign">$</span>start<span class="sign">[</span><span class="comment">!duplicated(agdata2[, 1:2])] &lt;- 0</span>
<span class="line_number">2462 </span>    <span class="sign">}</span>
<span class="line_number">2463 </span>    
<span class="line_number">2464 </span>    <span class="comment"># Remove excluded covariates</span>
<span class="line_number">2465 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="comment">!is.null(vars1)) agdata1 &lt;- agdata1[, c(1:7, 7 + vars1)]</span>
<span class="line_number">2466 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="comment">!is.null(vars2)) agdata2 &lt;- agdata2[, c(1:7, 7 + vars2)]</span>
<span class="line_number">2467 </span>
<span class="line_number">2468 </span>    <span class="comment"># Compute the number of discretization breakpoints, if K or Kd were specified</span>
<span class="line_number">2469 </span>    <span class="comment"># as a proportion of the maximum</span>
<span class="line_number">2470 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>K<span class="sign">)</span> <span class="sign">=</span><span class="sign">=</span> 1 <span class="sign">&amp;</span> K <span class="sign">&lt;</span><span class="sign">=</span> 1<span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">2471 </span>        Kout <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> nr<span class="sign">)</span>
<span class="line_number">2472 </span>        <span class="keyword">for</span><span class="sign">(</span>r in 1<span class="sign">:</span>nr<span class="sign">)</span> Kout<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> round<span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span><span class="keyword">unique</span><span class="sign">(</span><span class="sign">(</span>agdata1<span class="sign">$</span>stop <span class="sign">-</span>
<span class="line_number">2473 </span>            agdata1<span class="sign">$</span>start<span class="sign">)</span><span class="sign">[</span>agdata1<span class="sign">$</span>delta <span class="sign">=</span><span class="sign">=</span> 1 <span class="sign">&amp;</span> agdata1<span class="sign">$</span>r <span class="sign">=</span><span class="sign">=</span> r<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span> <span class="sign">*</span> K<span class="sign">)</span>
<span class="line_number">2474 </span>        K <span class="sign">&lt;</span><span class="sign">-</span> Kout
<span class="line_number">2475 </span>    <span class="sign">}</span>
<span class="line_number">2476 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>Kd<span class="sign">)</span> <span class="sign">=</span><span class="sign">=</span> 1 <span class="sign">&amp;</span> Kd <span class="sign">&lt;</span><span class="sign">=</span> 1<span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">2477 </span>        Kout <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> nr<span class="sign">)</span>
<span class="line_number">2478 </span>        <span class="keyword">for</span><span class="sign">(</span>r in 1<span class="sign">:</span>nr<span class="sign">)</span> Kout<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> round<span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span><span class="keyword">unique</span><span class="sign">(</span><span class="sign">(</span>agdata2<span class="sign">$</span>stop <span class="sign">-</span>
<span class="line_number">2479 </span>            agdata2<span class="sign">$</span>start<span class="sign">)</span><span class="sign">[</span>agdata2<span class="sign">$</span>delta <span class="sign">=</span><span class="sign">=</span> 1 <span class="sign">&amp;</span> agdata2<span class="sign">$</span>r <span class="sign">=</span><span class="sign">=</span> r<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span> <span class="sign">*</span> Kd<span class="sign">)</span>
<span class="line_number">2480 </span>        Kd <span class="sign">&lt;</span><span class="sign">-</span> Kout
<span class="line_number">2481 </span>    <span class="sign">}</span>
<span class="line_number">2482 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>K<span class="sign">)</span> <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span> K <span class="sign">=</span> <span class="keyword">rep</span><span class="sign">(</span>K<span class="sign">,</span> nr<span class="sign">)</span>
<span class="line_number">2483 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>Kd<span class="sign">)</span> <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span> Kd <span class="sign">=</span> <span class="keyword">rep</span><span class="sign">(</span>Kd<span class="sign">,</span> nr<span class="sign">)</span>
<span class="line_number">2484 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>Kd<span class="sign">)</span> <span class="comment">!= nr | length(K) != nr) stop("K needs to be as long as the number of strata")</span>
<span class="line_number">2485 </span>    <span class="keyword">if</span><span class="sign">(</span>univariate<span class="sign">)</span> Kd <span class="sign">&lt;</span><span class="sign">-</span> 1
<span class="line_number">2486 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 1<span class="sign">)</span>  <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"K = "</span><span class="sign">,</span> K<span class="sign">,</span> <span class="quote">"\t Kd = "</span><span class="sign">,</span> Kd<span class="sign">,</span> <span class="quote">"\n"</span><span class="sign">)</span>
<span class="line_number">2487 </span>
<span class="line_number">2488 </span>    <span class="comment"># Covariate names are needed for Cox model fits and for output</span>
<span class="line_number">2489 </span>    covariatenames1 <span class="sign">&lt;</span><span class="sign">-</span> paste<span class="sign">(</span><span class="keyword">colnames</span><span class="sign">(</span>agdata1<span class="sign">)</span><span class="sign">[</span> <span class="sign">-</span> <span class="sign">(</span>1<span class="sign">:</span>7<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> collapse <span class="sign">=</span> <span class="quote">" + "</span><span class="sign">)</span>
<span class="line_number">2490 </span>    covariatenames2 <span class="sign">&lt;</span><span class="sign">-</span> paste<span class="sign">(</span><span class="keyword">colnames</span><span class="sign">(</span>agdata2<span class="sign">)</span><span class="sign">[</span> <span class="sign">-</span> <span class="sign">(</span>1<span class="sign">:</span>7<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> collapse <span class="sign">=</span> <span class="quote">" + "</span><span class="sign">)</span>
<span class="line_number">2491 </span>
<span class="line_number">2492 </span>    <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>initial<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2493 </span>
<span class="line_number">2494 </span>        <span class="comment"># gamma frailties</span>
<span class="line_number">2495 </span>        ftype <span class="sign">&lt;</span><span class="sign">-</span> <span class="quote">"gamma"</span>
<span class="line_number">2496 </span>        
<span class="line_number">2497 </span>        <span class="comment"># Models need to be fit with both subject - level frailties, and </span>
<span class="line_number">2498 </span>        <span class="comment"># cluster - level frailties, resulting in the four models fit below.</span>
<span class="line_number">2499 </span>        <span class="comment"># Compute Cox fits with cluster frailties</span>
<span class="line_number">2500 </span>        <span class="keyword">if</span><span class="sign">(</span>m <span class="sign">&gt;</span> 1<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2501 </span>            cox<span class="sign">.</span>clust1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span>coxph<span class="sign">(</span>as<span class="sign">.</span>formula<span class="sign">(</span>paste<span class="sign">(</span><span class="quote">"Surv(stop - start, delta) ~"</span><span class="sign">,</span>
<span class="line_number">2502 </span>                covariatenames1<span class="sign">,</span> <span class="quote">"+ frailty(i, distribution='"</span><span class="sign">,</span> ftype<span class="sign">,</span> <span class="quote">"')"</span><span class="sign">,</span>
<span class="line_number">2503 </span>                sep <span class="sign">=</span> <span class="quote">""</span><span class="sign">)</span><span class="sign">)</span><span class="sign">,</span> agdata1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2504 </span>            <span class="keyword">if</span><span class="sign">(</span><span class="comment">!univariate)</span>
<span class="line_number">2505 </span>                cox<span class="sign">.</span>clust2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span>coxph<span class="sign">(</span>as<span class="sign">.</span>formula<span class="sign">(</span>paste<span class="sign">(</span><span class="quote">"Surv(stop - start, delta) ~"</span><span class="sign">,</span>
<span class="line_number">2506 </span>                    covariatenames2<span class="sign">,</span> <span class="quote">"+ frailty(i, distribution='"</span><span class="sign">,</span> ftype<span class="sign">,</span> <span class="quote">"')"</span><span class="sign">,</span>
<span class="line_number">2507 </span>                    sep <span class="sign">=</span> <span class="quote">""</span><span class="sign">)</span><span class="sign">)</span><span class="sign">,</span> agdata2<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2508 </span>            <span class="keyword">else</span>
<span class="line_number">2509 </span>                cox<span class="sign">.</span>clust2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">list</span><span class="sign">(</span>frail <span class="sign">=</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span><span class="sign">,</span> fvar <span class="sign">=</span> 0<span class="sign">)</span>
<span class="line_number">2510 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">2511 </span>            cox<span class="sign">.</span>clust1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">list</span><span class="sign">(</span>frail <span class="sign">=</span> 0<span class="sign">,</span> fvar <span class="sign">=</span> 0<span class="sign">)</span>
<span class="line_number">2512 </span>            cox<span class="sign">.</span>clust2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">list</span><span class="sign">(</span>frail <span class="sign">=</span> 0<span class="sign">,</span> fvar <span class="sign">=</span> 0<span class="sign">)</span>
<span class="line_number">2513 </span>        <span class="sign">}</span>
<span class="line_number">2514 </span>        <span class="comment"># Compute Cox fits with subject - level frailties</span>
<span class="line_number">2515 </span>        cox<span class="sign">.</span>ind1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span>coxph<span class="sign">(</span>as<span class="sign">.</span>formula<span class="sign">(</span>paste<span class="sign">(</span><span class="quote">"Surv(stop - start, delta) ~"</span><span class="sign">,</span>
<span class="line_number">2516 </span>            covariatenames1<span class="sign">,</span> <span class="quote">"+ frailty(i * 1000 + j, distribution='"</span><span class="sign">,</span> ftype<span class="sign">,</span> <span class="quote">"')"</span><span class="sign">,</span>
<span class="line_number">2517 </span>            sep <span class="sign">=</span> <span class="quote">""</span><span class="sign">)</span><span class="sign">)</span><span class="sign">,</span> agdata1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2518 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="comment">!univariate)</span>
<span class="line_number">2519 </span>            cox<span class="sign">.</span>ind2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span>coxph<span class="sign">(</span>as<span class="sign">.</span>formula<span class="sign">(</span>paste<span class="sign">(</span><span class="quote">"Surv(stop - start, delta) ~"</span><span class="sign">,</span>
<span class="line_number">2520 </span>                covariatenames2<span class="sign">,</span> <span class="quote">"+ frailty(i * 1000 + j, distribution='"</span><span class="sign">,</span> ftype<span class="sign">,</span> <span class="quote">"')"</span><span class="sign">,</span>
<span class="line_number">2521 </span>                sep <span class="sign">=</span> <span class="quote">""</span><span class="sign">)</span><span class="sign">)</span><span class="sign">,</span> agdata2<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2522 </span>        <span class="keyword">else</span>
<span class="line_number">2523 </span>            cox<span class="sign">.</span>ind2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">list</span><span class="sign">(</span>frail <span class="sign">=</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span> fvar <span class="sign">=</span> 0<span class="sign">,</span>
<span class="line_number">2524 </span>                coef <span class="sign">=</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>agdata2<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 7<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2525 </span>
<span class="line_number">2526 </span>        <span class="keyword">if</span><span class="sign">(</span>inherits<span class="sign">(</span>cox<span class="sign">.</span>clust1<span class="sign">,</span> <span class="quote">"try - error"</span><span class="sign">)</span> <span class="sign">|</span> inherits<span class="sign">(</span>cox<span class="sign">.</span>clust2<span class="sign">,</span> <span class="quote">"try - error"</span><span class="sign">)</span> <span class="sign">|</span>
<span class="line_number">2527 </span>            inherits<span class="sign">(</span>cox<span class="sign">.</span>ind1<span class="sign">,</span> <span class="quote">"try - error"</span><span class="sign">)</span> <span class="sign">|</span> inherits<span class="sign">(</span>cox<span class="sign">.</span>ind2<span class="sign">,</span> <span class="quote">"try - error"</span><span class="sign">)</span> <span class="sign">)</span>  
<span class="line_number">2528 </span>            browser<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">2529 </span>       
<span class="line_number">2530 </span>        <span class="comment">## Set initial values for frailties based on estimated values</span>
<span class="line_number">2531 </span>        Uihat <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>cox<span class="sign">.</span>clust1<span class="sign">$</span>frail<span class="sign">)</span>
<span class="line_number">2532 </span>        Vihat <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>cox<span class="sign">.</span>clust2<span class="sign">$</span>frail<span class="sign">)</span>
<span class="line_number">2533 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="comment">!alternating){</span>
<span class="line_number">2534 </span>            Uijhat <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>cox<span class="sign">.</span>ind1<span class="sign">$</span>frail<span class="sign">)</span>
<span class="line_number">2535 </span>            Vijhat <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>cox<span class="sign">.</span>ind2<span class="sign">$</span>frail<span class="sign">)</span>
<span class="line_number">2536 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">2537 </span>            Uijhat <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>cox<span class="sign">.</span>ind1<span class="sign">$</span>frail<span class="sign">)</span>
<span class="line_number">2538 </span>            Vijhat <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>1<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>Uijhat<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2539 </span>            Vijhat<span class="sign">[</span><span class="keyword">unique</span><span class="sign">(</span>agdata1<span class="sign">$</span>i <span class="sign">*</span> 1000 <span class="sign">+</span> agdata1<span class="sign">$</span>j<span class="sign">)</span><span class="sign">%</span>in<span class="sign">%</span><span class="keyword">unique</span><span class="sign">(</span>agdata2<span class="sign">$</span>i <span class="sign">*</span> 1000 <span class="sign">+</span>
<span class="line_number">2540 </span>                agdata2<span class="sign">$</span>j<span class="sign">)</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>cox<span class="sign">.</span>ind2<span class="sign">$</span>frail<span class="sign">)</span>
<span class="line_number">2541 </span>        <span class="sign">}</span>
<span class="line_number">2542 </span>        
<span class="line_number">2543 </span>        <span class="comment">## Set initial values for dispersion parameters</span>
<span class="line_number">2544 </span>        sigma2hat <span class="sign">&lt;</span><span class="sign">-</span> mean<span class="sign">(</span>cox<span class="sign">.</span>clust1<span class="sign">$</span>fvar<span class="sign">)</span>
<span class="line_number">2545 </span>        sigma2dhat <span class="sign">&lt;</span><span class="sign">-</span> mean<span class="sign">(</span>cox<span class="sign">.</span>clust2<span class="sign">$</span>fvar<span class="sign">)</span>
<span class="line_number">2546 </span>        nu2hat <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>mean<span class="sign">(</span>cox<span class="sign">.</span>ind1<span class="sign">$</span>fvar<span class="sign">)</span> <span class="sign">-</span> sigma2hat<span class="sign">,</span> <span class="sign">.</span>1<span class="sign">)</span>
<span class="line_number">2547 </span>        nu2dhat <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>mean<span class="sign">(</span>cox<span class="sign">.</span>ind2<span class="sign">$</span>fvar<span class="sign">)</span> <span class="sign">-</span> sigma2hat<span class="sign">,</span> <span class="sign">.</span>1<span class="sign">)</span>
<span class="line_number">2548 </span>        thetahat <span class="sign">&lt;</span><span class="sign">-</span> cov<span class="sign">(</span>Uijhat<span class="sign">,</span> Vijhat<span class="sign">)</span>
<span class="line_number">2549 </span>        
<span class="line_number">2550 </span>        <span class="comment">## Check that dispersion parameters are valid</span>
<span class="line_number">2551 </span>        <span class="keyword">if</span><span class="sign">(</span>abs<span class="sign">(</span>thetahat<span class="sign">)</span><span class="sign">&lt;</span><span class="sign">.</span>001<span class="sign">)</span> thetahat <span class="sign">&lt;</span><span class="sign">-</span> sign<span class="sign">(</span>thetahat<span class="sign">)</span><span class="sign">*</span><span class="sign">.</span>01
<span class="line_number">2552 </span>        <span class="keyword">if</span><span class="sign">(</span>abs<span class="sign">(</span>sigma2hat<span class="sign">)</span><span class="sign">&lt;</span><span class="sign">.</span>001<span class="sign">)</span> sigma2hat <span class="sign">&lt;</span><span class="sign">-</span> sign<span class="sign">(</span>sigma2hat<span class="sign">)</span><span class="sign">*</span><span class="sign">.</span>01
<span class="line_number">2553 </span>        <span class="keyword">if</span><span class="sign">(</span>abs<span class="sign">(</span>sigma2dhat<span class="sign">)</span><span class="sign">&lt;</span><span class="sign">.</span>001<span class="sign">)</span> sigma2dhat <span class="sign">&lt;</span><span class="sign">-</span> sign<span class="sign">(</span>sigma2dhat<span class="sign">)</span><span class="sign">*</span><span class="sign">.</span>01
<span class="line_number">2554 </span>        <span class="keyword">if</span><span class="sign">(</span>abs<span class="sign">(</span>nu2hat<span class="sign">)</span><span class="sign">&lt;</span><span class="sign">.</span>001<span class="sign">)</span> nu2hat <span class="sign">&lt;</span><span class="sign">-</span> sign<span class="sign">(</span>nu2hat<span class="sign">)</span><span class="sign">*</span><span class="sign">.</span>01
<span class="line_number">2555 </span>        <span class="keyword">if</span><span class="sign">(</span>abs<span class="sign">(</span>nu2dhat<span class="sign">)</span><span class="sign">&lt;</span><span class="sign">.</span>001<span class="sign">)</span> nu2dhat <span class="sign">&lt;</span><span class="sign">-</span> sign<span class="sign">(</span>nu2dhat<span class="sign">)</span><span class="sign">*</span><span class="sign">.</span>01
<span class="line_number">2556 </span>        
<span class="line_number">2557 </span>        <span class="comment">## Extract initial regression parameters</span>
<span class="line_number">2558 </span>        betahat <span class="sign">&lt;</span><span class="sign">-</span> cox<span class="sign">.</span>ind1<span class="sign">$</span>coef
<span class="line_number">2559 </span>        betadhat <span class="sign">&lt;</span><span class="sign">-</span> cox<span class="sign">.</span>ind2<span class="sign">$</span>coef
<span class="line_number">2560 </span>        
<span class="line_number">2561 </span>        <span class="comment"># Save initial dispersion parameters</span>
<span class="line_number">2562 </span>        dispparams <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">list</span><span class="sign">(</span>sigma2hat <span class="sign">=</span> sigma2hat<span class="sign">,</span> sigma2dhat <span class="sign">=</span> sigma2dhat<span class="sign">,</span>
<span class="line_number">2563 </span>                nu2hat <span class="sign">=</span> nu2hat<span class="sign">,</span> nu2dhat <span class="sign">=</span> nu2dhat<span class="sign">,</span> thetahat <span class="sign">=</span> thetahat<span class="sign">)</span>
<span class="line_number">2564 </span>        
<span class="line_number">2565 </span>        <span class="comment"># Fix something at zero if desired</span>
<span class="line_number">2566 </span>        dispparams<span class="sign">[</span>fixzero<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">2567 </span>            
<span class="line_number">2568 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span>is<span class="sign">.</span>na<span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">)</span> <span class="sign">+</span> <span class="keyword">sum</span><span class="sign">(</span>is<span class="sign">.</span>na<span class="sign">(</span>betadhat<span class="sign">)</span><span class="sign">)</span> <span class="sign">&gt;</span> 0<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2569 </span>            warning<span class="sign">(</span><span class="quote">"Unable to find good starting values"</span><span class="sign">)</span>
<span class="line_number">2570 </span>            <span class="keyword">return</span><span class="sign">(</span>0<span class="sign">)</span>    
<span class="line_number">2571 </span>        <span class="sign">}</span>
<span class="line_number">2572 </span>        
<span class="line_number">2573 </span>        <span class="comment">## Save all initial values for output</span>
<span class="line_number">2574 </span>        initial <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">list</span><span class="sign">(</span>betahat <span class="sign">=</span> betahat<span class="sign">,</span> betadhat <span class="sign">=</span> betadhat<span class="sign">,</span> 
<span class="line_number">2575 </span>                        dispparams <span class="sign">=</span> dispparams<span class="sign">)</span> 
<span class="line_number">2576 </span>        <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 1<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\t betahat ="</span><span class="sign">,</span> betahat<span class="sign">,</span> <span class="quote">", betadhat = "</span><span class="sign">,</span> 
<span class="line_number">2577 </span>                            betadhat<span class="sign">,</span> <span class="quote">"\n"</span><span class="sign">)</span>
<span class="line_number">2578 </span>        <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 1<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\t dispparams = "</span><span class="sign">,</span> dispparams<span class="sign">$</span>sigma2hat<span class="sign">,</span>
<span class="line_number">2579 </span>            dispparams<span class="sign">$</span>sigma2dhat<span class="sign">,</span> dispparams<span class="sign">$</span>nu2hat<span class="sign">,</span> dispparams<span class="sign">$</span>nu2dhat<span class="sign">,</span>
<span class="line_number">2580 </span>            dispparams<span class="sign">$</span>thetahat<span class="sign">,</span> <span class="quote">"\n"</span><span class="sign">)</span>
<span class="line_number">2581 </span>
<span class="line_number">2582 </span>    <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>  <span class="comment"># if initial values are provided, use those</span>
<span class="line_number">2583 </span>        dispparams <span class="sign">&lt;</span><span class="sign">-</span> initial<span class="sign">$</span>dispparams
<span class="line_number">2584 </span>        Uihat <span class="sign">&lt;</span><span class="sign">-</span> initial<span class="sign">$</span>Uihat
<span class="line_number">2585 </span>        Uijhat <span class="sign">&lt;</span><span class="sign">-</span> initial<span class="sign">$</span>Uijhat
<span class="line_number">2586 </span>        Vihat <span class="sign">&lt;</span><span class="sign">-</span> initial<span class="sign">$</span>Vihat
<span class="line_number">2587 </span>        Vijhat <span class="sign">&lt;</span><span class="sign">-</span> initial<span class="sign">$</span>Vijhat
<span class="line_number">2588 </span>        betahat <span class="sign">&lt;</span><span class="sign">-</span> initial<span class="sign">$</span>betahat
<span class="line_number">2589 </span>        betadhat <span class="sign">&lt;</span><span class="sign">-</span> initial<span class="sign">$</span>betadhat
<span class="line_number">2590 </span>    <span class="sign">}</span>
<span class="line_number">2591 </span>
<span class="line_number">2592 </span>    <span class="comment">##########################</span>
<span class="line_number">2593 </span>    <span class="comment">### Convert Anderson - Gill data into matrix form and initialize matrices    </span>
<span class="line_number">2594 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 2<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"Initialize matrices for <a href="#robo6">estimation</a>\n"</span><span class="sign">)</span>
<span class="line_number">2595 </span>    
<span class="line_number">2596 </span>    <span class="comment">## Compute breakpoints</span>
<span class="line_number">2597 </span>    as <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo36">makeas</a><span class="sign">(</span>agdata1<span class="sign">,</span> K<span class="sign">,</span> alternating<span class="sign">)</span>
<span class="line_number">2598 </span>    asd <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo36">makeas</a><span class="sign">(</span>agdata2<span class="sign">,</span> Kd<span class="sign">,</span> alternating<span class="sign">)</span>
<span class="line_number">2599 </span>    
<span class="line_number">2600 </span>    <span class="comment">## Write frailty estimates in the form of a matrix</span>
<span class="line_number">2601 </span>    Uijhatframe <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo70">makeUijframe</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> Uijhat<span class="sign">,</span> Vijhat<span class="sign">)</span>
<span class="line_number">2602 </span>        
<span class="line_number">2603 </span>    <span class="comment">## Create data matrix</span>
<span class="line_number">2604 </span>    datamat <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo37">makedatamat</a><span class="sign">(</span>agdata1<span class="sign">,</span> as<span class="sign">,</span> alternating<span class="sign">)</span>
<span class="line_number">2605 </span>    datamatd <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo37">makedatamat</a><span class="sign">(</span>agdata2<span class="sign">,</span> asd<span class="sign">,</span> alternating<span class="sign">)</span>
<span class="line_number">2606 </span>        
<span class="line_number">2607 </span>    <span class="comment">## Compute initial estimates of baseline hazard parameters    </span>
<span class="line_number">2608 </span>    alphars <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo12">fmakealphars2</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> betahat<span class="sign">,</span> as<span class="sign">,</span> Uijhatframe<span class="sign">$</span>Uijmat<span class="sign">,</span> smooth<span class="sign">)</span>
<span class="line_number">2609 </span>    alpharsd <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo12">fmakealphars2</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamatd<span class="sign">,</span> betadhat<span class="sign">,</span> asd<span class="sign">,</span> 
<span class="line_number">2610 </span>                                            Uijhatframe<span class="sign">$</span>Vijmat<span class="sign">,</span> smooth<span class="sign">)</span>
<span class="line_number">2611 </span>    
<span class="line_number">2612 </span>    <span class="comment">## Cleanup: Remove Anderson - Gill data</span>
<span class="line_number">2613 </span>    varnames1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">colnames</span><span class="sign">(</span>agdata1<span class="sign">)</span><span class="sign">[</span> <span class="sign">-</span> <span class="sign">(</span>1<span class="sign">:</span>7<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">2614 </span>    varnames2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">colnames</span><span class="sign">(</span>agdata2<span class="sign">)</span><span class="sign">[</span> <span class="sign">-</span> <span class="sign">(</span>1<span class="sign">:</span>7<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">2615 </span>    rm<span class="sign">(</span>agdata<span class="sign">)</span>
<span class="line_number">2616 </span>     
<span class="line_number">2617 </span>    <span class="comment">##########################</span>
<span class="line_number">2618 </span>    <span class="comment">### Begin iterative <a href="#robo6">estimation</a> procedure</span>
<span class="line_number">2619 </span>    
<span class="line_number">2620 </span>    <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 2<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"Iterative <a href="#robo6">estimation</a> procedure\n"</span><span class="sign">)</span>
<span class="line_number">2621 </span>    
<span class="line_number">2622 </span>    <span class="comment">## Initialize convergence criterion</span>
<span class="line_number">2623 </span>    convergence <span class="sign">&lt;</span><span class="sign">-</span> 1000
<span class="line_number">2624 </span>    iter <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">2625 </span>    
<span class="line_number">2626 </span>    <span class="comment"># Compute ad - hoc correction value</span>
<span class="line_number">2627 </span>    <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>character<span class="sign">(</span>correction<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2628 </span>        <span class="keyword">if</span><span class="sign">(</span>correction <span class="sign">=</span><span class="sign">=</span> <span class="quote">"none"</span><span class="sign">)</span> corrval <span class="sign">&lt;</span><span class="sign">-</span> 1
<span class="line_number">2629 </span>        <span class="keyword">if</span><span class="sign">(</span>correction <span class="sign">=</span><span class="sign">=</span> <span class="quote">"single"</span><span class="sign">)</span> corrval <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>1<span class="sign">,</span> m <span class="sign">/</span> <span class="sign">(</span>m <span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>varnames1<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2630 </span>        <span class="keyword">if</span><span class="sign">(</span>correction <span class="sign">=</span><span class="sign">=</span> <span class="quote">"double"</span><span class="sign">)</span> corrval <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>1<span class="sign">,</span> m <span class="sign">/</span> <span class="sign">(</span>m <span class="sign">-</span> 2 <span class="sign">*</span> <span class="keyword">length</span><span class="sign">(</span>varnames1<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2631 </span>    <span class="sign">}</span> <span class="keyword">else</span> corrval <span class="sign">&lt;</span><span class="sign">-</span> correction    
<span class="line_number">2632 </span>    
<span class="line_number">2633 </span>    <span class="comment">## Loop until convergence</span>
<span class="line_number">2634 </span>    <span class="keyword">while</span><span class="sign">(</span><span class="sign">(</span>convergence <span class="sign">&gt;</span> thresh<span class="sign">.</span>outer<span class="sign">)</span> <span class="sign">&amp;</span> <span class="sign">(</span>iter <span class="sign">&lt;</span><span class="sign">=</span> maxiter<span class="sign">.</span>outer<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2635 </span>        
<span class="line_number">2636 </span>        <span class="comment"># Starting convergence criterion and iteration counter</span>
<span class="line_number">2637 </span>        conv<span class="sign">.</span>inner <span class="sign">&lt;</span><span class="sign">-</span> 1000
<span class="line_number">2638 </span>        iter<span class="sign">.</span>inner <span class="sign">&lt;</span><span class="sign">-</span> 0          
<span class="line_number">2639 </span>    
<span class="line_number">2640 </span>        <span class="comment">######## Step 1: Update Frailty estimates</span>
<span class="line_number">2641 </span>        <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 2<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\tUpdating frailty estimates\n"</span><span class="sign">)</span>
<span class="line_number">2642 </span>        frailtyoutput <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo13">fupdatefrailties4</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> datamatd<span class="sign">,</span>
<span class="line_number">2643 </span>                alphars<span class="sign">,</span> alpharsd<span class="sign">,</span> as<span class="sign">,</span> asd<span class="sign">,</span> betahat<span class="sign">,</span> betadhat<span class="sign">,</span> dispparams<span class="sign">)</span>
<span class="line_number">2644 </span>
<span class="line_number">2645 </span>         <span class="comment">######## Step 2: Update Dispersion coefficient estimates</span>
<span class="line_number">2646 </span>        <span class="keyword">if</span><span class="sign">(</span>dispest <span class="sign">=</span><span class="sign">=</span> <span class="quote">"ohlsson"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2647 </span>            <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 2<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\tUpdating dispersion parameters (Ohlsson)\n"</span><span class="sign">)</span>
<span class="line_number">2648 </span>            <span class="comment"># Use Ohlsson estimators</span>
<span class="line_number">2649 </span>            dispersionoutput <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo17">updatedispohls</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> datamatd<span class="sign">,</span>
<span class="line_number">2650 </span>                    alphars<span class="sign">,</span> alpharsd<span class="sign">,</span> as<span class="sign">,</span> asd<span class="sign">,</span> betahat<span class="sign">,</span> betadhat<span class="sign">,</span> fixzero<span class="sign">)</span>
<span class="line_number">2651 </span>            <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>names<span class="sign">(</span>dispersionoutput<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span><span class="sign">{</span><span class="keyword">return</span><span class="sign">(</span>0<span class="sign">)</span><span class="sign">}</span> 
<span class="line_number">2652 </span>        <span class="sign">}</span>
<span class="line_number">2653 </span>        <span class="keyword">if</span><span class="sign">(</span>dispest <span class="sign">=</span><span class="sign">=</span> <span class="quote">"pearson"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2654 </span>            <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 2<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\tUpdating dispersion parameters (Pearson)\n"</span><span class="sign">)</span>
<span class="line_number">2655 </span>            <span class="comment"># Use Pearson <a href="#robo6">estimation</a> code</span>
<span class="line_number">2656 </span>            dispersionoutput <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo18">updatedisppears</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> frailtyoutput<span class="sign">,</span> 
<span class="line_number">2657 </span>                    dispparams<span class="sign">,</span> corrval<span class="sign">)</span>
<span class="line_number">2658 </span>            dispersionoutput<span class="sign">[</span>fixzero<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">2659 </span>        <span class="sign">}</span>
<span class="line_number">2660 </span>        <span class="keyword">if</span><span class="sign">(</span>dispest <span class="sign">=</span><span class="sign">=</span> <span class="quote">"marginal"</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2661 </span>            <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 2<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\tUpdating dispersion parameters (Marginal)\n"</span><span class="sign">)</span>
<span class="line_number">2662 </span>            <span class="comment"># Use marginal <a href="#robo6">estimation</a> code</span>
<span class="line_number">2663 </span>            dispersionoutput <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo16">updatedispmarg2</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> datamatd<span class="sign">,</span>
<span class="line_number">2664 </span>                alphars<span class="sign">,</span> alpharsd<span class="sign">,</span> as<span class="sign">,</span> asd<span class="sign">,</span> betahat<span class="sign">,</span> betadhat<span class="sign">,</span> fixzero<span class="sign">,</span> univariate<span class="sign">)</span>
<span class="line_number">2665 </span>        <span class="sign">}</span>
<span class="line_number">2666 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>dispest<span class="sign">)</span> <span class="sign">=</span><span class="sign">=</span> 5<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2667 </span>            <span class="comment"># it's possible to compute some parameters via Pearson and others by</span>
<span class="line_number">2668 </span>            <span class="comment"># marginal estimators. This was for testing only, there's no reason</span>
<span class="line_number">2669 </span>            <span class="comment"># to ever do this!</span>
<span class="line_number">2670 </span>            dispersionoutput<span class="sign">.</span>marg <span class="sign">&lt;</span><span class="sign">-</span> unlist<span class="sign">(</span><a href="#robo16">updatedispmarg2</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> datamatd<span class="sign">,</span>
<span class="line_number">2671 </span>                alphars<span class="sign">,</span> alpharsd<span class="sign">,</span> as<span class="sign">,</span> asd<span class="sign">,</span> betahat<span class="sign">,</span> betadhat<span class="sign">,</span> fixzero<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2672 </span>            dispersionoutput<span class="sign">.</span>pears <span class="sign">&lt;</span><span class="sign">-</span> unlist<span class="sign">(</span><a href="#robo18">updatedisppears</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> frailtyoutput<span class="sign">,</span>
<span class="line_number">2673 </span>                dispparams<span class="sign">,</span> corrval<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2674 </span>            dispersionoutput <span class="sign">&lt;</span><span class="sign">-</span> dispersionoutput<span class="sign">.</span>marg
<span class="line_number">2675 </span>            dispersionoutput<span class="sign">[</span>dispest <span class="sign">=</span><span class="sign">=</span> <span class="quote">"p"</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> dispersionoutput<span class="sign">.</span>pears<span class="sign">[</span>dispest <span class="sign">=</span><span class="sign">=</span> <span class="quote">"p"</span><span class="sign">]</span>
<span class="line_number">2676 </span>            dispersionoutput <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">list</span><span class="sign">(</span>dispersionoutput<span class="sign">)</span>
<span class="line_number">2677 </span>        <span class="sign">}</span>
<span class="line_number">2678 </span>        
<span class="line_number">2679 </span>        iter<span class="sign">.</span>inner <span class="sign">&lt;</span><span class="sign">-</span> iter<span class="sign">.</span>inner <span class="sign">+</span> 1
<span class="line_number">2680 </span>             
<span class="line_number">2681 </span>        <span class="comment">######## Step 3: Update Regression parameter estimates</span>
<span class="line_number">2682 </span>            <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 2<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\tUpdating regression parameter estimates ...\n"</span><span class="sign">)</span>
<span class="line_number">2683 </span>        regressionoutput <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo19">updateregprof</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> datamatd<span class="sign">,</span>
<span class="line_number">2684 </span>                alphars<span class="sign">,</span> alpharsd<span class="sign">,</span> as<span class="sign">,</span> asd<span class="sign">,</span> betahat<span class="sign">,</span> betadhat<span class="sign">,</span> K<span class="sign">,</span> Kd<span class="sign">,</span>
<span class="line_number">2685 </span>                frailtyoutput<span class="sign">,</span> dispersionoutput<span class="sign">,</span> smooth<span class="sign">)</span>
<span class="line_number">2686 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>null<span class="sign">(</span>names<span class="sign">(</span>regressionoutput<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2687 </span>            <span class="keyword">return</span><span class="sign">(</span>0<span class="sign">)</span>
<span class="line_number">2688 </span>        <span class="sign">}</span> 
<span class="line_number">2689 </span>        alpharsnew <span class="sign">&lt;</span><span class="sign">-</span> regressionoutput<span class="sign">$</span>alphars<span class="sign">;</span>
<span class="line_number">2690 </span>        alpharsdnew <span class="sign">&lt;</span><span class="sign">-</span> regressionoutput<span class="sign">$</span>alpharsd<span class="sign">;</span>
<span class="line_number">2691 </span>        betahatnew <span class="sign">&lt;</span><span class="sign">-</span> regressionoutput<span class="sign">$</span>betahat<span class="sign">;</span>
<span class="line_number">2692 </span>        betadhatnew <span class="sign">&lt;</span><span class="sign">-</span> regressionoutput<span class="sign">$</span>betadhat<span class="sign">;</span>
<span class="line_number">2693 </span>
<span class="line_number">2694 </span>        <span class="comment"># Compute new value of convergence criterion</span>
<span class="line_number">2695 </span>        newconvergence <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>abs<span class="sign">(</span>betahatnew <span class="sign">-</span> betahat<span class="sign">)</span><span class="sign">)</span> <span class="sign">+</span>
<span class="line_number">2696 </span>                          <span class="keyword">sum</span><span class="sign">(</span>abs<span class="sign">(</span>betadhatnew <span class="sign">-</span> betadhat<span class="sign">)</span><span class="sign">)</span> <span class="sign">+</span>
<span class="line_number">2697 </span>                          abs<span class="sign">(</span>dispparams<span class="sign">$</span>sigma2hat <span class="sign">-</span> dispersionoutput<span class="sign">$</span>sigma2hat<span class="sign">)</span> <span class="sign">+</span>
<span class="line_number">2698 </span>                          abs<span class="sign">(</span>dispparams<span class="sign">$</span>sigma2dhat <span class="sign">-</span> dispersionoutput<span class="sign">$</span>sigma2dhat<span class="sign">)</span> <span class="sign">+</span>
<span class="line_number">2699 </span>                          abs<span class="sign">(</span>dispparams<span class="sign">$</span>nu2hat <span class="sign">-</span> dispersionoutput<span class="sign">$</span>nu2hat<span class="sign">)</span> <span class="sign">+</span>
<span class="line_number">2700 </span>                          abs<span class="sign">(</span>dispparams<span class="sign">$</span>nu2dhat <span class="sign">-</span> dispersionoutput<span class="sign">$</span>nu2dhat<span class="sign">)</span> <span class="sign">+</span>
<span class="line_number">2701 </span>                          abs<span class="sign">(</span>dispparams<span class="sign">$</span>thetahat <span class="sign">-</span> dispersionoutput<span class="sign">$</span>thetahat<span class="sign">)</span>
<span class="line_number">2702 </span>        <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 1<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\tConvergence criterion: "</span><span class="sign">,</span> newconvergence<span class="sign">,</span> <span class="quote">"\n"</span><span class="sign">)</span>
<span class="line_number">2703 </span>
<span class="line_number">2704 </span>        <span class="comment"># DEBUG: Output state at this iteration</span>
<span class="line_number">2705 </span>        <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 2<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\t betahat ="</span><span class="sign">,</span> betahatnew<span class="sign">,</span> <span class="quote">", betadhat = "</span><span class="sign">,</span>
<span class="line_number">2706 </span>                             betadhatnew<span class="sign">,</span> <span class="quote">"\n"</span><span class="sign">)</span>
<span class="line_number">2707 </span>        <span class="keyword">if</span><span class="sign">(</span>verbose <span class="sign">&gt;</span><span class="sign">=</span> 2<span class="sign">)</span> <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"\t dispparams = "</span><span class="sign">,</span> format<span class="sign">(</span>unlist<span class="sign">(</span>dispersionoutput<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2708 </span>                             digits <span class="sign">=</span> 4<span class="sign">)</span><span class="sign">,</span> <span class="quote">"\n"</span><span class="sign">)</span>
<span class="line_number">2709 </span>        
<span class="line_number">2710 </span>        <span class="keyword">if</span><span class="sign">(</span>is<span class="sign">.</span>nan<span class="sign">(</span>newconvergence<span class="sign">)</span> <span class="sign">|</span> iter <span class="sign">=</span><span class="sign">=</span> maxiter<span class="sign">.</span>outer <span class="sign">|</span>
<span class="line_number">2711 </span>                        <span class="sign">(</span>newconvergence <span class="sign">-</span> convergence<span class="sign">)</span> <span class="sign">&gt;</span> 10<span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">2712 </span>            warning<span class="sign">(</span><span class="quote">"Outer loop did not converge"</span><span class="sign">)</span>
<span class="line_number">2713 </span>            <span class="keyword">return</span><span class="sign">(</span>0<span class="sign">)</span>
<span class="line_number">2714 </span>        <span class="sign">}</span>
<span class="line_number">2715 </span>        
<span class="line_number">2716 </span>        <span class="comment"># Replace parameter values with new parameters</span>
<span class="line_number">2717 </span>        alphars <span class="sign">&lt;</span><span class="sign">-</span> alpharsnew
<span class="line_number">2718 </span>        alpharsd <span class="sign">&lt;</span><span class="sign">-</span> alpharsdnew
<span class="line_number">2719 </span>        betahat <span class="sign">&lt;</span><span class="sign">-</span> betahatnew
<span class="line_number">2720 </span>        betadhat <span class="sign">&lt;</span><span class="sign">-</span> betadhatnew
<span class="line_number">2721 </span>        convergence <span class="sign">&lt;</span><span class="sign">-</span> newconvergence
<span class="line_number">2722 </span>        dispparams <span class="sign">&lt;</span><span class="sign">-</span> dispersionoutput   
<span class="line_number">2723 </span>        iter <span class="sign">&lt;</span><span class="sign">-</span> iter <span class="sign">+</span> 1
<span class="line_number">2724 </span>    <span class="sign">}</span>
<span class="line_number">2725 </span>    
<span class="line_number">2726 </span>    <span class="comment">## Format for output, compute standard errors, etc</span>
<span class="line_number">2727 </span>    betahat <span class="sign">&lt;</span><span class="sign">-</span> regressionoutput<span class="sign">$</span>betahat
<span class="line_number">2728 </span>    betadhat <span class="sign">&lt;</span><span class="sign">-</span> regressionoutput<span class="sign">$</span>betadhat
<span class="line_number">2729 </span>    alphars <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>vector<span class="sign">(</span>regressionoutput<span class="sign">$</span>alphars<span class="sign">)</span>
<span class="line_number">2730 </span>    alpharsd <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>vector<span class="sign">(</span>regressionoutput<span class="sign">$</span>alpharsd<span class="sign">)</span>
<span class="line_number">2731 </span>    <span class="keyword">if</span><span class="sign">(</span>computesd<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2732 </span>        <span class="comment"># Compute standard errors either using full sensitivity matrix, or only</span>
<span class="line_number">2733 </span>        <span class="comment"># the sensitivity of the regression coefficients</span>
<span class="line_number">2734 </span>        <span class="keyword">if</span><span class="sign">(</span>fullS<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2735 </span>            np <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>betahat<span class="sign">)</span> <span class="sign">+</span> <span class="keyword">sum</span><span class="sign">(</span>K<span class="sign">)</span><span class="sign">;</span>npd <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>betadhat<span class="sign">)</span> <span class="sign">+</span> <span class="keyword">sum</span><span class="sign">(</span>Kd<span class="sign">)</span>
<span class="line_number">2736 </span>            b <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> np <span class="sign">+</span> npd<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>betahat<span class="sign">)</span> <span class="sign">+</span> <span class="keyword">length</span><span class="sign">(</span>betadhat<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2737 </span>            b<span class="sign">[</span>c<span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span>K<span class="sign">)</span> <span class="sign">+</span> 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">,</span> <span class="keyword">sum</span><span class="sign">(</span>K<span class="sign">)</span> <span class="sign">+</span> <span class="keyword">sum</span><span class="sign">(</span>Kd<span class="sign">)</span> <span class="sign">+</span> <span class="keyword">length</span><span class="sign">(</span>betahat<span class="sign">)</span> <span class="sign">+</span>
<span class="line_number">2738 </span>                1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>betadhat<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span> 1<span class="sign">:</span><span class="keyword">dim</span><span class="sign">(</span>b<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> diag<span class="sign">(</span>1<span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>b<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2739 </span>            stderr <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo35">fmkstderr</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> b<span class="sign">,</span> datamat<span class="sign">,</span> datamatd<span class="sign">,</span> regressionoutput<span class="sign">$</span>alphars<span class="sign">,</span>
<span class="line_number">2740 </span>                    regressionoutput<span class="sign">$</span>alpharsd<span class="sign">,</span> betahat<span class="sign">,</span> betadhat<span class="sign">,</span> as<span class="sign">,</span> asd<span class="sign">,</span>
<span class="line_number">2741 </span>                    frailtyoutput<span class="sign">,</span> dispersionoutput<span class="sign">,</span> K<span class="sign">,</span> Kd<span class="sign">,</span> univariate<span class="sign">)</span>            
<span class="line_number">2742 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">2743 </span>            S <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo32">fmakeSens2</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> datamatd<span class="sign">,</span> regressionoutput<span class="sign">$</span>alphars<span class="sign">,</span>
<span class="line_number">2744 </span>                regressionoutput<span class="sign">$</span>alpharsd<span class="sign">,</span> betahat<span class="sign">,</span> betadhat<span class="sign">,</span> as<span class="sign">,</span> asd<span class="sign">,</span>
<span class="line_number">2745 </span>                frailtyoutput<span class="sign">,</span> dispersionoutput<span class="sign">,</span> K<span class="sign">,</span> Kd<span class="sign">,</span> fullS<span class="sign">)</span>
<span class="line_number">2746 </span>            <span class="keyword">if</span><span class="sign">(</span>univariate<span class="sign">)</span> S <span class="sign">&lt;</span><span class="sign">-</span> S<span class="sign">[</span>1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">,</span> 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">2747 </span>            stderr <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sqrt</span><span class="sign">(</span>diag<span class="sign">(</span><span class="sign">-</span>solve<span class="sign">(</span>S<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2748 </span>        <span class="sign">}</span>
<span class="line_number">2749 </span>        std_betahat <span class="sign">&lt;</span><span class="sign">-</span> stderr<span class="sign">[</span>1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">2750 </span>        std_betadhat <span class="sign">&lt;</span><span class="sign">-</span> stderr<span class="sign">[</span><span class="keyword">length</span><span class="sign">(</span>betahat<span class="sign">)</span> <span class="sign">+</span> 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>betadhat<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">2751 </span>    <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">2752 </span>        stderr <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">2753 </span>        std_betahat <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">2754 </span>        std_betadhat <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">2755 </span>    <span class="sign">}</span>
<span class="line_number">2756 </span>
<span class="line_number">2757 </span>    <span class="comment"># Compute p-values and summaries</span>
<span class="line_number">2758 </span>    pval <span class="sign">=</span> pmin<span class="sign">(</span>pnorm<span class="sign">(</span>betahat <span class="sign">/</span> std_betahat<span class="sign">)</span><span class="sign">,</span> 1 <span class="sign">-</span> pnorm<span class="sign">(</span>betahat <span class="sign">/</span> std_betahat<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2759 </span>    pval<span class="sign">.</span>d <span class="sign">=</span> pmin<span class="sign">(</span>pnorm<span class="sign">(</span>betadhat <span class="sign">/</span> std_betadhat<span class="sign">)</span><span class="sign">,</span> 1 <span class="sign">-</span> pnorm<span class="sign">(</span>betadhat <span class="sign">/</span> std_betadhat<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2760 </span>    varnames <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">unique</span><span class="sign">(</span>c<span class="sign">(</span>varnames1<span class="sign">,</span> varnames2<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2761 </span>    summary<span class="sign">.</span>reg <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>data<span class="sign">.</span>frame<span class="sign">(</span>matrix<span class="sign">(</span>NA<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>varnames<span class="sign">)</span><span class="sign">,</span> 6<span class="sign">)</span><span class="sign">,</span> row<span class="sign">.</span>names <span class="sign">=</span> varnames<span class="sign">)</span>
<span class="line_number">2762 </span>        <span class="keyword">colnames</span><span class="sign">(</span>summary<span class="sign">.</span>reg<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="quote">"coeff.1"</span><span class="sign">,</span> <span class="quote">"se.1"</span><span class="sign">,</span> <span class="quote">"pval.1"</span><span class="sign">,</span> <span class="quote">"coeff.2"</span><span class="sign">,</span> <span class="quote">"se.2"</span><span class="sign">,</span> <span class="quote">"pval.2"</span><span class="sign">)</span>
<span class="line_number">2763 </span>        summary<span class="sign">.</span>reg<span class="sign">[</span>match<span class="sign">(</span>varnames1<span class="sign">,</span> varnames<span class="sign">)</span><span class="sign">,</span> 1<span class="sign">:</span>3<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">cbind</span><span class="sign">(</span>betahat<span class="sign">,</span> std_betahat<span class="sign">,</span> pval<span class="sign">)</span>
<span class="line_number">2764 </span>        summary<span class="sign">.</span>reg<span class="sign">[</span>match<span class="sign">(</span>varnames2<span class="sign">,</span> varnames<span class="sign">)</span><span class="sign">,</span> 3 <span class="sign">+</span> 1<span class="sign">:</span>3<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 
<span class="line_number">2765 </span>                        <span class="keyword">cbind</span><span class="sign">(</span>betadhat<span class="sign">,</span> std_betadhat<span class="sign">,</span> pval<span class="sign">.</span>d<span class="sign">)</span>
<span class="line_number">2766 </span>        
<span class="line_number">2767 </span>    rhohat <span class="sign">&lt;</span><span class="sign">-</span> dispparams<span class="sign">$</span>thetahat <span class="sign">/</span> <span class="keyword">sqrt</span><span class="sign">(</span><span class="sign">(</span>dispparams<span class="sign">$</span>sigma2hat <span class="sign">+</span> dispparams<span class="sign">$</span>nu2hat<span class="sign">)</span> <span class="sign">*</span>
<span class="line_number">2768 </span>            <span class="sign">(</span>dispparams<span class="sign">$</span>sigma2dhat <span class="sign">+</span> dispparams<span class="sign">$</span>nu2dhat<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2769 </span>    
<span class="line_number">2770 </span>    summary<span class="sign">.</span>disp <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>dispparams<span class="sign">$</span>sigma2hat<span class="sign">,</span> dispparams<span class="sign">$</span>sigma2dhat<span class="sign">,</span> dispparams<span class="sign">$</span>nu2hat<span class="sign">,</span>
<span class="line_number">2771 </span>            dispparams<span class="sign">$</span>nu2dhat<span class="sign">,</span> dispparams<span class="sign">$</span>thetahat<span class="sign">,</span> rhohat<span class="sign">)</span>
<span class="line_number">2772 </span>    names<span class="sign">(</span>summary<span class="sign">.</span>disp<span class="sign">)</span> <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="quote">"sigma2hat"</span><span class="sign">,</span> <span class="quote">"sigma2dhat"</span><span class="sign">,</span> <span class="quote">"nu2hat"</span><span class="sign">,</span>
<span class="line_number">2773 </span>            <span class="quote">"nu2dhat"</span><span class="sign">,</span> <span class="quote">"thetahat"</span><span class="sign">,</span> <span class="quote">"rhohat"</span><span class="sign">)</span>
<span class="line_number">2774 </span>            
<span class="line_number">2775 </span>
<span class="line_number">2776 </span>    <span class="keyword">return</span><span class="sign">(</span><span class="keyword">list</span><span class="sign">(</span><span class="keyword">call</span> <span class="sign">=</span> <span class="keyword">call</span><span class="sign">,</span>
<span class="line_number">2777 </span>                summary<span class="sign">.</span>reg <span class="sign">=</span> summary<span class="sign">.</span>reg<span class="sign">,</span>
<span class="line_number">2778 </span>                summary<span class="sign">.</span>disp <span class="sign">=</span> summary<span class="sign">.</span>disp<span class="sign">,</span>
<span class="line_number">2779 </span>                regressionoutput <span class="sign">=</span> regressionoutput<span class="sign">,</span>
<span class="line_number">2780 </span>                frailtyoutput <span class="sign">=</span> frailtyoutput<span class="sign">,</span>
<span class="line_number">2781 </span>                dispparams <span class="sign">=</span> dispparams<span class="sign">,</span>
<span class="line_number">2782 </span>                initial <span class="sign">=</span> initial<span class="sign">,</span>
<span class="line_number">2783 </span>                stderr <span class="sign">=</span> stderr<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2784 </span><span class="sign">}</span>
</pre>

<hr />
<a name="estimation2ffmakealphars2"></a>
<a name="robo12"></a><h2>estimation/fmakealphars2 [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo6">estimation</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>fmakealphars2</strong> --- Fortran wrapper for <a href="../src/bivrec_f.html#robo22">fmkalpha2</a>
</pre>
<p class="item_name">FUNCTION</p>
<p>   Compute the MLEs for the baseline hazard parameters alphars, 
   given estimates of regression parameters andf frailties, for
   a single recurrent event process.
</p>

<p>   This works in the same way as <a href="#robo75">makealphars2</a>
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">264 </span><strong>fmakealphars2</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> betahat<span class="sign">,</span> as<span class="sign">,</span> Uijmat<span class="sign">,</span> smooth<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m          number of clusters
    Ji         cluster sizes
    datamat    data matrix generated by <a href="#robo37">makedatamat</a>
    betahat    vector of regression parameter estimates
    as         matrix of discretization breakpoints for each stratum
    Uijmat     matrix of frailty estimates
    smooth     boolean to indicate whether the output should be smoothed
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    alphars    matrix of baseline hazard parameters of size p x K
               containing the hazard estimate for each stratum and
               discretization interval
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">267 </span><span class="sign">{</span>
<span class="line_number">268 </span>    <span class="comment"># Allocate storage</span>
<span class="line_number">269 </span>    alphars <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">270 </span>    <span class="comment"># Split the data matrix into different components</span>
<span class="line_number">271 </span>    covs <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>datamat<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 8<span class="sign">)</span>
<span class="line_number">272 </span>    ncovs <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span>
<span class="line_number">273 </span>    d <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span>
<span class="line_number">274 </span>    index <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span><span class="quote">"i"</span><span class="sign">,</span> <span class="quote">"j"</span><span class="sign">,</span> <span class="quote">"k"</span><span class="sign">,</span> <span class="quote">"r"</span><span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">)</span><span class="sign">]</span>
<span class="line_number">275 </span>    delta <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span><span class="sign">,</span> <span class="quote">"delta"</span><span class="sign">]</span>
<span class="line_number">276 </span>    times <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span><span class="sign">,</span> <span class="quote">"time"</span><span class="sign">]</span>
<span class="line_number">277 </span>    
<span class="line_number">278 </span>    <span class="comment"># Fortran call</span>
<span class="line_number">279 </span>     out <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">.</span>Fortran<span class="sign">(</span><span class="quote">"<a href="../src/bivrec_f.html#robo22">fmkalpha2</a>"</span><span class="sign">,</span> 
<span class="line_number">280 </span>        betahat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">,</span> 
<span class="line_number">281 </span>        index <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>index<span class="sign">)</span><span class="sign">,</span> 
<span class="line_number">282 </span>        delta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>delta<span class="sign">)</span><span class="sign">,</span> 
<span class="line_number">283 </span>        times <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>times<span class="sign">)</span><span class="sign">,</span> 
<span class="line_number">284 </span>        Z <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">,</span> 
<span class="line_number">285 </span>        alphars <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>alphars<span class="sign">)</span><span class="sign">,</span> 
<span class="line_number">286 </span>        as <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">,</span> 
<span class="line_number">287 </span>        Uijmat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Uijmat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">288 </span>        d <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>d<span class="sign">)</span><span class="sign">,</span> 
<span class="line_number">289 </span>        ncovs <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ncovs<span class="sign">)</span><span class="sign">,</span> 
<span class="line_number">290 </span>        nr <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span> 
<span class="line_number">291 </span>        ns <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span> 
<span class="line_number">292 </span>        m <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>m<span class="sign">)</span><span class="sign">,</span> 
<span class="line_number">293 </span>        maxj <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>max<span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">294 </span>      <span class="sign">)</span>
<span class="line_number">295 </span>     <span class="comment"># Extract output</span>
<span class="line_number">296 </span>     alphars <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>out<span class="sign">$</span>alphars<span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>alphars<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>alphars<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">297 </span>     
<span class="line_number">298 </span>     <span class="keyword">if</span><span class="sign">(</span>smooth<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">299 </span>        alphars <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo15">smoothalpha</a><span class="sign">(</span>alphars<span class="sign">,</span> as<span class="sign">)</span>
<span class="line_number">300 </span>     <span class="sign">}</span>
<span class="line_number">301 </span>     
<span class="line_number">302 </span>     <span class="keyword">return</span><span class="sign">(</span>alphars<span class="sign">)</span>
<span class="line_number">303 </span><span class="sign">}</span>
</pre>

<hr />
<a name="estimation2ffupdatefrailties4"></a>
<a name="robo13"></a><h2>estimation/fupdatefrailties4 [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo6">estimation</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>fupdatefrailties4</strong> --- update frailty estimates
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute estimates of the cluster- and subject-level frailties. This function
    acts as a wrapper for the FORTRAN routine <a href="../src/bivrec_f.html#robo23">fmkfrail</a>. See the <a href="../src/bivrec_f.html#robo23">fmkfrail</a>
    documentation for details, or see <a href="#robo74">fupdatefrailties3</a> for an R implementation.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">608 </span><strong>fupdatefrailties4</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> datamatd<span class="sign">,</span> alphars<span class="sign">,</span> alpharsd<span class="sign">,</span> 
<span class="line_number">609 </span>                                as<span class="sign">,</span> asd<span class="sign">,</span> betahat<span class="sign">,</span> betadhat<span class="sign">,</span> dispparams<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m          number of clusters
    Ji         cluster sizes
    datamat    data matrix generated by <a href="#robo37">makedatamat</a> for event 1
    datamatd   data matrix generated by <a href="#robo37">makedatamat</a> for event 2
    alphars    matrix of baseline hazard parameters for event 1
    alpharsd   matrix of baseline hazard parameters for event 2
    as         matrix of discretization breakpoints for event 1
    asd        matrix of discretization breakpoints for event 2
    betahat    regression coefficient estimates for event 1
    betadhat   regression coefficient estimates for event 2
    dispparams list of dispersion parameter estimates, see <a href="#robo18">updatedisppears</a>
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    Uihat      vector of cluster-level frailties for event 1
    Vihat      vector of cluster-level frailties for event 2
    Uijhat     vector of subject-level frailties for event 1
    Vijhat     vector of subject-level frailties for event 2
    pqrs       list of intermediate values which are useful for computing
               dispersion parameter estimates
    Uijframe   list containing matrix versions of Uijhat and Vijhat
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">612 </span><span class="sign">{</span>
<span class="line_number">613 </span>    <span class="comment"># Extract dispersion parameters</span>
<span class="line_number">614 </span>    sigma2hat <span class="sign">&lt;</span><span class="sign">-</span> dispparams<span class="sign">$</span>sigma2hat
<span class="line_number">615 </span>    sigma2dhat <span class="sign">&lt;</span><span class="sign">-</span> dispparams<span class="sign">$</span>sigma2dhat
<span class="line_number">616 </span>    nu2hat <span class="sign">&lt;</span><span class="sign">-</span> dispparams<span class="sign">$</span>nu2hat
<span class="line_number">617 </span>    nu2dhat <span class="sign">&lt;</span><span class="sign">-</span> dispparams<span class="sign">$</span>nu2dhat
<span class="line_number">618 </span>    thetahat <span class="sign">&lt;</span><span class="sign">-</span> dispparams<span class="sign">$</span>thetahat
<span class="line_number">619 </span>    
<span class="line_number">620 </span>    <span class="comment">## Initialize frailty vectors</span>
<span class="line_number">621 </span>    Uihat <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span><span class="sign">;</span>Vihat <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">622 </span>    Uijhat <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>Vijhat <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">623 </span>
<span class="line_number">624 </span>   <span class="comment"># Initialize matrices for storage of pi, qi, pij, qij, etc.</span>
<span class="line_number">625 </span>    jimax <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>Ji<span class="sign">)</span>
<span class="line_number">626 </span>    pi <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span><span class="sign">;</span>qi <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span><span class="sign">;</span>ri <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span><span class="sign">;</span>si <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span>
<span class="line_number">627 </span>    piprime <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span><span class="sign">;</span>qiprime <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">628 </span>    riprime <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span><span class="sign">;</span>siprime <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">629 </span>    wi <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span>
<span class="line_number">630 </span>    pij <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>pijprime <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">631 </span>    qij <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>qijprime <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">632 </span>    rij <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>rijprime <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">633 </span>    sij <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>sijprime <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">634 </span>    wij <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>zij <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">635 </span>
<span class="line_number">636 </span>    <span class="comment"># Prepare data for submission to Fortran function <a href="../src/bivrec_f.html#robo23">fmkfrail</a></span>
<span class="line_number">637 </span>    Z <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>datamat<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 8<span class="sign">)</span>
<span class="line_number">638 </span>    ncovs1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>Z<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span>
<span class="line_number">639 </span>    d1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>Z<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span>
<span class="line_number">640 </span>    index <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span><span class="quote">"i"</span><span class="sign">,</span> <span class="quote">"j"</span><span class="sign">,</span> <span class="quote">"k"</span><span class="sign">,</span> <span class="quote">"r"</span><span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">)</span><span class="sign">]</span>
<span class="line_number">641 </span>    delta <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span><span class="sign">,</span> <span class="quote">"delta"</span><span class="sign">]</span>
<span class="line_number">642 </span>    Zd <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>datamatd<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamatd<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamatd<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 8<span class="sign">)</span>
<span class="line_number">643 </span>    ncovs2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>Zd<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span>
<span class="line_number">644 </span>    d2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>Zd<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span>
<span class="line_number">645 </span>    indexd <span class="sign">&lt;</span><span class="sign">-</span> datamatd<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span><span class="quote">"i"</span><span class="sign">,</span> <span class="quote">"j"</span><span class="sign">,</span> <span class="quote">"k"</span><span class="sign">,</span> <span class="quote">"r"</span><span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">)</span><span class="sign">]</span>
<span class="line_number">646 </span>    deltad <span class="sign">&lt;</span><span class="sign">-</span> datamatd<span class="sign">[</span><span class="sign">,</span> <span class="quote">"delta"</span><span class="sign">]</span>
<span class="line_number">647 </span>    nr <span class="sign">=</span> <span class="keyword">dim</span><span class="sign">(</span>alphars<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span>
<span class="line_number">648 </span>    ns <span class="sign">=</span> <span class="keyword">dim</span><span class="sign">(</span>alphars<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span>
<span class="line_number">649 </span>    nsd <span class="sign">=</span> <span class="keyword">dim</span><span class="sign">(</span>alpharsd<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span>
<span class="line_number">650 </span>
<span class="line_number">651 </span>    <span class="comment"># Submit to Fortran</span>
<span class="line_number">652 </span>    out <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span><span class="sign">.</span>Fortran<span class="sign">(</span><span class="quote">"<a href="../src/bivrec_f.html#robo23">fmkfrail</a>"</span><span class="sign">,</span>
<span class="line_number">653 </span>        index <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>index<span class="sign">)</span><span class="sign">,</span>      <span class="comment"># indices i,j,k,r,smin,smax</span>
<span class="line_number">654 </span>        indexd <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>indexd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">655 </span>        delta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>delta<span class="sign">)</span><span class="sign">,</span>       <span class="comment"># event indicators</span>
<span class="line_number">656 </span>        deltad <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>deltad<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">657 </span>        Z <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Z<span class="sign">)</span><span class="sign">,</span>               <span class="comment"># covariates</span>
<span class="line_number">658 </span>        Zd <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Zd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">659 </span>        alphars <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>alphars<span class="sign">)</span><span class="sign">,</span>   <span class="comment"># hazards</span>
<span class="line_number">660 </span>        alpharsd <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>alpharsd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">661 </span>        as <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">,</span>             <span class="comment"># breakpoints</span>
<span class="line_number">662 </span>        asd <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>asd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">663 </span>        betahat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">,</span>   <span class="comment"># regression coefficients</span>
<span class="line_number">664 </span>        betadhat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>betadhat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">665 </span>        m <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>m<span class="sign">)</span><span class="sign">,</span>              <span class="comment"># clusters and cluster sizes</span>
<span class="line_number">666 </span>        Ji <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">667 </span>        jimax <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>max<span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">668 </span>        Jicum <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>c<span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">cumsum</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">669 </span>        jisum <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">670 </span>        d1 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>d1<span class="sign">)</span><span class="sign">,</span>            <span class="comment"># dimensions of covariate vectors</span>
<span class="line_number">671 </span>        d2 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>d2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">672 </span>        ncovs1 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ncovs1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">673 </span>        ncovs2 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ncovs2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">674 </span>        nr <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>nr<span class="sign">)</span><span class="sign">,</span>            <span class="comment"># number of strata</span>
<span class="line_number">675 </span>        ns <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ns<span class="sign">)</span><span class="sign">,</span>            <span class="comment"># number of breakpoints</span>
<span class="line_number">676 </span>        nsd <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>nsd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">677 </span>        sigma2 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>sigma2hat<span class="sign">)</span><span class="sign">,</span>  <span class="comment"># current dispersion parameters</span>
<span class="line_number">678 </span>        sigma2d <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>sigma2dhat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">679 </span>        nu2 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>nu2hat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">680 </span>        nu2d <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>nu2dhat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">681 </span>        theta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>thetahat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">682 </span>        Uihat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Uihat<span class="sign">)</span><span class="sign">,</span>       <span class="comment"># emtpy matrices to store frailty estimates</span>
<span class="line_number">683 </span>        Vihat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Vihat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">684 </span>        Uijhat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Uijhat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">685 </span>        Vijhat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Vijhat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">686 </span>        pi <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>pi<span class="sign">)</span><span class="sign">,</span>             <span class="comment"># matrices to store intermediate values</span>
<span class="line_number">687 </span>        qi <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>qi<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">688 </span>        ri <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>ri<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">689 </span>        si <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>si<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">690 </span>        piprime <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>piprime<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">691 </span>        qiprime <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>qiprime<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">692 </span>        riprime <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>riprime<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">693 </span>        siprime <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>siprime<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">694 </span>        pij <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>pij<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">695 </span>        qij <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>qij<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">696 </span>        rij <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>rij<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">697 </span>        sij <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>sij<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">698 </span>        pijprime <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>pijprime<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">699 </span>        qijprime <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>qijprime<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">700 </span>        rijprime <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>rijprime<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">701 </span>        sijprime <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>sijprime<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">702 </span>        wi <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>wi<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">703 </span>        wij <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>wij<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">704 </span>        zij <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>zij<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">705 </span>    
<span class="line_number">706 </span>    <span class="comment"># Too small frailty estimates are not allowed</span>
<span class="line_number">707 </span>    out<span class="sign">$</span>Uijhat<span class="sign">[</span>out<span class="sign">$</span>Uijhat<span class="sign">&lt;</span><span class="sign">.</span>01<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">.</span>01<span class="sign">;</span> out<span class="sign">$</span>Vijhat<span class="sign">[</span>out<span class="sign">$</span>Vijhat <span class="sign">&lt;</span> 0<span class="sign">.</span>01<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">.</span>01
<span class="line_number">708 </span>    
<span class="line_number">709 </span>    <span class="comment"># Extract output</span>
<span class="line_number">710 </span>    pij <span class="sign">=</span> matrix<span class="sign">(</span>out<span class="sign">$</span>pij<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number">711 </span>        qij <span class="sign">=</span> matrix<span class="sign">(</span>out<span class="sign">$</span>qij<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number">712 </span>        rij <span class="sign">=</span> matrix<span class="sign">(</span>out<span class="sign">$</span>rij<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number">713 </span>        sij <span class="sign">=</span> matrix<span class="sign">(</span>out<span class="sign">$</span>sij<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number">714 </span>        
<span class="line_number">715 </span>    pijprime <span class="sign">=</span> matrix<span class="sign">(</span>out<span class="sign">$</span>pijprime<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number">716 </span>        qijprime <span class="sign">=</span> matrix<span class="sign">(</span>out<span class="sign">$</span>qijprime<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number">717 </span>        rijprime <span class="sign">=</span> matrix<span class="sign">(</span>out<span class="sign">$</span>rijprime<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number">718 </span>        sijprime <span class="sign">=</span> matrix<span class="sign">(</span>out<span class="sign">$</span>sijprime<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number">719 </span>        
<span class="line_number">720 </span>    zij <span class="sign">=</span> matrix<span class="sign">(</span>out<span class="sign">$</span>zij<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number">721 </span>        wij <span class="sign">=</span> matrix<span class="sign">(</span>out<span class="sign">$</span>wij<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number">722 </span>        
<span class="line_number">723 </span>    
<span class="line_number">724 </span>    <span class="comment"># Format frailtyoutput list</span>
<span class="line_number">725 </span>    <span class="keyword">return</span><span class="sign">(</span><span class="keyword">list</span><span class="sign">(</span>Uihat <span class="sign">=</span> out<span class="sign">$</span>Uihat<span class="sign">,</span>
<span class="line_number">726 </span>            Vihat <span class="sign">=</span> out<span class="sign">$</span>Vihat<span class="sign">,</span> 
<span class="line_number">727 </span>            Uijhat <span class="sign">=</span> out<span class="sign">$</span>Uijhat<span class="sign">,</span>
<span class="line_number">728 </span>            Vijhat <span class="sign">=</span> out<span class="sign">$</span>Vijhat<span class="sign">,</span>
<span class="line_number">729 </span>            pqrs <span class="sign">=</span> <span class="keyword">list</span><span class="sign">(</span>pij <span class="sign">=</span> pij<span class="sign">,</span> qij <span class="sign">=</span> qij<span class="sign">,</span> rij <span class="sign">=</span> rij<span class="sign">,</span> sij <span class="sign">=</span> sij<span class="sign">,</span>
<span class="line_number">730 </span>                pijprime <span class="sign">=</span> pijprime<span class="sign">,</span> qijprime <span class="sign">=</span> qijprime<span class="sign">,</span>
<span class="line_number">731 </span>                rijprime <span class="sign">=</span> rijprime<span class="sign">,</span> sijprime <span class="sign">=</span> sijprime<span class="sign">,</span>
<span class="line_number">732 </span>                pi <span class="sign">=</span> out<span class="sign">$</span>pi<span class="sign">,</span> qi <span class="sign">=</span> out<span class="sign">$</span>qi<span class="sign">,</span> ri <span class="sign">=</span> out<span class="sign">$</span>ri<span class="sign">,</span> si <span class="sign">=</span> out<span class="sign">$</span>si<span class="sign">,</span>
<span class="line_number">733 </span>                piprime <span class="sign">=</span> out<span class="sign">$</span>piprime<span class="sign">,</span> qiprime <span class="sign">=</span> out<span class="sign">$</span>qiprime<span class="sign">,</span>
<span class="line_number">734 </span>                riprime <span class="sign">=</span> out<span class="sign">$</span>riprime<span class="sign">,</span> siprime <span class="sign">=</span> out<span class="sign">$</span>siprime<span class="sign">,</span>
<span class="line_number">735 </span>                wi <span class="sign">=</span> out<span class="sign">$</span>wi<span class="sign">,</span> zij <span class="sign">=</span> zij<span class="sign">,</span> wij <span class="sign">=</span> wij<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">736 </span>            Uijframe <span class="sign">=</span> <a href="#robo70">makeUijframe</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> out<span class="sign">$</span>Uijhat<span class="sign">,</span> out<span class="sign">$</span>Vijhat<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">737 </span><span class="sign">}</span>
</pre>

<hr />
<a name="estimation2fgetdispmarg3"></a>
<a name="robo14"></a><h2>estimation/getdispmarg3 [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo6">estimation</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>getdispmarg3</strong> --- workhorse function for computing marginal estimators
</pre>
<p class="item_name">FUNCTION</p>
<p>    This function is used by updatedispmarg to compute the sums of cross
    products of event indicators and means. Inputs are data for any two processes,
    which may be event processes 1 and 2, or two copies of event 1, or two copies
    of event 2. The sample variances and covariances of the two processes are
    computed under the auxiliary Poisson model.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1146 </span><strong>getdispmarg3</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat1<span class="sign">,</span> datamat2<span class="sign">,</span> alphars1<span class="sign">,</span> alphars2<span class="sign">,</span> 
<span class="line_number">1147 </span>                as1<span class="sign">,</span> as2<span class="sign">,</span> betahat1<span class="sign">,</span> betahat2<span class="sign">,</span> same<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    datamat1   data matrix generated by <a href="#robo37">makedatamat</a> for process 1
    datamat2   data matrix generated by <a href="#robo37">makedatamat</a> for process 2
    alphars1   matrix of baseline hazard parameters for process 1
    alphars2   matrix of baseline hazard parameters for process 2
    as1        matrix of discretization breakpoints for process 1
    as2        matrix of discretization breakpoints for process 2
    betahat1   regression coefficient estimates for process 1
    betadha2   regression coefficient estimates for process 2
    same       boolean indicator of whether process 1 and 2 are the same
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    sig2nu2    marginal estimate of sigma^2 + nu^2 (or theta, if the processes
               are different)
    sig2       marginal estimate of sigma^2
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1150 </span><span class="sign">{</span>
<span class="line_number">1151 </span>    
<span class="line_number">1152 </span>    <span class="comment">#Initialze vectors and matrices</span>
<span class="line_number">1153 </span>    jimax <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>Ji<span class="sign">)</span>
<span class="line_number">1154 </span>    Smu1 <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>Sdelta1 <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1155 </span>    Smu2 <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>Sdelta2 <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1156 </span>  
<span class="line_number">1157 </span>    <span class="comment"># Prepare for FORTRAN</span>
<span class="line_number">1158 </span>    covs1 <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>datamat1<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat1<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat1<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 8<span class="sign">)</span>
<span class="line_number">1159 </span>    ncovs1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>covs1<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span>
<span class="line_number">1160 </span>    d1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>covs1<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span>
<span class="line_number">1161 </span>    index1 <span class="sign">&lt;</span><span class="sign">-</span> datamat1<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span><span class="quote">"i"</span><span class="sign">,</span> <span class="quote">"j"</span><span class="sign">,</span> <span class="quote">"k"</span><span class="sign">,</span> <span class="quote">"r"</span><span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">)</span><span class="sign">]</span>
<span class="line_number">1162 </span>    delta1 <span class="sign">&lt;</span><span class="sign">-</span> datamat1<span class="sign">[</span><span class="sign">,</span> <span class="quote">"delta"</span><span class="sign">]</span>
<span class="line_number">1163 </span> 
<span class="line_number">1164 </span>    <span class="comment"># First, compute the sums for the first data set.</span>
<span class="line_number">1165 </span>    Sm1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span><span class="sign">.</span>Fortran<span class="sign">(</span><span class="quote">"<a href="../src/bivrec_f.html#robo31">fsmuij</a>"</span><span class="sign">,</span>
<span class="line_number">1166 </span>            betahat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>betahat1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1167 </span>            index <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>index1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1168 </span>            delta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>delta1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1169 </span>            Z <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>covs1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1170 </span>            alphars <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>alphars1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1171 </span>            as <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>as1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1172 </span>            d <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>d1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1173 </span>            ncovs <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ncovs1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1174 </span>            nr <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>alphars1<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1175 </span>            ns <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>alphars1<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1176 </span>            m <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>m<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1177 </span>            maxj <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>max<span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1178 </span>            Smu <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Smu1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1179 </span>            Sdelta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Sdelta1<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1180 </span>
<span class="line_number">1181 </span>    Smu1 <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>Sm1<span class="sign">$</span>Smu<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number">1182 </span>    Sdelta1 <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>Sm1<span class="sign">$</span>Sdelta<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number">1183 </span>    
<span class="line_number">1184 </span>    <span class="comment"># Compute sums for the second data set</span>
<span class="line_number">1185 </span>    covs2 <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>datamat2<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat2<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat2<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 8<span class="sign">)</span>
<span class="line_number">1186 </span>    ncovs2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>covs2<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span>
<span class="line_number">1187 </span>    d2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>covs2<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span>
<span class="line_number">1188 </span>    index2 <span class="sign">&lt;</span><span class="sign">-</span> datamat2<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span><span class="quote">"i"</span><span class="sign">,</span> <span class="quote">"j"</span><span class="sign">,</span> <span class="quote">"k"</span><span class="sign">,</span> <span class="quote">"r"</span><span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">)</span><span class="sign">]</span>
<span class="line_number">1189 </span>    delta2 <span class="sign">&lt;</span><span class="sign">-</span> datamat2<span class="sign">[</span><span class="sign">,</span> <span class="quote">"delta"</span><span class="sign">]</span>
<span class="line_number">1190 </span>    
<span class="line_number">1191 </span>    Sm2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span><span class="sign">.</span>Fortran<span class="sign">(</span><span class="quote">"<a href="../src/bivrec_f.html#robo31">fsmuij</a>"</span><span class="sign">,</span>
<span class="line_number">1192 </span>            betahat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>betahat2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1193 </span>            index <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>index2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1194 </span>            delta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>delta2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1195 </span>            Z <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>covs2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1196 </span>            alphars <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>alphars2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1197 </span>            as <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>as2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1198 </span>            d <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>d2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1199 </span>            ncovs <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ncovs2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1200 </span>            nr <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>alphars2<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1201 </span>            ns <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>alphars2<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1202 </span>            m <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>m<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1203 </span>            maxj <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>max<span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1204 </span>            Smu <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Smu2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1205 </span>            Sdelta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Sdelta2<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1206 </span>        
<span class="line_number">1207 </span>    Smu2 <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>Sm2<span class="sign">$</span>Smu<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number">1208 </span>    Sdelta2 <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>Sm2<span class="sign">$</span>Sdelta<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number">1209 </span>    
<span class="line_number">1210 </span>    <span class="comment"># This computation relies on the fact that for vectors x_1, x_2, </span>
<span class="line_number">1211 </span>    <span class="comment"># a^Tx_1x_2^Te = (a^Tx_1)(a^Tx_2). Therefore,</span>
<span class="line_number">1212 </span>    <span class="comment"># the numerator and denominator of sig2nu2= can be computed as</span>
<span class="line_number">1213 </span>    sig2nu2num <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span><span class="sign">(</span>Sdelta1 <span class="sign">-</span> Smu1<span class="sign">)</span> <span class="sign">*</span> <span class="sign">(</span>Sdelta2 <span class="sign">-</span> Smu2<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1214 </span>    sig2nu2den <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>Smu1 <span class="sign">*</span> Smu2<span class="sign">)</span>
<span class="line_number">1215 </span>    <span class="comment">#! If they come from the same data set, we must subtract the diagonal elements</span>
<span class="line_number">1216 </span>    <span class="keyword">if</span><span class="sign">(</span>same<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1217 </span>        <a href="#robo80">Smud2</a> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span><span class="sign">.</span>Fortran<span class="sign">(</span><span class="quote">"<a href="../src/bivrec_f.html#robo30">fsmud2</a>"</span><span class="sign">,</span>
<span class="line_number">1218 </span>                    betahat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>betahat1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1219 </span>                    index <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>index1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1220 </span>                    delta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>delta1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1221 </span>                    Z <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>covs1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1222 </span>                    alphars <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>alphars1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1223 </span>                    as <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>as1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1224 </span>                    d <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>d1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1225 </span>                    ncovs <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ncovs1<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1226 </span>                    nr <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>alphars1<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1227 </span>                    ns <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>alphars1<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1228 </span>                    Smud <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>0<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1229 </span>                    Smu2 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>0<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1230 </span>        Smud <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo80">Smud2</a><span class="sign">$</span>Smud
<span class="line_number">1231 </span>        Smusq <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo80">Smud2</a><span class="sign">$</span>Smu2
<span class="line_number">1232 </span>        <span class="comment"># Correct the estimates by removing the diagonal terms</span>
<span class="line_number">1233 </span>        sig2nu2num <span class="sign">&lt;</span><span class="sign">-</span> sig2nu2num <span class="sign">-</span> Smud
<span class="line_number">1234 </span>        sig2nu2den <span class="sign">&lt;</span><span class="sign">-</span> sig2nu2den <span class="sign">-</span> Smusq
<span class="line_number">1235 </span>    <span class="sign">}</span>
<span class="line_number">1236 </span>    sig2nu2 <span class="sign">&lt;</span><span class="sign">-</span> sig2nu2num <span class="sign">/</span> sig2nu2den
<span class="line_number">1237 </span>    
<span class="line_number">1238 </span>    <span class="comment"># Computing the value of  sig2 is analogous. </span>
<span class="line_number">1239 </span>    <span class="comment"># First, sum over all the subjects in each cluster, then compute the </span>
<span class="line_number">1240 </span>    <span class="comment"># numerator and denominator separately, by adding all the cross terms </span>
<span class="line_number">1241 </span>    <span class="comment"># and subtracting those for which b = j.</span>
<span class="line_number">1242 </span>    Sdeltai1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">apply</span><span class="sign">(</span>Sdelta1<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">)</span>
<span class="line_number">1243 </span>    Sdeltai2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">apply</span><span class="sign">(</span>Sdelta2<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">)</span>
<span class="line_number">1244 </span>    Smui1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">apply</span><span class="sign">(</span>Smu1<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">)</span>
<span class="line_number">1245 </span>    Smui2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">apply</span><span class="sign">(</span>Smu2<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">)</span>
<span class="line_number">1246 </span>    sig2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span><span class="sign">(</span>Sdeltai1 <span class="sign">-</span> Smui1<span class="sign">)</span> <span class="sign">*</span> <span class="sign">(</span>Sdeltai2 <span class="sign">-</span> Smui2<span class="sign">)</span><span class="sign">)</span> <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span><span class="sign">(</span>Sdelta1 <span class="sign">-</span> Smu1<span class="sign">)</span> <span class="sign">*</span>
<span class="line_number">1247 </span>        <span class="sign">(</span>Sdelta2 <span class="sign">-</span> Smu2<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span> <span class="sign">/</span> <span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span>Smui1 <span class="sign">*</span> Smui2<span class="sign">)</span> <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>Smu1 <span class="sign">*</span> Smu2<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1248 </span>
<span class="line_number">1249 </span>    <span class="comment"># Format for output</span>
<span class="line_number">1250 </span>    <span class="keyword">return</span><span class="sign">(</span><span class="keyword">list</span><span class="sign">(</span>sig2nu2 <span class="sign">=</span> sig2nu2<span class="sign">,</span> sig2 <span class="sign">=</span> sig2<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1251 </span><span class="sign">}</span>
</pre>

<hr />
<a name="estimation2fsmoothalpha"></a>
<a name="robo15"></a><h2>estimation/smoothalpha [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo6">estimation</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>smoothalpha</strong> --- smooth hazard estimates
</pre>
<p class="item_name">FUNCTION</p>
<p>    Applies a spline smoother to the baseline hazard estimates. This was sometimes
    found to improve stability.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">318 </span><strong>smoothalpha</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>alphars<span class="sign">,</span> as<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    alphars    matrix of baseline hazard parameters 
    as         matrix of discretization breakpoints for each stratum
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    alphars    matrix of baseline hazard parameters
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">321 </span><span class="sign">{</span>
<span class="line_number">322 </span>     <span class="keyword">for</span><span class="sign">(</span>r in 1<span class="sign">:</span><span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">323 </span>        idx <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">which</span><span class="sign">(</span>alphars<span class="sign">[</span>r<span class="sign">,</span> <span class="sign">]</span> <span class="comment">!= 100)</span>
<span class="line_number">324 </span>        idx <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>idx<span class="sign">,</span> idx<span class="sign">[</span><span class="keyword">length</span><span class="sign">(</span>idx<span class="sign">)</span><span class="sign">]</span> <span class="sign">+</span> 1<span class="sign">)</span>
<span class="line_number">325 </span>        xs <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>as<span class="sign">[</span>r<span class="sign">,</span> idx<span class="sign">[</span> <span class="sign">-</span> 1<span class="sign">]</span><span class="sign">]</span> <span class="sign">+</span> as<span class="sign">[</span>r<span class="sign">,</span> idx<span class="sign">[</span> <span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>idx<span class="sign">)</span><span class="sign">]</span><span class="sign">]</span><span class="sign">)</span> <span class="sign">/</span> 2
<span class="line_number">326 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>xs<span class="sign">)</span> <span class="sign">&gt;</span> 50<span class="sign">)</span> nk <span class="sign">&lt;</span><span class="sign">-</span> 50 <span class="keyword">else</span> nk <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">327 </span>        <span class="comment"># Apply a spline smoother to the hazards</span>
<span class="line_number">328 </span>        out <span class="sign">&lt;</span><span class="sign">-</span> smooth<span class="sign">.</span>spline<span class="sign">(</span>xs<span class="sign">,</span> alphars<span class="sign">[</span>r<span class="sign">,</span> idx<span class="sign">[</span> <span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>idx<span class="sign">)</span><span class="sign">]</span><span class="sign">]</span><span class="sign">,</span> 
<span class="line_number">329 </span>            w <span class="sign">=</span> <span class="keyword">diff</span><span class="sign">(</span>as<span class="sign">[</span>r<span class="sign">,</span> idx<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span> nknots <span class="sign">=</span> nk<span class="sign">)</span>
<span class="line_number">330 </span>        alphars<span class="sign">[</span>r<span class="sign">,</span> idx<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>out<span class="sign">$</span>y<span class="sign">,</span> 100<span class="sign">)</span>
<span class="line_number">331 </span>     <span class="sign">}</span>
<span class="line_number">332 </span>     <span class="keyword">return</span><span class="sign">(</span>alphars<span class="sign">)</span>
<span class="line_number">333 </span><span class="sign">}</span>
</pre>

<hr />
<a name="estimation2fupdatedispmarg2"></a>
<a name="robo16"></a><h2>estimation/updatedispmarg2 [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo6">estimation</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>updatedispmarg2</strong> --- Marginal estimators for the dispersion parameters
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute dispersion parameter estimates using a marginal method, based on
    the moments of the event indicators delta under the auxiliary Poisson model.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1071 </span><strong>updatedispmarg2</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> datamatd<span class="sign">,</span> alphars<span class="sign">,</span> alpharsd<span class="sign">,</span> as<span class="sign">,</span> asd<span class="sign">,</span> 
<span class="line_number">1072 </span>                        betahat<span class="sign">,</span> betadhat<span class="sign">,</span> fixzero<span class="sign">,</span> univariate <span class="sign">=</span> FALSE<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m          number of clusters
    Ji         cluster sizes
    datamat    data matrix generated by <a href="#robo37">makedatamat</a> for event 1
    datamatd   data matrix generated by <a href="#robo37">makedatamat</a> for event 2
    alphars    matrix of baseline hazard parameters for event 1
    alpharsd   matrix of baseline hazard parameters for event 2
    as         matrix of discretization breakpoints for event 1
    asd        matrix of discretization breakpoints for event 2
    betahat    regression coefficient estimates for event 1
    betadhat   regression coefficient estimates for event 2
    fixzero    list of estimators that should be fixed at zero (testing only)
    univariate boolean indicator whether a univariate model is being fit
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    sigma2hat      cluster-level dispersion for process 1
    sigma2dhat     cluster-level dispersion for process 2
    nu2hat             subject-level dispersion for process 1
    nu2dhat            subject-level dispersion for process 2
    thetahat       subject-level covariance
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1075 </span><span class="sign">{</span>
<span class="line_number">1076 </span>    <span class="comment"># The function <a href="#robo14">getdispmarg3</a> makes the FORTRAN calls that do most of the work</span>
<span class="line_number">1077 </span>    <span class="comment"># out1 contains only terms involving event 1</span>
<span class="line_number">1078 </span>    <span class="comment"># out2 only the event 2, and out3 contains the cross-terms</span>
<span class="line_number">1079 </span>    out1 <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo14">getdispmarg3</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> datamat<span class="sign">,</span> alphars<span class="sign">,</span> alphars<span class="sign">,</span> 
<span class="line_number">1080 </span>                    as<span class="sign">,</span> as<span class="sign">,</span> betahat<span class="sign">,</span> betahat<span class="sign">,</span> TRUE<span class="sign">)</span>
<span class="line_number">1081 </span>    out2 <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo14">getdispmarg3</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamatd<span class="sign">,</span> datamatd<span class="sign">,</span> alpharsd<span class="sign">,</span> alpharsd<span class="sign">,</span> 
<span class="line_number">1082 </span>                    asd<span class="sign">,</span> asd<span class="sign">,</span> betadhat<span class="sign">,</span> betadhat<span class="sign">,</span> TRUE<span class="sign">)</span>
<span class="line_number">1083 </span>    out3 <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo14">getdispmarg3</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> datamatd<span class="sign">,</span> alphars<span class="sign">,</span> alpharsd<span class="sign">,</span> 
<span class="line_number">1084 </span>                    as<span class="sign">,</span> asd<span class="sign">,</span> betahat<span class="sign">,</span> betadhat<span class="sign">,</span> FALSE<span class="sign">)</span>
<span class="line_number">1085 </span>
<span class="line_number">1086 </span>    <span class="comment"># Extract the estimated dispersion parameters, and truncate from below</span>
<span class="line_number">1087 </span>    sigma2hat <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>out1<span class="sign">$</span>sig2<span class="sign">,</span> 1e<span class="sign">-</span>4<span class="sign">)</span>
<span class="line_number">1088 </span>    sigma2dhat <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>out2<span class="sign">$</span>sig2<span class="sign">,</span> 1e<span class="sign">-</span>4<span class="sign">)</span>
<span class="line_number">1089 </span>    <span class="comment"># Fix parameters at 0 if desired</span>
<span class="line_number">1090 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="comment">!is.null(fixzero)){</span>
<span class="line_number">1091 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="quote">"sigma2hat"</span><span class="sign">%</span>in<span class="sign">%</span>fixzero<span class="sign">)</span> sigma2hat <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">1092 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="quote">"sigma2dhat"</span><span class="sign">%</span>in<span class="sign">%</span>fixzero<span class="sign">)</span> sigma2dhat <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">1093 </span>    <span class="sign">}</span>
<span class="line_number">1094 </span>    nu2hat <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>out1<span class="sign">$</span>sig2nu2 <span class="sign">-</span> sigma2hat<span class="sign">,</span> 1e<span class="sign">-</span>4<span class="sign">)</span>
<span class="line_number">1095 </span>    nu2dhat <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>out2<span class="sign">$</span>sig2nu2 <span class="sign">-</span> sigma2dhat<span class="sign">,</span> 1e<span class="sign">-</span>4<span class="sign">)</span>
<span class="line_number">1096 </span>    thetahat <span class="sign">&lt;</span><span class="sign">-</span> out3<span class="sign">$</span>sig2nu2
<span class="line_number">1097 </span>    <span class="comment"># Fix parameters at 0 if desired</span>
<span class="line_number">1098 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="comment">!is.null(fixzero)){</span>
<span class="line_number">1099 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="quote">"nu2hat"</span><span class="sign">%</span>in<span class="sign">%</span>fixzero<span class="sign">)</span> nu2hat <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">1100 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="quote">"nu2dhat"</span><span class="sign">%</span>in<span class="sign">%</span>fixzero<span class="sign">)</span> nu2dhat <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">1101 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="quote">"thetahat"</span><span class="sign">%</span>in<span class="sign">%</span>fixzero<span class="sign">)</span> thetahat <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">1102 </span>    <span class="sign">}</span>
<span class="line_number">1103 </span>    <span class="comment"># The marginal estimators do not guarantee that the esimated covariance matrix</span>
<span class="line_number">1104 </span>    <span class="comment"># is valid. This code truncates the estimate of thetahat if needed</span>
<span class="line_number">1105 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="comment">!univariate)</span>
<span class="line_number">1106 </span>        badtheta <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span>thetahat <span class="sign">/</span> <span class="keyword">sqrt</span><span class="sign">(</span>nu2hat <span class="sign">*</span> nu2dhat<span class="sign">)</span> <span class="sign">&gt;</span> 1 <span class="sign">|</span> thetahat <span class="sign">/</span> 
<span class="line_number">1107 </span>            <span class="keyword">sqrt</span><span class="sign">(</span>nu2hat <span class="sign">*</span> nu2dhat<span class="sign">)</span><span class="sign">&lt;</span> <span class="sign">-</span>1<span class="sign">)</span>
<span class="line_number">1108 </span>    <span class="keyword">else</span> badtheta <span class="sign">&lt;</span><span class="sign">-</span> FALSE
<span class="line_number">1109 </span>    <span class="keyword">if</span><span class="sign">(</span>inherits<span class="sign">(</span>badtheta<span class="sign">,</span> <span class="quote">"try - error"</span><span class="sign">)</span> <span class="sign">|</span> is<span class="sign">.</span>na<span class="sign">(</span>badtheta<span class="sign">)</span><span class="sign">)</span> <span class="sign">{</span>browser<span class="sign">(</span><span class="sign">)</span><span class="sign">;</span> <span class="keyword">return</span><span class="sign">(</span>0<span class="sign">)</span><span class="sign">}</span>
<span class="line_number">1110 </span>    <span class="keyword">if</span><span class="sign">(</span>badtheta<span class="sign">)</span> thetahat <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span>sign<span class="sign">(</span>thetahat<span class="sign">)</span> <span class="sign">*</span> <span class="keyword">sqrt</span><span class="sign">(</span>nu2hat <span class="sign">*</span> nu2dhat<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1111 </span>    <span class="keyword">if</span><span class="sign">(</span>inherits<span class="sign">(</span>thetahat<span class="sign">,</span> <span class="quote">"try - error"</span><span class="sign">)</span><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>0<span class="sign">)</span>
<span class="line_number">1112 </span>    
<span class="line_number">1113 </span>    <span class="comment"># Prepare for output</span>
<span class="line_number">1114 </span>    <span class="keyword">return</span><span class="sign">(</span><span class="keyword">list</span><span class="sign">(</span>sigma2hat <span class="sign">=</span> sigma2hat<span class="sign">,</span>
<span class="line_number">1115 </span>                sigma2dhat <span class="sign">=</span> sigma2dhat<span class="sign">,</span>
<span class="line_number">1116 </span>                nu2hat <span class="sign">=</span> nu2hat<span class="sign">,</span>
<span class="line_number">1117 </span>                nu2dhat <span class="sign">=</span> nu2dhat<span class="sign">,</span>
<span class="line_number">1118 </span>                thetahat <span class="sign">=</span> thetahat<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1119 </span><span class="sign">}</span>
</pre>

<hr />
<a name="estimation2fupdatedispohls"></a>
<a name="robo17"></a><h2>estimation/updatedispohls [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo6">estimation</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>updatedispohls</strong> --- Ohlsson-type dispersion parameter estimators
</pre>
<p class="item_name">FUNCTION</p>
<p>   Compute dispersion parameter estimators using the method proposed by Ohlsson 
   et al. See the paper for the reference.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">893 </span><strong>updatedispohls</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> datamatd<span class="sign">,</span> alphars<span class="sign">,</span> alpharsd<span class="sign">,</span> 
<span class="line_number">894 </span>                            as<span class="sign">,</span> asd<span class="sign">,</span> betahat<span class="sign">,</span> betadhat<span class="sign">,</span> fixzero<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m              number of clusters
    Ji             cluster sizes
    datamat    data matrix generated by <a href="#robo37">makedatamat</a> for event 1
    datamatd   data matrix generated by <a href="#robo37">makedatamat</a> for event 2
    alphars    matrix of baseline hazard parameters for event 1
    alpharsd   matrix of baseline hazard parameters for event 2
    as         matrix of discretization breakpoints for event 1
    asd        matrix of discretization breakpoints for event 2
    betahat    regression coefficient estimates for event 1
    betadhat   regression coefficient estimates for event 2
    fixzero    list of estimators that should be fixed at zero (testing only)
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    sigma2hat      cluster-level dispersion for process 1
    sigma2dhat     cluster-level dispersion for process 2
    nu2hat             subject-level dispersion for process 1
    nu2dhat            subject-level dispersion for process 2
    thetahat       subject-level covariance
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number"> 897 </span><span class="sign">{</span>
<span class="line_number"> 898 </span>    jimax <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>Ji<span class="sign">)</span>
<span class="line_number"> 899 </span>    Smu <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>Sdelta <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>
<span class="line_number"> 900 </span>    Seta <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>SDelta <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>
<span class="line_number"> 901 </span>    
<span class="line_number"> 902 </span>    <span class="comment"># Prepare data for Fortran function <a href="../src/bivrec_f.html#robo31">fsmuij</a> to compute sum for event 1</span>
<span class="line_number"> 903 </span>    covs <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>datamat<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 8<span class="sign">)</span>
<span class="line_number"> 904 </span>    ncovs <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span>
<span class="line_number"> 905 </span>    d <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span>
<span class="line_number"> 906 </span>    index <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span><span class="quote">"i"</span><span class="sign">,</span> <span class="quote">"j"</span><span class="sign">,</span> <span class="quote">"k"</span><span class="sign">,</span> <span class="quote">"r"</span><span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">)</span><span class="sign">]</span>
<span class="line_number"> 907 </span>    delta <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span><span class="sign">,</span> <span class="quote">"delta"</span><span class="sign">]</span>
<span class="line_number"> 908 </span>    
<span class="line_number"> 909 </span>    <span class="comment"># The FORTRAN function <a href="../src/bivrec_f.html#robo31">fsmuij</a> computes a matrix of size m x max(Ji), whose </span>
<span class="line_number"> 910 </span>    <span class="comment"># (i, j) entry is sum(mu_rijks) over all r,k,s</span>
<span class="line_number"> 911 </span>    Sm <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span><span class="sign">.</span>Fortran<span class="sign">(</span><span class="quote">"<a href="../src/bivrec_f.html#robo31">fsmuij</a>"</span><span class="sign">,</span>
<span class="line_number"> 912 </span>            betahat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 913 </span>            index <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>index<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 914 </span>            delta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>delta<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 915 </span>            Z <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 916 </span>            alphars <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>alphars<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 917 </span>            as <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 918 </span>            d <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>d<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 919 </span>            ncovs <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ncovs<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 920 </span>            nr <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>alphars<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 921 </span>            ns <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>alphars<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 922 </span>            m <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>m<span class="sign">)</span><span class="sign">,</span> maxj <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>max<span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 923 </span>            Smu <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Smu<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 924 </span>            Sdelta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Sdelta<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number"> 925 </span>
<span class="line_number"> 926 </span>    <span class="comment"># extract sums from FORTRAN output</span>
<span class="line_number"> 927 </span>    Smu <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>Sm<span class="sign">$</span>Smu<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number"> 928 </span>    Sdelta <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>Sm<span class="sign">$</span>Sdelta<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number"> 929 </span>    
<span class="line_number"> 930 </span>    <span class="comment"># Repeat FORTRAN call for event 2</span>
<span class="line_number"> 931 </span>    covs <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>datamatd<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamatd<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamatd<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 8<span class="sign">)</span>
<span class="line_number"> 932 </span>    ncovs <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span>
<span class="line_number"> 933 </span>    d <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span>
<span class="line_number"> 934 </span>    index <span class="sign">&lt;</span><span class="sign">-</span> datamatd<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span><span class="quote">"i"</span><span class="sign">,</span> <span class="quote">"j"</span><span class="sign">,</span> <span class="quote">"k"</span><span class="sign">,</span> <span class="quote">"r"</span><span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">)</span><span class="sign">]</span>
<span class="line_number"> 935 </span>    Delta <span class="sign">&lt;</span><span class="sign">-</span> datamatd<span class="sign">[</span><span class="sign">,</span> <span class="quote">"delta"</span><span class="sign">]</span>
<span class="line_number"> 936 </span>    
<span class="line_number"> 937 </span>    <span class="comment"># Compute sum of eta_ij analogously</span>
<span class="line_number"> 938 </span>    Se <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span><span class="sign">.</span>Fortran<span class="sign">(</span><span class="quote">"<a href="../src/bivrec_f.html#robo31">fsmuij</a>"</span><span class="sign">,</span>
<span class="line_number"> 939 </span>            betahat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>betadhat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 940 </span>            index <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>index<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 941 </span>            delta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Delta<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 942 </span>            Z <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 943 </span>            alphars <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>alpharsd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 944 </span>            as <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>asd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 945 </span>            d <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>d<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 946 </span>            ncovs <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ncovs<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 947 </span>            nr <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>alpharsd<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 948 </span>            ns <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>alpharsd<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 949 </span>            m <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>m<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 950 </span>            maxj <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>max<span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 951 </span>            Smu <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Seta<span class="sign">)</span><span class="sign">,</span>
<span class="line_number"> 952 </span>            Sdelta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>SDelta<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number"> 953 </span>
<span class="line_number"> 954 </span>    Seta <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>Se<span class="sign">$</span>Smu<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number"> 955 </span>    SDelta <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>Se<span class="sign">$</span>Sdelta<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number"> 956 </span>    
<span class="line_number"> 957 </span>    <span class="comment"># Compute sum(mu_i*) for both processes</span>
<span class="line_number"> 958 </span>    Smui <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">apply</span><span class="sign">(</span>Smu<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">)</span>
<span class="line_number"> 959 </span>    Setai <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">apply</span><span class="sign">(</span>Seta<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">)</span>
<span class="line_number"> 960 </span>    
<span class="line_number"> 961 </span>    <span class="comment"># Begin computing the Ohlsson-type estimates</span>
<span class="line_number"> 962 </span>    Xtild <span class="sign">&lt;</span><span class="sign">-</span> Sdelta <span class="sign">/</span> Smu
<span class="line_number"> 963 </span>    Ztild <span class="sign">&lt;</span><span class="sign">-</span> SDelta <span class="sign">/</span> Seta
<span class="line_number"> 964 </span>    Xtildi <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">apply</span><span class="sign">(</span>Sdelta<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">)</span> <span class="sign">/</span> Smui
<span class="line_number"> 965 </span>    Ztildi <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">apply</span><span class="sign">(</span>SDelta<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">)</span> <span class="sign">/</span> Setai
<span class="line_number"> 966 </span>    Ztildii <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>Ztildi<span class="sign">,</span> Ji<span class="sign">)</span>
<span class="line_number"> 967 </span>
<span class="line_number"> 968 </span>    <span class="comment"># This is a simplistic correction to attempt to resolve some occasional</span>
<span class="line_number"> 969 </span>    <span class="comment"># computational problems caused by too large or too small estimated means.</span>
<span class="line_number"> 970 </span>    <span class="comment"># This line replaces subject estimates which are in the most extreme 5\% by</span>
<span class="line_number"> 971 </span>    <span class="comment"># the cluster-level estimate for the corresponding cluster.</span>
<span class="line_number"> 972 </span>     Ztild<span class="sign">[</span>Ztild <span class="sign">&gt;</span> <span class="keyword">quantile</span><span class="sign">(</span>Ztild<span class="sign">,</span> <span class="sign">.</span>975<span class="sign">)</span> <span class="sign">|</span> Ztild <span class="sign">&lt;</span> <span class="keyword">quantile</span><span class="sign">(</span>Ztild<span class="sign">,</span> <span class="sign">.</span>025<span class="sign">)</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 
<span class="line_number"> 973 </span>         Ztildii<span class="sign">[</span>Ztild <span class="sign">&gt;</span> <span class="keyword">quantile</span><span class="sign">(</span>Ztild<span class="sign">,</span> <span class="sign">.</span>975<span class="sign">)</span> <span class="sign">|</span> Ztild <span class="sign">&lt;</span> <span class="keyword">quantile</span><span class="sign">(</span>Ztild<span class="sign">,</span> <span class="sign">.</span>025<span class="sign">)</span><span class="sign">]</span>
<span class="line_number"> 974 </span>    
<span class="line_number"> 975 </span>    <span class="comment"># Subject-level Ohlsson estimates</span>
<span class="line_number"> 976 </span>    nu2hat <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">;</span>nu2dhat <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">;</span>thetahat <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">;</span>thetadenom <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">;</span>sigma2hat <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">;</span>sigma2dhat <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">;</span>
<span class="line_number"> 977 </span>    <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span>m<span class="sign">)</span><span class="sign">{</span>
<span class="line_number"> 978 </span>        <span class="keyword">for</span><span class="sign">(</span>j in 1<span class="sign">:</span>Ji<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number"> 979 </span>            nu2hat <span class="sign">&lt;</span><span class="sign">-</span> nu2hat <span class="sign">+</span> Smu<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">*</span> <span class="sign">(</span>Xtild<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">-</span> Xtildi<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">^</span>2 
<span class="line_number"> 980 </span>            nu2dhat <span class="sign">&lt;</span><span class="sign">-</span> nu2dhat <span class="sign">+</span> Seta<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">*</span> <span class="sign">(</span>Ztild<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">-</span> Ztildi<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">^</span>2 
<span class="line_number"> 981 </span>            thetahat <span class="sign">&lt;</span><span class="sign">-</span> thetahat <span class="sign">+</span> <span class="sign">(</span>Xtild<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">-</span> Xtildi<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span>
<span class="line_number"> 982 </span>                            <span class="sign">(</span>Ztild<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">-</span> Ztildi<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span>
<span class="line_number"> 983 </span>            thetadenom <span class="sign">&lt;</span><span class="sign">-</span> thetadenom <span class="sign">+</span> <span class="sign">(</span>1 <span class="sign">+</span> 1 <span class="sign">/</span> Smui<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">/</span> Setai<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">*</span>
<span class="line_number"> 984 </span>                    <span class="keyword">sum</span><span class="sign">(</span>Smu<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">]</span> <span class="sign">*</span> Seta<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">]</span><span class="sign">)</span><span class="sign">)</span> <span class="sign">-</span> <span class="sign">(</span>Smu<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">/</span> Smui<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span>
<span class="line_number"> 985 </span>                    Seta<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">/</span> Setai<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span>
<span class="line_number"> 986 </span>        <span class="sign">}</span>
<span class="line_number"> 987 </span>    <span class="sign">}</span>
<span class="line_number"> 988 </span>    <span class="comment"># Complete the estimates of the dispersion parameters.</span>
<span class="line_number"> 989 </span>    nu2hat <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>nu2hat <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>Ji <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">)</span> <span class="sign">/</span>
<span class="line_number"> 990 </span>            <span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span>Smui<span class="sign">)</span> <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span><span class="keyword">apply</span><span class="sign">(</span>Smu<span class="sign">^</span>2<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">)</span> <span class="sign">/</span> Smui<span class="sign">)</span><span class="sign">)</span>
<span class="line_number"> 991 </span>    nu2dhat <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>nu2dhat <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>Ji <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">)</span> <span class="sign">/</span>
<span class="line_number"> 992 </span>            <span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span>Setai<span class="sign">)</span> <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span><span class="keyword">apply</span><span class="sign">(</span>Seta<span class="sign">^</span>2<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">)</span> <span class="sign">/</span> Setai<span class="sign">)</span><span class="sign">)</span>
<span class="line_number"> 993 </span>    thetahat <span class="sign">&lt;</span><span class="sign">-</span> thetahat <span class="sign">/</span> thetadenom
<span class="line_number"> 994 </span>
<span class="line_number"> 995 </span>    <span class="comment"># Fix parameters at 0 if desired</span>
<span class="line_number"> 996 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="comment">!is.null(fixzero)){</span>
<span class="line_number"> 997 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="quote">"nu2hat"</span><span class="sign">%</span>in<span class="sign">%</span>fixzero<span class="sign">)</span> nu2hat <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number"> 998 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="quote">"nu2dhat"</span><span class="sign">%</span>in<span class="sign">%</span>fixzero<span class="sign">)</span> nu2dhat <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number"> 999 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="quote">"thetahat"</span><span class="sign">%</span>in<span class="sign">%</span>fixzero<span class="sign">)</span> thetahat <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">1000 </span>    <span class="sign">}</span>
<span class="line_number">1001 </span>    
<span class="line_number">1002 </span>    <span class="comment"># The Ohlsson - type estimators do not guarantee that the esimated covariance </span>
<span class="line_number">1003 </span>    <span class="comment"># matrix is valid. This code truncates the estimate of thetahat if needed</span>
<span class="line_number">1004 </span>    <span class="keyword">if</span><span class="sign">(</span>nu2hat<span class="sign">&lt;</span><span class="sign">.</span>001<span class="sign">)</span> nu2hat <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">.</span>001
<span class="line_number">1005 </span>    <span class="keyword">if</span><span class="sign">(</span>nu2dhat<span class="sign">&lt;</span><span class="sign">.</span>001<span class="sign">)</span> nu2dhat <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">.</span>001
<span class="line_number">1006 </span>    badtheta <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span>thetahat <span class="sign">/</span> <span class="keyword">sqrt</span><span class="sign">(</span>nu2hat <span class="sign">*</span> nu2dhat<span class="sign">)</span> <span class="sign">&gt;</span> 1 <span class="sign">|</span> 
<span class="line_number">1007 </span>        thetahat <span class="sign">/</span> <span class="keyword">sqrt</span><span class="sign">(</span>nu2hat <span class="sign">*</span> nu2dhat<span class="sign">)</span><span class="sign">&lt;</span> <span class="sign">-</span>1<span class="sign">)</span>
<span class="line_number">1008 </span>    <span class="keyword">if</span><span class="sign">(</span>inherits<span class="sign">(</span>badtheta<span class="sign">,</span> <span class="quote">"try - error"</span><span class="sign">)</span> <span class="sign">|</span> is<span class="sign">.</span>na<span class="sign">(</span>badtheta<span class="sign">)</span><span class="sign">)</span> <span class="sign">{</span>browser<span class="sign">(</span><span class="sign">)</span><span class="sign">;</span> <span class="keyword">return</span><span class="sign">(</span>0<span class="sign">)</span><span class="sign">}</span>
<span class="line_number">1009 </span>    <span class="keyword">if</span><span class="sign">(</span>badtheta<span class="sign">)</span> thetahat <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span>sign<span class="sign">(</span>thetahat<span class="sign">)</span> <span class="sign">*</span> <span class="keyword">sqrt</span><span class="sign">(</span>nu2hat <span class="sign">*</span> nu2dhat<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1010 </span>    <span class="keyword">if</span><span class="sign">(</span>inherits<span class="sign">(</span>thetahat<span class="sign">,</span> <span class="quote">"try - error"</span><span class="sign">)</span><span class="sign">)</span> <span class="keyword">return</span><span class="sign">(</span>0<span class="sign">)</span>
<span class="line_number">1011 </span>    
<span class="line_number">1012 </span>    <span class="comment">#! Estimate the cluster - level dispersion parameters </span>
<span class="line_number">1013 </span>    zij <span class="sign">&lt;</span><span class="sign">-</span> Smu <span class="sign">/</span> <span class="sign">(</span>Smu <span class="sign">+</span> 1 <span class="sign">/</span> nu2hat<span class="sign">)</span>
<span class="line_number">1014 </span>    zi <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">apply</span><span class="sign">(</span>zij<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">)</span>
<span class="line_number">1015 </span>    zijd <span class="sign">&lt;</span><span class="sign">-</span> Seta <span class="sign">/</span> <span class="sign">(</span>Seta <span class="sign">+</span> 1 <span class="sign">/</span> nu2dhat<span class="sign">)</span>
<span class="line_number">1016 </span>    zid <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">apply</span><span class="sign">(</span>zijd<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">)</span>
<span class="line_number">1017 </span>    
<span class="line_number">1018 </span>    Xztildi <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">apply</span><span class="sign">(</span>zij <span class="sign">*</span> Xtild<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">)</span> <span class="sign">/</span> zi
<span class="line_number">1019 </span>    Zztildi <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">apply</span><span class="sign">(</span>zijd <span class="sign">*</span> Ztild<span class="sign">,</span> 1<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">)</span> <span class="sign">/</span> zid
<span class="line_number">1020 </span>    
<span class="line_number">1021 </span>    Xztild <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>zi <span class="sign">*</span> Xztildi<span class="sign">)</span> <span class="sign">/</span> <span class="keyword">sum</span><span class="sign">(</span>zi<span class="sign">)</span>
<span class="line_number">1022 </span>    Zztild <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>zid <span class="sign">*</span> Zztildi<span class="sign">)</span> <span class="sign">/</span> <span class="keyword">sum</span><span class="sign">(</span>zid<span class="sign">)</span>
<span class="line_number">1023 </span>    
<span class="line_number">1024 </span>    sigma2hat <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span>zi <span class="sign">*</span> <span class="sign">(</span>Xztildi <span class="sign">-</span> Xztild<span class="sign">)</span><span class="sign">^</span>2<span class="sign">)</span> <span class="sign">-</span> nu2hat <span class="sign">*</span> <span class="sign">(</span>m <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">)</span> <span class="sign">/</span>
<span class="line_number">1025 </span>                <span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span>zi<span class="sign">)</span> <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>zi<span class="sign">^</span>2<span class="sign">)</span> <span class="sign">/</span> <span class="keyword">sum</span><span class="sign">(</span>zi<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1026 </span>    sigma2dhat <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span>zid <span class="sign">*</span> <span class="sign">(</span>Zztildi <span class="sign">-</span> Zztild<span class="sign">)</span><span class="sign">^</span>2<span class="sign">)</span> <span class="sign">-</span> nu2dhat <span class="sign">*</span> <span class="sign">(</span>m <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">)</span> <span class="sign">/</span>
<span class="line_number">1027 </span>                <span class="sign">(</span><span class="keyword">sum</span><span class="sign">(</span>zid<span class="sign">)</span> <span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>zid<span class="sign">^</span>2<span class="sign">)</span> <span class="sign">/</span> <span class="keyword">sum</span><span class="sign">(</span>zid<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1028 </span>
<span class="line_number">1029 </span>    <span class="comment"># Fix parameters at 0 if desired</span>
<span class="line_number">1030 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="comment">!is.null(fixzero)){</span>
<span class="line_number">1031 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="quote">"sigma2hat"</span><span class="sign">%</span>in<span class="sign">%</span>fixzero<span class="sign">)</span> sigma2hat <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">1032 </span>        <span class="keyword">if</span><span class="sign">(</span><span class="quote">"sigma2dhat"</span><span class="sign">%</span>in<span class="sign">%</span>fixzero<span class="sign">)</span> sigma2dhat <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">1033 </span>    <span class="sign">}</span>
<span class="line_number">1034 </span>    
<span class="line_number">1035 </span>    <span class="comment"># Format for output    </span>
<span class="line_number">1036 </span>    <span class="keyword">return</span><span class="sign">(</span><span class="keyword">list</span><span class="sign">(</span>sigma2hat <span class="sign">=</span> sigma2hat<span class="sign">,</span>
<span class="line_number">1037 </span>                sigma2dhat <span class="sign">=</span> sigma2dhat<span class="sign">,</span>
<span class="line_number">1038 </span>                nu2hat <span class="sign">=</span> nu2hat<span class="sign">,</span>
<span class="line_number">1039 </span>                nu2dhat <span class="sign">=</span> nu2dhat<span class="sign">,</span>
<span class="line_number">1040 </span>                thetahat <span class="sign">=</span> thetahat<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1041 </span><span class="sign">}</span>
</pre>

<hr />
<a name="estimation2fupdatedisppears"></a>
<a name="robo18"></a><h2>estimation/updatedisppears [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo6">estimation</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>updatedisppears</strong> --- Pearson dispersion parameter estimators
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute dispersion parameter estimates as Pearson-type estimators with a
    bias correction for the BLUP shrinkage effect.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">762 </span><strong>updatedisppears</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> frailtyoutput<span class="sign">,</span> dispparams<span class="sign">,</span> corrval<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m              number of clusters
    Ji             cluster sizes
    frailtyoutput  all output of <a href="#robo13">fupdatefrailties4</a>
    dispparams     a list of current estimates of dispersion parameters,
                   with components:
                       sigma2hat, sigma2dhat, nu2hat, nu2dhat, thetahat
    corrval        a ``correction factor'' that can be used to implement
                   Ma's degree-of-freedom adjustment
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    sigma2hat      cluster-level dispersion for process 1
    sigma2dhat     cluster-level dispersion for process 2
    nu2hat             subject-level dispersion for process 1
    nu2dhat            subject-level dispersion for process 2
    thetahat       subject-level covariance
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">765 </span><span class="sign">{</span>
<span class="line_number">766 </span>    
<span class="line_number">767 </span>    Jicum <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">cumsum</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">768 </span>    jimax <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>Ji<span class="sign">)</span>
<span class="line_number">769 </span>    
<span class="line_number">770 </span>    <span class="comment">## Extract variables from the parameters passed into the function</span>
<span class="line_number">771 </span>    pij <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>pij<span class="sign">;</span> qij <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>qij<span class="sign">;</span>
<span class="line_number">772 </span>    rij <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>rij<span class="sign">;</span> sij <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>sij<span class="sign">;</span>
<span class="line_number">773 </span>    pijprime <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>pijprime<span class="sign">;</span> qijprime <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>qijprime<span class="sign">;</span>
<span class="line_number">774 </span>    rijprime <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>rijprime<span class="sign">;</span> sijprime <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>sijprime<span class="sign">;</span>
<span class="line_number">775 </span>    pi <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>pi<span class="sign">;</span> qi <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>qi<span class="sign">;</span>
<span class="line_number">776 </span>    ri <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>ri<span class="sign">;</span> si <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>si<span class="sign">;</span>
<span class="line_number">777 </span>    piprime <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>piprime<span class="sign">;</span> qiprime <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>qiprime<span class="sign">;</span>
<span class="line_number">778 </span>    riprime <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>riprime<span class="sign">;</span> siprime <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>siprime<span class="sign">;</span>
<span class="line_number">779 </span>    wij <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>wij<span class="sign">;</span>zij <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>zij<span class="sign">;</span>
<span class="line_number">780 </span>    wi <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>wi
<span class="line_number">781 </span>    Uihat <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>Uihat<span class="sign">;</span>Vihat <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>Vihat<span class="sign">;</span>
<span class="line_number">782 </span>    Uijhat <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>Uijhat<span class="sign">;</span>Vijhat <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>Vijhat<span class="sign">;</span>
<span class="line_number">783 </span>    sigma2hat <span class="sign">&lt;</span><span class="sign">-</span> dispparams<span class="sign">$</span>sigma2hat<span class="sign">;</span> sigma2dhat <span class="sign">&lt;</span><span class="sign">-</span> dispparams<span class="sign">$</span>sigma2dhat
<span class="line_number">784 </span>    nu2hat <span class="sign">&lt;</span><span class="sign">-</span> dispparams<span class="sign">$</span>nu2hat<span class="sign">;</span> nu2dhat <span class="sign">&lt;</span><span class="sign">-</span> dispparams<span class="sign">$</span>nu2dhat
<span class="line_number">785 </span>    thetahat <span class="sign">&lt;</span><span class="sign">-</span> dispparams<span class="sign">$</span>thetahat
<span class="line_number">786 </span>    
<span class="line_number">787 </span>    
<span class="line_number">788 </span>    <span class="comment">## Initialize mean squared distance vectors</span>
<span class="line_number">789 </span>    ci <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span><span class="sign">;</span>cid <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">790 </span>    cij <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>cijd <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">791 </span>    cijprime <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number">792 </span>    kUU <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>kUV <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">793 </span>    kVU <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>kVV <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number">794 </span>
<span class="line_number">795 </span>    <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span>m<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">796 </span>         
<span class="line_number">797 </span>        <span class="comment">## Compute mean squared distances of cluster frailty estimators</span>
<span class="line_number">798 </span>        ci<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> sigma2hat <span class="sign">*</span> wi<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">*</span> <span class="sign">(</span>1 <span class="sign">+</span> sigma2dhat <span class="sign">*</span> si<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">799 </span>        cid<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> sigma2dhat <span class="sign">*</span> wi<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">*</span> <span class="sign">(</span>1 <span class="sign">+</span> sigma2hat <span class="sign">*</span> pi<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">800 </span>        
<span class="line_number">801 </span>        <span class="keyword">for</span><span class="sign">(</span>j in 1<span class="sign">:</span>Ji<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">802 </span>            
<span class="line_number">803 </span>            <span class="comment">## Compute useful covariance terms for the bias correction</span>
<span class="line_number">804 </span>            kUU<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> sigma2hat <span class="sign">*</span> wi<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">*</span> <span class="sign">(</span><span class="sign">(</span>1 <span class="sign">+</span> sigma2dhat <span class="sign">*</span> si<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span>
<span class="line_number">805 </span>                <span class="sign">(</span>sigma2hat <span class="sign">*</span> pi<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> nu2hat <span class="sign">*</span> pij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> thetahat <span class="sign">*</span> qij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span><span class="sign">)</span> <span class="sign">-</span> 
<span class="line_number">806 </span>                sigma2dhat <span class="sign">*</span> qi<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">*</span> <span class="sign">(</span>sigma2hat <span class="sign">*</span> qi<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> nu2hat <span class="sign">*</span> qij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span>
<span class="line_number">807 </span>                thetahat <span class="sign">*</span> sij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">808 </span>            kUV<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> sigma2hat <span class="sign">*</span> wi<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">*</span> <span class="sign">(</span><span class="sign">(</span>1 <span class="sign">+</span> sigma2dhat <span class="sign">*</span> si<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span>
<span class="line_number">809 </span>                <span class="sign">(</span>thetahat <span class="sign">*</span> pij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> nu2dhat <span class="sign">*</span> qij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span><span class="sign">)</span> <span class="sign">-</span> sigma2dhat <span class="sign">*</span>
<span class="line_number">810 </span>                qi<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">*</span> <span class="sign">(</span>thetahat <span class="sign">*</span> qij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> nu2dhat <span class="sign">*</span> sij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">811 </span>            kVU<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> sigma2dhat <span class="sign">*</span> wi<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">*</span> <span class="sign">(</span><span class="sign">(</span>1 <span class="sign">+</span> sigma2hat <span class="sign">*</span> pi<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span>
<span class="line_number">812 </span>                <span class="sign">(</span>thetahat <span class="sign">*</span> sij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> nu2hat <span class="sign">*</span> qij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span><span class="sign">)</span> <span class="sign">-</span> sigma2hat <span class="sign">*</span>
<span class="line_number">813 </span>                qi<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">*</span> <span class="sign">(</span>thetahat <span class="sign">*</span> qij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> nu2hat <span class="sign">*</span> pij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">814 </span>            kVV<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> sigma2dhat <span class="sign">*</span> wi<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">*</span> <span class="sign">(</span><span class="sign">(</span>1 <span class="sign">+</span> sigma2hat <span class="sign">*</span> pi<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span>
<span class="line_number">815 </span>                <span class="sign">(</span>sigma2dhat <span class="sign">*</span> si<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> nu2dhat <span class="sign">*</span> sij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> thetahat <span class="sign">*</span> qij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span><span class="sign">)</span> <span class="sign">-</span> 
<span class="line_number">816 </span>                sigma2hat <span class="sign">*</span> qi<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">*</span> <span class="sign">(</span>sigma2dhat <span class="sign">*</span> qi<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> nu2dhat <span class="sign">*</span> qij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span>
<span class="line_number">817 </span>                thetahat <span class="sign">*</span> pij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">818 </span>            
<span class="line_number">819 </span>            <span class="comment">## Compute mean squared distances of individual frailty estimators</span>
<span class="line_number">820 </span>            cij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>nu2hat <span class="sign">*</span> pij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> thetahat <span class="sign">*</span> qij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">-</span> 1<span class="sign">)</span> <span class="sign">*</span>
<span class="line_number">821 </span>                <span class="sign">(</span>kUU<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">-</span> sigma2hat <span class="sign">-</span> nu2hat<span class="sign">)</span> <span class="sign">+</span> <span class="sign">(</span>nu2hat <span class="sign">*</span> qij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> thetahat <span class="sign">*</span>
<span class="line_number">822 </span>                sij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span> <span class="sign">(</span>kVU<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">-</span> thetahat<span class="sign">)</span>
<span class="line_number">823 </span>            cijd<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>nu2dhat <span class="sign">*</span> sij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> thetahat <span class="sign">*</span> qij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">-</span> 1<span class="sign">)</span> <span class="sign">*</span>
<span class="line_number">824 </span>                <span class="sign">(</span>kVV<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">-</span> sigma2dhat <span class="sign">-</span> nu2dhat<span class="sign">)</span> <span class="sign">+</span> <span class="sign">(</span>nu2dhat <span class="sign">*</span> qij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> thetahat <span class="sign">*</span>
<span class="line_number">825 </span>                pij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span> <span class="sign">(</span>kUV<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">-</span> thetahat<span class="sign">)</span>
<span class="line_number">826 </span>            cijprime<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> thetahat <span class="sign">-</span> <span class="sign">(</span>1 <span class="sign">-</span> nu2hat <span class="sign">*</span> pij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">-</span> thetahat <span class="sign">*</span>
<span class="line_number">827 </span>                qij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span> kUV<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> <span class="sign">(</span>nu2hat <span class="sign">*</span> qij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> thetahat <span class="sign">*</span>
<span class="line_number">828 </span>                sij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span> kVV<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">-</span> <span class="sign">(</span>sigma2dhat <span class="sign">+</span> nu2dhat<span class="sign">)</span> <span class="sign">*</span>
<span class="line_number">829 </span>                <span class="sign">(</span>nu2hat <span class="sign">*</span> qij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> thetahat <span class="sign">*</span> sij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span><span class="sign">)</span> <span class="sign">-</span> thetahat <span class="sign">*</span>
<span class="line_number">830 </span>                <span class="sign">(</span>nu2hat <span class="sign">*</span> pij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> thetahat <span class="sign">*</span> qij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">831 </span>            
<span class="line_number">832 </span>        <span class="sign">}</span>
<span class="line_number">833 </span>    <span class="sign">}</span>
<span class="line_number">834 </span>    
<span class="line_number">835 </span>    <span class="comment">## Compute estimators of dispersion parameters</span>
<span class="line_number">836 </span>    sigma2hatnew <span class="sign">&lt;</span><span class="sign">-</span> corrval <span class="sign">*</span> 1 <span class="sign">/</span> m <span class="sign">*</span> <span class="keyword">sum</span><span class="sign">(</span><span class="sign">(</span>Uihat <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">^</span>2 <span class="sign">+</span> ci<span class="sign">)</span>
<span class="line_number">837 </span>    sigma2dhatnew <span class="sign">&lt;</span><span class="sign">-</span> corrval <span class="sign">*</span> 1 <span class="sign">/</span> m <span class="sign">*</span> <span class="keyword">sum</span><span class="sign">(</span><span class="sign">(</span>Vihat <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">^</span>2 <span class="sign">+</span> cid<span class="sign">)</span>
<span class="line_number">838 </span>    nu2hatnew <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">;</span>nu2dhatnew <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">;</span> thetahatnew <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">839 </span>    <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span>m<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">840 </span>        nu2hattemp <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">;</span>nu2dhattemp <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">;</span>thetahattemp <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">;</span>
<span class="line_number">841 </span>        <span class="keyword">for</span><span class="sign">(</span>j in 1<span class="sign">:</span>Ji<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">842 </span>            nu2hattemp <span class="sign">&lt;</span><span class="sign">-</span> nu2hattemp <span class="sign">+</span> <span class="sign">(</span>Uijhat<span class="sign">[</span>Jicum<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> j<span class="sign">]</span> <span class="sign">-</span> Uihat<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">^</span>2 <span class="sign">+</span>
<span class="line_number">843 </span>                ci<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> cij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">-</span> 2 <span class="sign">*</span> <span class="sign">(</span>sigma2hat <span class="sign">-</span> kUU<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">844 </span>            nu2dhattemp <span class="sign">&lt;</span><span class="sign">-</span> nu2dhattemp <span class="sign">+</span> <span class="sign">(</span>Vijhat<span class="sign">[</span>Jicum<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> j<span class="sign">]</span> <span class="sign">-</span> Vihat<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">^</span>2 <span class="sign">+</span>
<span class="line_number">845 </span>                cid<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> cijd<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">-</span> 2 <span class="sign">*</span> <span class="sign">(</span>sigma2dhat <span class="sign">-</span> kVV<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">846 </span>            thetahattemp <span class="sign">&lt;</span><span class="sign">-</span> thetahattemp <span class="sign">+</span> <span class="sign">(</span>Uijhat<span class="sign">[</span>Jicum<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> j<span class="sign">]</span> <span class="sign">-</span> Uihat<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span>
<span class="line_number">847 </span>                <span class="sign">(</span>Vijhat<span class="sign">[</span>Jicum<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> j<span class="sign">]</span> <span class="sign">-</span> Vihat<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span> <span class="sign">+</span> cijprime<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> kUV<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span>
<span class="line_number">848 </span>                kVU<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">-</span> sigma2hat <span class="sign">*</span> sigma2dhat <span class="sign">*</span> wi<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">*</span> qi<span class="sign">[</span>i<span class="sign">]</span>
<span class="line_number">849 </span>        <span class="sign">}</span>    
<span class="line_number">850 </span>        nu2hatnew <span class="sign">&lt;</span><span class="sign">-</span> nu2hatnew <span class="sign">+</span> nu2hattemp <span class="sign">/</span> Ji<span class="sign">[</span>i<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">851 </span>        nu2dhatnew <span class="sign">&lt;</span><span class="sign">-</span> nu2dhatnew <span class="sign">+</span> nu2dhattemp <span class="sign">/</span> Ji<span class="sign">[</span>i<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">852 </span>        thetahatnew <span class="sign">&lt;</span><span class="sign">-</span> thetahatnew <span class="sign">+</span> thetahattemp <span class="sign">/</span> Ji<span class="sign">[</span>i<span class="sign">]</span><span class="sign">;</span>
<span class="line_number">853 </span>    <span class="sign">}</span>
<span class="line_number">854 </span>    <span class="comment"># Ad - hoc correction adjustment</span>
<span class="line_number">855 </span>    nu2hatnew <span class="sign">&lt;</span><span class="sign">-</span> corrval <span class="sign">*</span> nu2hatnew <span class="sign">/</span> m
<span class="line_number">856 </span>    nu2dhatnew <span class="sign">&lt;</span><span class="sign">-</span> corrval <span class="sign">*</span> nu2dhatnew <span class="sign">/</span> m
<span class="line_number">857 </span>    thetahatnew <span class="sign">&lt;</span><span class="sign">-</span> corrval <span class="sign">*</span> thetahatnew <span class="sign">/</span> m
<span class="line_number">858 </span>    <span class="comment"># Format for output</span>
<span class="line_number">859 </span>    <span class="keyword">return</span><span class="sign">(</span><span class="keyword">list</span><span class="sign">(</span>sigma2hat <span class="sign">=</span> sigma2hatnew<span class="sign">,</span>
<span class="line_number">860 </span>                sigma2dhat <span class="sign">=</span> sigma2dhatnew<span class="sign">,</span>
<span class="line_number">861 </span>                nu2hat <span class="sign">=</span> nu2hatnew<span class="sign">,</span>
<span class="line_number">862 </span>                nu2dhat <span class="sign">=</span> nu2dhatnew<span class="sign">,</span>
<span class="line_number">863 </span>                thetahat <span class="sign">=</span> thetahatnew<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">864 </span><span class="sign">}</span>
</pre>

<hr />
<a name="estimation2fupdateregprof"></a>
<a name="robo19"></a><h2>estimation/updateregprof [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo6">estimation</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>updateregprof</strong>
</pre>
<p class="item_name">FUNCTION</p>
<p>    Update regression coefficients beta1 and beta1 by maximizing the condition
    profile loglikelihood given all the other parameters. Give the regression
    coefficients, the baseline hazard coefficients are then updated.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1813 </span><strong>updateregprof</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> datamatd<span class="sign">,</span> alphars<span class="sign">,</span> alpharsd<span class="sign">,</span> as<span class="sign">,</span> asd<span class="sign">,</span> 
<span class="line_number">1814 </span>    betahat<span class="sign">,</span> betadhat<span class="sign">,</span> K<span class="sign">,</span> Kd<span class="sign">,</span> frailtyoutput<span class="sign">,</span> dispersionoutput<span class="sign">,</span> smooth<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m              number of clusters
    Ji             cluster sizes
    datamat        data matrix generated by <a href="#robo37">makedatamat</a> for event 1
    datamatd       data matrix generated by <a href="#robo37">makedatamat</a> for event 2
    alphars            matrix of baseline hazard parameters for event 1
    alpharsd           matrix of baseline hazard parameters for event 2
    as                 matrix of discretization breakpoints for event 1
    asd                matrix of discretization breakpoints for event 2
    betahat            regression coefficient estimates for event 
    betadhat           regression coefficient estimates for event 2
    K                  number of discretization intervals for event 1
    Kd                 number of discretization intervals for event 2
    frailtyoutput  output from <a href="#robo13">fupdatefrailties4</a>
    dispersionoutput  output from one of the dispersion <a href="#robo6">estimation</a> routines
    smooth         boolean, indicating whether hazard estimates should be smoothed
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    betahat            regression coefficient estimates for event 
    betadhat           regression coefficient estimates for event 2
    alphars            matrix of baseline hazard parameters for event 1
    alpharsd           matrix of baseline hazard parameters for event 2
    as                 matrix of discretization breakpoints for event 1
    asd                matrix of discretization breakpoints for event 2
    loglik         loglikelihood ( = loglik1 + loglik2 )
    loglik1        profile loglikelihood of betahat
    loglik2        profile loglikelihood of betadhat
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1817 </span><span class="sign">{</span>
<span class="line_number">1818 </span>    
<span class="line_number">1819 </span>    <span class="comment"># Prepare vectors and matrices for direct submission into Fortran, </span>
<span class="line_number">1820 </span>    <span class="comment"># without requiring type conversions</span>
<span class="line_number">1821 </span>    Uijhatframe <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>Uijframe
<span class="line_number">1822 </span>    fUijmat <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Uijhatframe<span class="sign">$</span>Uijmat<span class="sign">)</span>  <span class="comment"># Frailty matrices</span>
<span class="line_number">1823 </span>    fVijmat <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Uijhatframe<span class="sign">$</span>Vijmat<span class="sign">)</span>    
<span class="line_number">1824 </span>    fas <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>as<span class="sign">)</span>    <span class="comment"># Baseline hazard parameters</span>
<span class="line_number">1825 </span>    fasd <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>asd<span class="sign">)</span>
<span class="line_number">1826 </span>    <span class="comment"># Covariates for event 1</span>
<span class="line_number">1827 </span>    Z <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>matrix<span class="sign">(</span>datamat<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 8<span class="sign">)</span><span class="sign">)</span> 
<span class="line_number">1828 </span>    ncovs <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">)</span>   <span class="comment"># number of covariates</span>
<span class="line_number">1829 </span>    d1 <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span>     <span class="comment"># data matrix dimension (event 1)</span>
<span class="line_number">1830 </span>    index <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>datamat<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span><span class="quote">"i"</span><span class="sign">,</span> <span class="quote">"j"</span><span class="sign">,</span> <span class="quote">"k"</span><span class="sign">,</span> <span class="quote">"r"</span><span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">)</span><span class="sign">]</span><span class="sign">)</span>   
<span class="line_number">1831 </span>    delta <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>datamat<span class="sign">[</span><span class="sign">,</span> <span class="quote">"delta"</span><span class="sign">]</span><span class="sign">)</span>     <span class="comment"># recurrent event indicators</span>
<span class="line_number">1832 </span>    times <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>datamat<span class="sign">[</span><span class="sign">,</span> <span class="quote">"time"</span><span class="sign">]</span><span class="sign">)</span>     <span class="comment"># recurrent event times</span>
<span class="line_number">1833 </span>    <span class="comment"># Covariates for event 2</span>
<span class="line_number">1834 </span>    Zd <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>matrix<span class="sign">(</span>datamatd<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamatd<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamatd<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 8<span class="sign">)</span><span class="sign">)</span> 
<span class="line_number">1835 </span>    d2 <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>datamatd<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span>     <span class="comment"># data matrix dimension (event 2)</span>
<span class="line_number">1836 </span>    indexd <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>datamatd<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span><span class="quote">"i"</span><span class="sign">,</span> <span class="quote">"j"</span><span class="sign">,</span> <span class="quote">"k"</span><span class="sign">,</span> <span class="quote">"r"</span><span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">)</span><span class="sign">]</span><span class="sign">)</span>  
<span class="line_number">1837 </span>    deltad <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>datamatd<span class="sign">[</span><span class="sign">,</span> <span class="quote">"delta"</span><span class="sign">]</span><span class="sign">)</span>  <span class="comment"># terminal event indicators</span>
<span class="line_number">1838 </span>    timesd <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>datamatd<span class="sign">[</span><span class="sign">,</span> <span class="quote">"time"</span><span class="sign">]</span><span class="sign">)</span>   <span class="comment"># terminal event times</span>
<span class="line_number">1839 </span>    nr <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span>    <span class="comment"># Maximum value of r (number of strata)</span>
<span class="line_number">1840 </span>    ns <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span>    <span class="comment"># Maximum value of s (recurrent) + 1</span>
<span class="line_number">1841 </span>    nsd <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>asd<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span>  <span class="comment"># Maximum value of s (terminal)  + 1 </span>
<span class="line_number">1842 </span>
<span class="line_number">1843 </span>    <span class="comment"># Update regression parameters betahat, betadhat using the profile likelihood. </span>
<span class="line_number">1844 </span>    <span class="comment"># Use the built-in  optim method with the BFGS algorithm.</span>
<span class="line_number">1845 </span>    <span class="comment"># The loglikelihood is computed via fmkproflik2and the gradient </span>
<span class="line_number">1846 </span>    <span class="comment"># via <a href="#robo33">fmkprofgr2</a>. Conditionally on the frailties, the processes are </span>
<span class="line_number">1847 </span>    <span class="comment"># independent and can be fit separately </span>
<span class="line_number">1848 </span>    opt <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span>optim<span class="sign">(</span>betahat<span class="sign">,</span> fn <span class="sign">=</span> <a href="#robo34">fmkproflik2</a><span class="sign">,</span> gr <span class="sign">=</span> <a href="#robo33">fmkprofgr2</a><span class="sign">,</span>
<span class="line_number">1849 </span>        control <span class="sign">=</span> <span class="keyword">list</span><span class="sign">(</span>fnscale<span class="sign">=</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">,</span> method <span class="sign">=</span> <span class="quote">"BFGS"</span><span class="sign">,</span>
<span class="line_number">1850 </span>        m <span class="sign">=</span> m<span class="sign">,</span> Ji <span class="sign">=</span> Ji<span class="sign">,</span> index <span class="sign">=</span> index<span class="sign">,</span> Z <span class="sign">=</span> Z<span class="sign">,</span> delta <span class="sign">=</span> delta<span class="sign">,</span> times <span class="sign">=</span> times<span class="sign">,</span> as <span class="sign">=</span> fas<span class="sign">,</span> 
<span class="line_number">1851 </span>        Uijmat <span class="sign">=</span> fUijmat<span class="sign">,</span> ncovs <span class="sign">=</span> ncovs<span class="sign">,</span> d <span class="sign">=</span> d1<span class="sign">,</span> nr <span class="sign">=</span> nr<span class="sign">,</span> ns <span class="sign">=</span> ns<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1852 </span>    optd <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span>optim<span class="sign">(</span>betadhat<span class="sign">,</span> fn <span class="sign">=</span> <a href="#robo34">fmkproflik2</a><span class="sign">,</span> gr <span class="sign">=</span> <a href="#robo33">fmkprofgr2</a><span class="sign">,</span> 
<span class="line_number">1853 </span>    control <span class="sign">=</span> <span class="keyword">list</span><span class="sign">(</span>fnscale<span class="sign">=</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">,</span> method <span class="sign">=</span> <span class="quote">"BFGS"</span><span class="sign">,</span> 
<span class="line_number">1854 </span>        m <span class="sign">=</span> m<span class="sign">,</span> Ji <span class="sign">=</span> Ji<span class="sign">,</span> index <span class="sign">=</span> indexd<span class="sign">,</span> Z <span class="sign">=</span> Zd<span class="sign">,</span> delta <span class="sign">=</span> deltad<span class="sign">,</span> times <span class="sign">=</span> timesd<span class="sign">,</span> 
<span class="line_number">1855 </span>        as <span class="sign">=</span> fasd<span class="sign">,</span> Uijmat <span class="sign">=</span> fVijmat<span class="sign">,</span> ncovs <span class="sign">=</span> ncovs<span class="sign">,</span> d <span class="sign">=</span> d2<span class="sign">,</span> nr <span class="sign">=</span> nr<span class="sign">,</span> ns <span class="sign">=</span> nsd<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1856 </span>    <span class="comment"># Check for errors and quit if it didn't converge</span>
<span class="line_number">1857 </span>    <span class="keyword">if</span><span class="sign">(</span>inherits<span class="sign">(</span>opt<span class="sign">,</span> <span class="quote">"try - error"</span><span class="sign">)</span> <span class="sign">|</span> inherits<span class="sign">(</span>optd<span class="sign">,</span> <span class="quote">"try - error"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1858 </span>        warning<span class="sign">(</span><span class="quote">"Inner loop did not converge"</span><span class="sign">)</span>
<span class="line_number">1859 </span>          browser<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">1860 </span>        <span class="keyword">return</span><span class="sign">(</span>0<span class="sign">)</span>
<span class="line_number">1861 </span>    <span class="sign">}</span>    
<span class="line_number">1862 </span>    <span class="keyword">if</span><span class="sign">(</span>opt<span class="sign">$</span>convergence <span class="comment">!= 0 | optd$convergence != 0){</span>
<span class="line_number">1863 </span>        warning<span class="sign">(</span><span class="quote">"Inner loop did not converge"</span><span class="sign">)</span>
<span class="line_number">1864 </span>          browser<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">1865 </span>        <span class="keyword">return</span><span class="sign">(</span>0<span class="sign">)</span>
<span class="line_number">1866 </span>    <span class="sign">}</span>       
<span class="line_number">1867 </span>    betahat <span class="sign">&lt;</span><span class="sign">-</span> opt<span class="sign">$</span>par
<span class="line_number">1868 </span>    betadhat <span class="sign">&lt;</span><span class="sign">-</span> optd<span class="sign">$</span>par
<span class="line_number">1869 </span>    loglik1 <span class="sign">&lt;</span><span class="sign">-</span> opt<span class="sign">$</span>value
<span class="line_number">1870 </span>    loglik2 <span class="sign">&lt;</span><span class="sign">-</span> optd<span class="sign">$</span>value
<span class="line_number">1871 </span>    loglik <span class="sign">&lt;</span><span class="sign">-</span> loglik1 <span class="sign">+</span> loglik2
<span class="line_number">1872 </span>    <span class="comment"># Given the updated regression parameters, compute the </span>
<span class="line_number">1873 </span>    <span class="comment"># corresponding baseline hazard parameters</span>
<span class="line_number">1874 </span>    alphars <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo12">fmakealphars2</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> betahat<span class="sign">,</span> as<span class="sign">,</span> fUijmat<span class="sign">,</span> smooth<span class="sign">)</span>
<span class="line_number">1875 </span>    alpharsd <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo12">fmakealphars2</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamatd<span class="sign">,</span> betadhat<span class="sign">,</span> asd<span class="sign">,</span> fVijmat<span class="sign">,</span> smooth<span class="sign">)</span>
<span class="line_number">1876 </span>    
<span class="line_number">1877 </span>    <span class="comment"># Format for output</span>
<span class="line_number">1878 </span>    <span class="keyword">return</span><span class="sign">(</span><span class="keyword">list</span><span class="sign">(</span>betahat <span class="sign">=</span> betahat<span class="sign">,</span> betadhat <span class="sign">=</span> betadhat<span class="sign">,</span>
<span class="line_number">1879 </span>                alphars <span class="sign">=</span> alphars<span class="sign">,</span> alpharsd <span class="sign">=</span> alpharsd<span class="sign">,</span>
<span class="line_number">1880 </span>                as <span class="sign">=</span> as<span class="sign">,</span> asd <span class="sign">=</span> asd<span class="sign">,</span>
<span class="line_number">1881 </span>                loglik <span class="sign">=</span> loglik<span class="sign">,</span> loglik1 <span class="sign">=</span> loglik1<span class="sign">,</span> loglik2 <span class="sign">=</span> loglik2<span class="sign">)</span><span class="sign">)</span>  
<span class="line_number">1882 </span><span class="sign">}</span>
</pre>

<hr />
<a name="fortranwrappers2ffmakeSens2"></a>
<a name="robo32"></a><h2>fortranwrappers/fmakeSens2 [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo7">fortranwrappers</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>fmakeSens2</strong> --- construct sensitivity matrix
</pre>
<p class="item_name">FUNCTION</p>
<p>    Construct the sensitivity matrix at the end of the procedure. 
    This is a wrapper for the FORTRAN routine <a href="../src/bivrec_f.html#robo25">fmksens2</a> or <a href="../src/bivrec_f.html#robo26">fmksens2full</a>.
    It only gest called with full=FALSE, because for full=TRUE the function
    <a href="#robo35">fmkstderr</a> uses a faster method.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2145 </span><strong>fmakeSens2</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> datamatd<span class="sign">,</span> alphars<span class="sign">,</span> alpharsd<span class="sign">,</span> betahat<span class="sign">,</span> betadhat<span class="sign">,</span>
<span class="line_number">2146 </span>                as<span class="sign">,</span> asd<span class="sign">,</span> frailtyoutput<span class="sign">,</span> dispersionoutput<span class="sign">,</span> K<span class="sign">,</span> Kd<span class="sign">,</span> full <span class="sign">=</span> FALSE<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m              number of clusters
    Ji             cluster sizes
    datamat        data matrix generated by <a href="#robo37">makedatamat</a> for event 1
    datamatd       data matrix generated by <a href="#robo37">makedatamat</a> for event 2
    alphars            matrix of baseline hazard parameters for event 1
    alpharsd           matrix of baseline hazard parameters for event 2
    betahat            regression coefficient estimates for event 
    betadhat           regression coefficient estimates for event 2
    as                 matrix of discretization breakpoints for event 1
    asd                matrix of discretization breakpoints for event 2
    frailtyoutput  output from <a href="#robo13">fupdatefrailties4</a>
    dispersionoutput  output from one of the dispersion <a href="#robo6">estimation</a> routines
    K                  number of discretization intervals for event 1
    Kd                 number of discretization intervals for event 2
    full           boolean indicating whether full matrix should be computed.
                   If FALSE, only the sensitivity for betahat is returned. 
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    S              Sensitivity matrix
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2149 </span><span class="sign">{</span>
<span class="line_number">2150 </span>    <span class="comment"># Extract intermediate values</span>
<span class="line_number">2151 </span>    pi <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>pi<span class="sign">;</span> qi <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>qi<span class="sign">;</span>
<span class="line_number">2152 </span>    ri <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>ri<span class="sign">;</span> si <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>si<span class="sign">;</span>
<span class="line_number">2153 </span>    wij <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>wij<span class="sign">;</span>zij <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>zij<span class="sign">;</span>
<span class="line_number">2154 </span>    wi <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>wi
<span class="line_number">2155 </span>    sigma2hat <span class="sign">&lt;</span><span class="sign">-</span> dispersionoutput<span class="sign">$</span>sigma2hat<span class="sign">;</span>
<span class="line_number">2156 </span>    sigma2dhat <span class="sign">&lt;</span><span class="sign">-</span> dispersionoutput<span class="sign">$</span>sigma2dhat
<span class="line_number">2157 </span>    nu2hat <span class="sign">&lt;</span><span class="sign">-</span> dispersionoutput<span class="sign">$</span>nu2hat<span class="sign">;</span> nu2dhat <span class="sign">&lt;</span><span class="sign">-</span> dispersionoutput<span class="sign">$</span>nu2dhat
<span class="line_number">2158 </span>    thetahat <span class="sign">&lt;</span><span class="sign">-</span> dispersionoutput<span class="sign">$</span>thetahat
<span class="line_number">2159 </span>   
<span class="line_number">2160 </span>    ncovs1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>betahat<span class="sign">)</span>
<span class="line_number">2161 </span>    ncovs2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>betadhat<span class="sign">)</span>
<span class="line_number">2162 </span>    
<span class="line_number">2163 </span>    <span class="comment"># Prepare data for submission to Fortran function <a href="../src/bivrec_f.html#robo25">fmksens2</a> or <a href="../src/bivrec_f.html#robo26">fmksens2full</a></span>
<span class="line_number">2164 </span>    Z <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>datamat<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 8<span class="sign">)</span>
<span class="line_number">2165 </span>    d1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>Z<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span>
<span class="line_number">2166 </span>    index1 <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span><span class="quote">"i"</span><span class="sign">,</span> <span class="quote">"j"</span><span class="sign">,</span> <span class="quote">"k"</span><span class="sign">,</span> <span class="quote">"r"</span><span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">)</span><span class="sign">]</span>
<span class="line_number">2167 </span>    times1 <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span><span class="sign">,</span> <span class="quote">"time"</span><span class="sign">]</span>
<span class="line_number">2168 </span>    Zd <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>datamatd<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamatd<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamatd<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 8<span class="sign">)</span>
<span class="line_number">2169 </span>    d2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>Zd<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span>
<span class="line_number">2170 </span>    index2 <span class="sign">&lt;</span><span class="sign">-</span> datamatd<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span><span class="quote">"i"</span><span class="sign">,</span> <span class="quote">"j"</span><span class="sign">,</span> <span class="quote">"k"</span><span class="sign">,</span> <span class="quote">"r"</span><span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">)</span><span class="sign">]</span>
<span class="line_number">2171 </span>    times2 <span class="sign">&lt;</span><span class="sign">-</span> datamatd<span class="sign">[</span><span class="sign">,</span> <span class="quote">"time"</span><span class="sign">]</span>
<span class="line_number">2172 </span>    nr <span class="sign">=</span> <span class="keyword">dim</span><span class="sign">(</span>alphars<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span>
<span class="line_number">2173 </span>    ns <span class="sign">=</span> <span class="keyword">dim</span><span class="sign">(</span>alphars<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span>
<span class="line_number">2174 </span>    nsd <span class="sign">=</span> <span class="keyword">dim</span><span class="sign">(</span>alpharsd<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span>
<span class="line_number">2175 </span>    
<span class="line_number">2176 </span>    <span class="keyword">if</span><span class="sign">(</span>full<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2177 </span>        Kcum <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">cumsum</span><span class="sign">(</span>c<span class="sign">(</span>1<span class="sign">,</span> K<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2178 </span>        Kdcum <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">cumsum</span><span class="sign">(</span>c<span class="sign">(</span>1<span class="sign">,</span> Kd<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2179 </span>        np <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>K<span class="sign">)</span> <span class="sign">+</span> ncovs1
<span class="line_number">2180 </span>        npd <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>Kd<span class="sign">)</span> <span class="sign">+</span> ncovs2
<span class="line_number">2181 </span>        S <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> np <span class="sign">+</span> npd<span class="sign">,</span> np <span class="sign">+</span> npd<span class="sign">)</span>
<span class="line_number">2182 </span>        <span class="comment"># Fortran call</span>
<span class="line_number">2183 </span>        out <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span><span class="sign">.</span>Fortran<span class="sign">(</span><span class="quote">"<a href="../src/bivrec_f.html#robo26">fmksens2full</a>"</span><span class="sign">,</span>
<span class="line_number">2184 </span>            Smat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>S<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2185 </span>            index1 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>index1<span class="sign">)</span><span class="sign">,</span> index2 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>index2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2186 </span>            Z <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Z<span class="sign">)</span><span class="sign">,</span> Zd <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Zd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2187 </span>            alphars <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>alphars<span class="sign">)</span><span class="sign">,</span> alpharsd <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>alpharsd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2188 </span>            as <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">,</span> asd <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>asd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2189 </span>            betahat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">,</span> betadhat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>betadhat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2190 </span>            times1 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>times1<span class="sign">)</span><span class="sign">,</span> times2 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>times2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2191 </span>            pi <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>pi<span class="sign">)</span><span class="sign">,</span> qi <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>qi<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2192 </span>            ri <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>ri<span class="sign">)</span><span class="sign">,</span> si <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>si<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2193 </span>            wi <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>wi<span class="sign">)</span><span class="sign">,</span> wij <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>wij<span class="sign">)</span><span class="sign">,</span> zij <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>zij<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2194 </span>            sig2 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>sigma2hat<span class="sign">)</span><span class="sign">,</span> sig2d <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>sigma2dhat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2195 </span>            nu2 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>nu2hat<span class="sign">)</span><span class="sign">,</span> nu2d <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>nu2dhat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2196 </span>            theta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>thetahat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2197 </span>            ncovs1 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ncovs1<span class="sign">)</span><span class="sign">,</span> ncovs2 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ncovs2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2198 </span>            nr <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>nr<span class="sign">)</span><span class="sign">,</span> ns <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ns<span class="sign">)</span><span class="sign">,</span> nsd <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>nsd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2199 </span>            np <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>np<span class="sign">)</span><span class="sign">,</span> npd <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>npd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2200 </span>            d1 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>d1<span class="sign">)</span><span class="sign">,</span> d2 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>d2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2201 </span>            m <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>m<span class="sign">)</span><span class="sign">,</span> Ji <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">,</span> maxj <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>max<span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2202 </span>            Kcum <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>Kcum<span class="sign">)</span><span class="sign">,</span> Kdcum <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>Kdcum<span class="sign">)</span><span class="sign">,</span> DUP <span class="sign">=</span> FALSE<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2203 </span>        
<span class="line_number">2204 </span>        S <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>out<span class="sign">$</span>Smat<span class="sign">,</span> np <span class="sign">+</span> npd<span class="sign">,</span> np <span class="sign">+</span> npd<span class="sign">)</span>
<span class="line_number">2205 </span>    <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">2206 </span>        S <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> ncovs1 <span class="sign">+</span> ncovs2<span class="sign">,</span> ncovs1 <span class="sign">+</span> ncovs2<span class="sign">)</span>
<span class="line_number">2207 </span>    
<span class="line_number">2208 </span>        <span class="comment"># Submit to Fortran</span>
<span class="line_number">2209 </span>        out <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span><span class="sign">.</span>Fortran<span class="sign">(</span><span class="quote">"<a href="../src/bivrec_f.html#robo25">fmksens2</a>"</span><span class="sign">,</span>
<span class="line_number">2210 </span>            Smat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>S<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2211 </span>            index1 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>index1<span class="sign">)</span><span class="sign">,</span> index2 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>index2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2212 </span>            Z <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Z<span class="sign">)</span><span class="sign">,</span> Zd <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Zd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2213 </span>            alphars <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>alphars<span class="sign">)</span><span class="sign">,</span> alpharsd <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>alpharsd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2214 </span>            as <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">,</span> asd <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>asd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2215 </span>            betahat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">,</span> betadhat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>betadhat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2216 </span>            times1 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>times1<span class="sign">)</span><span class="sign">,</span> times2 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>times2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2217 </span>            pi <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>pi<span class="sign">)</span><span class="sign">,</span> qi <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>qi<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2218 </span>            ri <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>ri<span class="sign">)</span><span class="sign">,</span> si <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>si<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2219 </span>            wi <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>wi<span class="sign">)</span><span class="sign">,</span> wij <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>wij<span class="sign">)</span><span class="sign">,</span> zij <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>zij<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2220 </span>            sig2 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>sigma2hat<span class="sign">)</span><span class="sign">,</span> sig2d <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>sigma2dhat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2221 </span>            nu2 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>nu2hat<span class="sign">)</span><span class="sign">,</span> nu2d <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>nu2dhat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2222 </span>            theta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>thetahat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2223 </span>            ncovs1 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ncovs1<span class="sign">)</span><span class="sign">,</span> ncovs2 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ncovs2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2224 </span>            nr <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>nr<span class="sign">)</span><span class="sign">,</span> ns <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ns<span class="sign">)</span><span class="sign">,</span> nsd <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>nsd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2225 </span>            d1 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>d1<span class="sign">)</span><span class="sign">,</span> d2 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>d2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2226 </span>            m <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>m<span class="sign">)</span><span class="sign">,</span> Ji <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">,</span> maxj <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>max<span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2227 </span>        
<span class="line_number">2228 </span>        S <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>out<span class="sign">$</span>Smat<span class="sign">,</span> ncovs1 <span class="sign">+</span> ncovs2<span class="sign">,</span> ncovs1 <span class="sign">+</span> ncovs2<span class="sign">)</span>    
<span class="line_number">2229 </span>    <span class="sign">}</span>
<span class="line_number">2230 </span>    <span class="keyword">return</span><span class="sign">(</span>S<span class="sign">)</span>
<span class="line_number">2231 </span><span class="sign">}</span>
</pre>

<hr />
<a name="fortranwrappers2ffmkprofgr2"></a>
<a name="robo33"></a><h2>fortranwrappers/fmkprofgr2 [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo7">fortranwrappers</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>fmkprofgr2</strong> --- compute profile likelihood gradient
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute the gradient of the profile likelihood, conditional on the frailties
    and other parameters.
    This is just a Fortran wrapper for <a href="../src/bivrec_f.html#robo28">fprofgr</a> that avoids unnecessary type
    conversions for speed. Most of the inputs need to have been converted into
    the row vectors required by FORTRAN.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1762 </span><strong>fmkprofgr2</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> betahat<span class="sign">,</span> index<span class="sign">,</span> delta<span class="sign">,</span> times<span class="sign">,</span> Z<span class="sign">,</span> as<span class="sign">,</span> Uijmat<span class="sign">,</span> d<span class="sign">,</span> ncovs<span class="sign">,</span> nr<span class="sign">,</span> ns<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m          number of clusters
    Ji         cluster sizes
    betahat    regression parameters at which the profile likelihood should be
               computed
    index      matrix of indices i,j,k,r,smin,smax for each row (integer)
    delta      vector of event indicators (double)
    times      vector of actual time span for each row (double)
    Z          matrix of covariates (as a double row vector)
    as         matrix of discretization breakpoints (double row vector)
    Uijmat     matrix of frailty estimates (double row vector)
    d          number of rows of Z
    ncovs      number of covariates
    nr         number of strata
    ns         number of breakpoints
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    likgr      gradient of profile loglikelihood of betahat conditional 
               on the other parameters
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1765 </span><span class="sign">{</span>
<span class="line_number">1766 </span>    gr <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1767 </span>    <span class="comment"># Direct call to Fortran</span>
<span class="line_number">1768 </span>    out <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">.</span>Fortran<span class="sign">(</span><span class="quote">"<a href="../src/bivrec_f.html#robo28">fprofgr</a>"</span><span class="sign">,</span> betahat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">,</span> index <span class="sign">=</span> index<span class="sign">,</span>
<span class="line_number">1769 </span>        delta <span class="sign">=</span> delta<span class="sign">,</span> times <span class="sign">=</span> times<span class="sign">,</span> Z <span class="sign">=</span> Z<span class="sign">,</span> as <span class="sign">=</span> as<span class="sign">,</span> Uijmat <span class="sign">=</span> Uijmat<span class="sign">,</span>
<span class="line_number">1770 </span>        d <span class="sign">=</span> d<span class="sign">,</span> ncovs <span class="sign">=</span> ncovs<span class="sign">,</span> nr <span class="sign">=</span> nr<span class="sign">,</span> ns <span class="sign">=</span> ns<span class="sign">,</span> m <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>m<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1771 </span>        maxj <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>max<span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span> gr <span class="sign">=</span> gr<span class="sign">)</span>
<span class="line_number">1772 </span>    <span class="keyword">return</span><span class="sign">(</span>out<span class="sign">$</span>gr<span class="sign">)</span>
<span class="line_number">1773 </span><span class="sign">}</span>
</pre>

<hr />
<a name="fortranwrappers2ffmkproflik2"></a>
<a name="robo34"></a><h2>fortranwrappers/fmkproflik2 [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo7">fortranwrappers</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>fmkproflik2</strong> --- compute profile likelihood
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute profile likelihood of regression parameters for a single process,
    conditional on the frailties and other parameters.
    This is just a Fortran wrapper for <a href="../src/bivrec_f.html#robo29">fproflik</a> that avoids unnecessary type
    conversions for speed. Most of the inputs need to have been converted into
    the row vectors required by FORTRAN.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1626 </span><strong>fmkproflik2</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> betahat<span class="sign">,</span> index<span class="sign">,</span> delta<span class="sign">,</span> times<span class="sign">,</span> Z<span class="sign">,</span> as<span class="sign">,</span> Uijmat<span class="sign">,</span> 
<span class="line_number">1627 </span>                        d<span class="sign">,</span> ncovs<span class="sign">,</span> nr<span class="sign">,</span> ns<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m          number of clusters
    Ji         cluster sizes
    betahat    regression parameters at which the profile likelihood should be
               computed
    index      matrix of indices i,j,k,r,smin,smax for each row (integer)
    delta      vector of event indicators (double)
    times      vector of actual time span for each row (double)
    Z          matrix of covariates (as a double row vector)
    as         matrix of discretization breakpoints (double row vector)
    Uijmat     matrix of frailty estimates (double row vector)
    d          number of rows of Z
    ncovs      number of covariates
    nr         number of strata
    ns         number of breakpoints
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    loglik     profile loglikelihood of betahat conditional on the other parameters
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1630 </span><span class="sign">{</span>
<span class="line_number">1631 </span>    loglik <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>0<span class="sign">)</span>
<span class="line_number">1632 </span>    out <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">.</span>Fortran<span class="sign">(</span><span class="quote">"<a href="../src/bivrec_f.html#robo29">fproflik</a>"</span><span class="sign">,</span>
<span class="line_number">1633 </span>        betahat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">,</span> index <span class="sign">=</span> index<span class="sign">,</span> delta <span class="sign">=</span> delta<span class="sign">,</span>
<span class="line_number">1634 </span>        times <span class="sign">=</span> times<span class="sign">,</span> Z <span class="sign">=</span> Z<span class="sign">,</span> as <span class="sign">=</span> as<span class="sign">,</span> Uijmat <span class="sign">=</span> Uijmat<span class="sign">,</span>
<span class="line_number">1635 </span>        d <span class="sign">=</span> d<span class="sign">,</span> ncovs <span class="sign">=</span> ncovs<span class="sign">,</span> nr <span class="sign">=</span> nr<span class="sign">,</span> ns <span class="sign">=</span> ns<span class="sign">,</span> m <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>m<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1636 </span>        maxj <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>max<span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span> lik <span class="sign">=</span> loglik<span class="sign">)</span>
<span class="line_number">1637 </span>    <span class="keyword">return</span><span class="sign">(</span>out<span class="sign">$</span>lik<span class="sign">)</span>
<span class="line_number">1638 </span><span class="sign">}</span>
</pre>

<hr />
<a name="fortranwrappers2ffmkstderr"></a>
<a name="robo35"></a><h2>fortranwrappers/fmkstderr [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo7">fortranwrappers</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>fmkstderr</strong> --- compute standard error
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute the standard error entirely within FORTRAN. This is a wrapper for
    the FORTRAN routine fmksterr.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">2259 </span><strong>fmkstderr</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> b<span class="sign">,</span> datamat<span class="sign">,</span> datamatd<span class="sign">,</span> alphars<span class="sign">,</span> alpharsd<span class="sign">,</span> 
<span class="line_number">2260 </span>                    betahat<span class="sign">,</span> betadhat<span class="sign">,</span> as<span class="sign">,</span> asd<span class="sign">,</span> frailtyoutput<span class="sign">,</span> dispersionoutput<span class="sign">,</span> 
<span class="line_number">2261 </span>                    K<span class="sign">,</span> Kd<span class="sign">,</span> univariate <span class="sign">=</span> FALSE<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m              number of clusters
    Ji             cluster sizes
    datamat        data matrix generated by <a href="#robo37">makedatamat</a> for event 1
    datamatd       data matrix generated by <a href="#robo37">makedatamat</a> for event 2
    alphars            matrix of baseline hazard parameters for event 1
    alpharsd           matrix of baseline hazard parameters for event 2
    betahat            regression coefficient estimates for event 
    betadhat           regression coefficient estimates for event 2
    as                 matrix of discretization breakpoints for event 1
    asd                matrix of discretization breakpoints for event 2
    frailtyoutput  output from <a href="#robo13">fupdatefrailties4</a>
    dispersionoutput  output from one of the dispersion <a href="#robo6">estimation</a> routines
    K                  number of discretization intervals for event 1
    Kd                 number of discretization intervals for event 2
    univariate     boolean indicating whether the process is univariate
  OUTPUT
    stderr         a vector of standard errors for regression and hazard params
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">2264 </span><span class="sign">{</span>
<span class="line_number">2265 </span>    pi <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>pi<span class="sign">;</span> qi <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>qi<span class="sign">;</span>
<span class="line_number">2266 </span>    ri <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>ri<span class="sign">;</span> si <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>si<span class="sign">;</span>
<span class="line_number">2267 </span>    wij <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>wij<span class="sign">;</span>zij <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>zij<span class="sign">;</span>
<span class="line_number">2268 </span>    wi <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>wi
<span class="line_number">2269 </span>    sigma2hat <span class="sign">&lt;</span><span class="sign">-</span> dispersionoutput<span class="sign">$</span>sigma2hat<span class="sign">;</span>
<span class="line_number">2270 </span>    sigma2dhat <span class="sign">&lt;</span><span class="sign">-</span> dispersionoutput<span class="sign">$</span>sigma2dhat
<span class="line_number">2271 </span>    nu2hat <span class="sign">&lt;</span><span class="sign">-</span> dispersionoutput<span class="sign">$</span>nu2hat<span class="sign">;</span> nu2dhat <span class="sign">&lt;</span><span class="sign">-</span> dispersionoutput<span class="sign">$</span>nu2dhat
<span class="line_number">2272 </span>    thetahat <span class="sign">&lt;</span><span class="sign">-</span> dispersionoutput<span class="sign">$</span>thetahat
<span class="line_number">2273 </span>   
<span class="line_number">2274 </span>    ncovs1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>betahat<span class="sign">)</span>
<span class="line_number">2275 </span>    ncovs2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>betadhat<span class="sign">)</span>
<span class="line_number">2276 </span>    
<span class="line_number">2277 </span>    <span class="comment"># Prepare data for submission to Fortran function <strong>fmkstderr</strong></span>
<span class="line_number">2278 </span>    Z <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>datamat<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 8<span class="sign">)</span>
<span class="line_number">2279 </span>    d1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>Z<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span>
<span class="line_number">2280 </span>    index1 <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span><span class="quote">"i"</span><span class="sign">,</span> <span class="quote">"j"</span><span class="sign">,</span> <span class="quote">"k"</span><span class="sign">,</span> <span class="quote">"r"</span><span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">)</span><span class="sign">]</span>
<span class="line_number">2281 </span>    times1 <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span><span class="sign">,</span> <span class="quote">"time"</span><span class="sign">]</span>
<span class="line_number">2282 </span>    Zd <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>datamatd<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamatd<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamatd<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 8<span class="sign">)</span>
<span class="line_number">2283 </span>    d2 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>Zd<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span>
<span class="line_number">2284 </span>    index2 <span class="sign">&lt;</span><span class="sign">-</span> datamatd<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span><span class="quote">"i"</span><span class="sign">,</span> <span class="quote">"j"</span><span class="sign">,</span> <span class="quote">"k"</span><span class="sign">,</span> <span class="quote">"r"</span><span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">)</span><span class="sign">]</span>
<span class="line_number">2285 </span>    times2 <span class="sign">&lt;</span><span class="sign">-</span> datamatd<span class="sign">[</span><span class="sign">,</span> <span class="quote">"time"</span><span class="sign">]</span>
<span class="line_number">2286 </span>    nr <span class="sign">=</span> <span class="keyword">dim</span><span class="sign">(</span>alphars<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span>
<span class="line_number">2287 </span>    ns <span class="sign">=</span> <span class="keyword">dim</span><span class="sign">(</span>alphars<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span>
<span class="line_number">2288 </span>    nsd <span class="sign">=</span> <span class="keyword">dim</span><span class="sign">(</span>alpharsd<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span>
<span class="line_number">2289 </span>    Kcum <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">cumsum</span><span class="sign">(</span>c<span class="sign">(</span>1<span class="sign">,</span> K<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2290 </span>    Kdcum <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">cumsum</span><span class="sign">(</span>c<span class="sign">(</span>1<span class="sign">,</span> Kd<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2291 </span>    np <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>K<span class="sign">)</span> <span class="sign">+</span> ncovs1
<span class="line_number">2292 </span>    npd <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>Kd<span class="sign">)</span> <span class="sign">+</span> ncovs2
<span class="line_number">2293 </span>    S <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> np <span class="sign">+</span> npd<span class="sign">,</span> np <span class="sign">+</span> npd<span class="sign">)</span>
<span class="line_number">2294 </span>    <span class="comment"># FORTRAN call</span>
<span class="line_number">2295 </span>    out <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span><span class="sign">.</span>Fortran<span class="sign">(</span><span class="quote">"<strong>fmkstderr</strong>"</span><span class="sign">,</span> Smat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>S<span class="sign">)</span><span class="sign">,</span> B <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>b<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2296 </span>        index1 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>index1<span class="sign">)</span><span class="sign">,</span> index2 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>index2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2297 </span>        Z <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Z<span class="sign">)</span><span class="sign">,</span> Zd <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Zd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2298 </span>        alphars <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>alphars<span class="sign">)</span><span class="sign">,</span> alpharsd <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>alpharsd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2299 </span>        as <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">,</span> asd <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>asd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2300 </span>        betahat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">,</span> betadhat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>betadhat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2301 </span>        times1 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>times1<span class="sign">)</span><span class="sign">,</span> times2 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>times2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2302 </span>        pi <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>pi<span class="sign">)</span><span class="sign">,</span> qi <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>qi<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2303 </span>        ri <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>ri<span class="sign">)</span><span class="sign">,</span> si <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>si<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2304 </span>        wi <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>wi<span class="sign">)</span><span class="sign">,</span> wij <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>wij<span class="sign">)</span><span class="sign">,</span> zij <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>zij<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2305 </span>        sig2 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>sigma2hat<span class="sign">)</span><span class="sign">,</span> sig2d <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>sigma2dhat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2306 </span>        nu2 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>nu2hat<span class="sign">)</span><span class="sign">,</span> nu2d <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>nu2dhat<span class="sign">)</span><span class="sign">,</span> theta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>thetahat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2307 </span>        ncovs1 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ncovs1<span class="sign">)</span><span class="sign">,</span> ncovs2 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ncovs2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2308 </span>        nr <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>nr<span class="sign">)</span><span class="sign">,</span> ns <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ns<span class="sign">)</span><span class="sign">,</span> nsd <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>nsd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2309 </span>        np <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>np<span class="sign">)</span><span class="sign">,</span> npd <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>npd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2310 </span>        d1 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>d1<span class="sign">)</span><span class="sign">,</span> d2 <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>d2<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2311 </span>        m <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>m<span class="sign">)</span><span class="sign">,</span> Ji <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">,</span> maxj <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>max<span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">2312 </span>        Kcum <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>Kcum<span class="sign">)</span><span class="sign">,</span> Kdcum <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>Kdcum<span class="sign">)</span><span class="sign">,</span> DUP <span class="sign">=</span> FALSE<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2313 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="comment">!univariate){</span>
<span class="line_number">2314 </span>        <span class="comment"># extract standard error from the output</span>
<span class="line_number">2315 </span>        x <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>out<span class="sign">$</span>B<span class="sign">,</span> np <span class="sign">+</span> npd<span class="sign">,</span> ncovs1 <span class="sign">+</span> ncovs2<span class="sign">)</span>
<span class="line_number">2316 </span>        stderr <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sqrt</span><span class="sign">(</span>x<span class="sign">[</span>b <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2317 </span>    <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">2318 </span>        <span class="comment"># For univariates, the matrix has to be solved. This could be sped</span>
<span class="line_number">2319 </span>        <span class="comment"># up in the same way, but I didn't have time.</span>
<span class="line_number">2320 </span>        S <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>out<span class="sign">$</span>Smat<span class="sign">,</span> np <span class="sign">+</span> npd<span class="sign">,</span> np <span class="sign">+</span> npd<span class="sign">)</span><span class="sign">[</span>1<span class="sign">:</span>np<span class="sign">,</span> 1<span class="sign">:</span>np<span class="sign">]</span>
<span class="line_number">2321 </span>        stderr <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sqrt</span><span class="sign">(</span>diag<span class="sign">(</span>solve<span class="sign">(</span>S<span class="sign">)</span><span class="sign">)</span><span class="sign">[</span>np <span class="sign">-</span> <span class="sign">(</span>ncovs1 <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">:</span>0<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2322 </span>    <span class="sign">}</span>
<span class="line_number">2323 </span>    <span class="keyword">return</span><span class="sign">(</span>stderr<span class="sign">)</span>
<span class="line_number">2324 </span><span class="sign">}</span>
</pre>

<hr />
<a name="initialization2fmakeas"></a>
<a name="robo36"></a><h2>initialization/makeas [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo8">initialization</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>makeas</strong> --- construct discretization
</pre>
<p class="item_name">FUNCTION</p>
<p>    Split the range of event times into intervals,
    during which the baseline hazard is assumed constant.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">351 </span><strong>makeas</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>agdata<span class="sign">,</span> K<span class="sign">,</span> alternating <span class="sign">=</span> FALSE<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    agdata         a data frame in Anderson-Gill format
    K              vector the number of breakpoints for each stratum
    alternating    boolean indicating episodic data
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    as             matrix of size max(r) x max(K)+1 containing
                   discretization breakpoints for each stratum
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">354 </span><span class="sign">{</span>
<span class="line_number">355 </span>    <span class="comment"># get number of strata</span>
<span class="line_number">356 </span>    rmax <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>agdata<span class="sign">$</span>r<span class="sign">)</span>
<span class="line_number">357 </span>    
<span class="line_number">358 </span>    <span class="comment"># extract the portion of agdata containing events</span>
<span class="line_number">359 </span>    agdatatemp <span class="sign">&lt;</span><span class="sign">-</span> agdata<span class="sign">[</span>agdata<span class="sign">$</span>delta <span class="sign">=</span><span class="sign">=</span> 1 <span class="sign">|</span> 
<span class="line_number">360 </span>        c<span class="sign">(</span><span class="keyword">diff</span><span class="sign">(</span>agdata<span class="sign">$</span>i <span class="sign">*</span> 1000 <span class="sign">+</span> agdata<span class="sign">$</span>j<span class="sign">)</span> <span class="comment">!= 0, TRUE), ]</span>
<span class="line_number">361 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="comment">!alternating) {</span>
<span class="line_number">362 </span>        agdatatemp<span class="sign">$</span>start<span class="sign">[</span> <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> agdatatemp<span class="sign">$</span>stop<span class="sign">[</span> <span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>agdatatemp<span class="sign">$</span>stop<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">363 </span>        agdatatemp<span class="sign">$</span>start<span class="sign">[</span>c<span class="sign">(</span>1<span class="sign">,</span> <span class="keyword">diff</span><span class="sign">(</span>agdatatemp<span class="sign">$</span>i <span class="sign">*</span> 1000 <span class="sign">+</span> agdatatemp<span class="sign">$</span>j<span class="sign">)</span><span class="sign">)</span> <span class="comment">!= 0] &lt;- 0</span>
<span class="line_number">364 </span>    <span class="sign">}</span>
<span class="line_number">365 </span>
<span class="line_number">366 </span>    <span class="comment"># Initialize matrices.</span>
<span class="line_number">367 </span>    as <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> rmax<span class="sign">,</span> max<span class="sign">(</span>K<span class="sign">)</span> <span class="sign">+</span> 1<span class="sign">)</span>
<span class="line_number">368 </span>    <span class="keyword">for</span><span class="sign">(</span>r in 1<span class="sign">:</span>rmax<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">369 </span>        <span class="comment"># Extract the set of event times and death times for each stratum</span>
<span class="line_number">370 </span>        eventtimes <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>0<span class="sign">,</span> sort<span class="sign">(</span><span class="keyword">unique</span><span class="sign">(</span><span class="sign">(</span>agdatatemp<span class="sign">$</span>stop <span class="sign">-</span> 
<span class="line_number">371 </span>            agdatatemp<span class="sign">$</span>start<span class="sign">)</span><span class="sign">[</span>agdatatemp<span class="sign">$</span>r <span class="sign">=</span><span class="sign">=</span> r <span class="sign">&amp;</span> agdatatemp<span class="sign">$</span>delta <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">372 </span>        maxtime <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span><span class="sign">(</span>agdatatemp<span class="sign">$</span>stop <span class="sign">-</span> agdatatemp<span class="sign">$</span>start<span class="sign">)</span><span class="sign">[</span>agdatatemp<span class="sign">$</span>r <span class="sign">=</span><span class="sign">=</span> r<span class="sign">]</span><span class="sign">)</span><span class="sign">+</span><span class="sign">.</span>001
<span class="line_number">373 </span>        <span class="comment"># Compute the set of breakpoints as quantiles, and fill in the rest </span>
<span class="line_number">374 </span>        <span class="comment"># of the matrix with the maximum value.</span>
<span class="line_number">375 </span>        as<span class="sign">[</span>r<span class="sign">,</span> 1<span class="sign">:</span><span class="sign">(</span>K<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">quantile</span><span class="sign">(</span>c<span class="sign">(</span>eventtimes<span class="sign">,</span> maxtime<span class="sign">)</span><span class="sign">,</span> 
<span class="line_number">376 </span>            seq<span class="sign">(</span>from <span class="sign">=</span> 0<span class="sign">,</span> to <span class="sign">=</span> 1<span class="sign">,</span> <span class="keyword">length</span> <span class="sign">=</span> K<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">377 </span>        <span class="keyword">if</span><span class="sign">(</span>K<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">&lt;</span> max<span class="sign">(</span>K<span class="sign">)</span><span class="sign">)</span> as<span class="sign">[</span>r<span class="sign">,</span> <span class="sign">(</span>K<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> 2<span class="sign">)</span><span class="sign">:</span>max<span class="sign">(</span>K <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> maxtime
<span class="line_number">378 </span>    <span class="sign">}</span>
<span class="line_number">379 </span>    <span class="keyword">return</span><span class="sign">(</span>as<span class="sign">)</span>    
<span class="line_number">380 </span><span class="sign">}</span>
</pre>

<hr />
<a name="initialization2fmakedatamat"></a>
<a name="robo37"></a><h2>initialization/makedatamat [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo8">initialization</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>makedatamat</strong> --- make data matrix
</pre>
<p class="item_name">FUNCTION</p>
<p>   Convert an Anderson - Gill data frame for a single recurrent event process into 
   the data matrix format used in the remainder of the algorithm.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">143 </span><strong>makedatamat</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>agdata<span class="sign">,</span> as<span class="sign">,</span> alternating<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    agdata         a data frame in Anderson-Gill format with columns
                   i,j,k,r,start,stop,delta and covariates
    as             a matrix of discretization breakpoints, for each stratum
                   generated by <a href="#robo36">makeas</a>
    alternating    boolean, indicating whether the at-risk function 
                   alternates between events (episodic process)
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    datamat        a matrix with columns i,j,k,r,time,delta,smin,smax
                   and covariates. The columns are:
                   i       cluster
                   j       subject
                   k       event counter
                   r       stratum
                   time    length of time for each interval
                   delta   event indicator
                   smin    discretization interval corresponding to
                           start time in input
                   smax    discretization interval corresponding to
                           stop time in input
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">146 </span><span class="sign">{</span>
<span class="line_number">147 </span>    <span class="comment"># Allocate space. Most data is copied directly from agdata.</span>
<span class="line_number">148 </span>    datamat <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>matrix<span class="sign">(</span><span class="keyword">cbind</span><span class="sign">(</span>agdata<span class="sign">[</span><span class="sign">,</span> 1<span class="sign">:</span>4<span class="sign">]</span><span class="sign">,</span> 0<span class="sign">,</span> agdata<span class="sign">$</span>delta<span class="sign">,</span> 1<span class="sign">,</span> 0<span class="sign">,</span> 
<span class="line_number">149 </span>        agdata<span class="sign">[</span><span class="sign">,</span> 8<span class="sign">:</span><span class="keyword">dim</span><span class="sign">(</span>agdata<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">]</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">150 </span>    <span class="keyword">colnames</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>5<span class="sign">:</span>8<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span><span class="quote">"time"</span><span class="sign">,</span> <span class="quote">"delta"</span><span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">)</span>
<span class="line_number">151 </span>    <span class="comment"># Rows in which a new event has occurred</span>
<span class="line_number">152 </span>    diffevent <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>c<span class="sign">(</span>TRUE<span class="sign">,</span> <span class="keyword">diff</span><span class="sign">(</span>agdata<span class="sign">$</span>i <span class="sign">*</span> 1000 <span class="sign">+</span> agdata<span class="sign">$</span>j<span class="sign">)</span> <span class="comment">!= 0) | </span>
<span class="line_number">153 </span>                  c<span class="sign">(</span>TRUE<span class="sign">,</span> agdata<span class="sign">$</span>delta<span class="sign">[</span> <span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>agdata<span class="sign">$</span>delta<span class="sign">)</span><span class="sign">]</span> <span class="sign">=</span><span class="sign">=</span> 1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">154 </span>    badind <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">155 </span>
<span class="line_number">156 </span>    <span class="comment"># Loop to compute discretization intervals</span>
<span class="line_number">157 </span>    <span class="keyword">for</span><span class="sign">(</span>ind in 1<span class="sign">:</span><span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">158 </span>    <span class="sign">{</span>
<span class="line_number">159 </span>        <span class="comment"># Reset last event start time</span>
<span class="line_number">160 </span>        <span class="keyword">if</span><span class="sign">(</span>diffevent<span class="sign">[</span>ind<span class="sign">]</span><span class="sign">)</span> <span class="sign">{</span>
<span class="line_number">161 </span>            lasteventtime <span class="sign">&lt;</span><span class="sign">-</span> agdata<span class="sign">$</span>start<span class="sign">[</span>ind<span class="sign">]</span>
<span class="line_number">162 </span>            smax <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">163 </span>        <span class="sign">}</span>
<span class="line_number">164 </span>       <span class="comment"># Interevent time is given by stop - start from agdata.</span>
<span class="line_number">165 </span>       <span class="keyword">if</span><span class="sign">(</span><span class="comment">!alternating){</span>
<span class="line_number">166 </span>            newtime <span class="sign">&lt;</span><span class="sign">-</span> agdata<span class="sign">$</span>stop<span class="sign">[</span>ind<span class="sign">]</span> <span class="sign">-</span> lasteventtime
<span class="line_number">167 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">168 </span>            newtime <span class="sign">&lt;</span><span class="sign">-</span> agdata<span class="sign">$</span>stop<span class="sign">[</span>ind<span class="sign">]</span> <span class="sign">-</span> agdata<span class="sign">$</span>start<span class="sign">[</span>ind<span class="sign">]</span>
<span class="line_number">169 </span>        <span class="sign">}</span>
<span class="line_number">170 </span>        r <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"r"</span><span class="sign">]</span>
<span class="line_number">171 </span>        datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"time"</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> newtime
<span class="line_number">172 </span>        <span class="comment"># Find the discretization intervals that the times fall into</span>
<span class="line_number">173 </span>        smin <span class="sign">&lt;</span><span class="sign">-</span> smax <span class="sign">+</span> 1
<span class="line_number">174 </span>        smax <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>as<span class="sign">[</span>r<span class="sign">,</span> <span class="sign">]</span> <span class="sign">&lt;</span> newtime<span class="sign">)</span> 
<span class="line_number">175 </span>        <span class="comment"># Most of the time, smin &lt;= smax, however, if both start and stop times</span>
<span class="line_number">176 </span>        <span class="comment"># fall into the same interval, this needs to be fixed</span>
<span class="line_number">177 </span>        <span class="keyword">if</span><span class="sign">(</span>smin <span class="sign">&gt;</span> smax<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">178 </span>            smin <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind <span class="sign">-</span> 1<span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">]</span>
<span class="line_number">179 </span>            badind <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>badind<span class="sign">,</span> ind <span class="sign">-</span> 1<span class="sign">)</span>
<span class="line_number">180 </span>            timediff0 <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">[</span>r<span class="sign">,</span> datamat<span class="sign">[</span>ind <span class="sign">-</span> 1<span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">]</span> <span class="sign">+</span> 1<span class="sign">]</span> <span class="sign">-</span> 
<span class="line_number">181 </span>                         as<span class="sign">[</span>r<span class="sign">,</span> datamat<span class="sign">[</span>ind <span class="sign">-</span> 1<span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">]</span><span class="sign">]</span>
<span class="line_number">182 </span>            timediff1 <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">[</span>r<span class="sign">,</span> smax <span class="sign">+</span> 1<span class="sign">]</span> <span class="sign">-</span> as<span class="sign">[</span>r<span class="sign">,</span> smax<span class="sign">]</span>
<span class="line_number">183 </span>            datamat<span class="sign">[</span>ind<span class="sign">,</span> 9<span class="sign">:</span><span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>timediff0 <span class="sign">*</span> 
<span class="line_number">184 </span>                datamat<span class="sign">[</span>ind <span class="sign">-</span> 1<span class="sign">,</span> 9<span class="sign">:</span><span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">]</span> <span class="sign">+</span> timediff1 <span class="sign">*</span> 
<span class="line_number">185 </span>                datamat<span class="sign">[</span>ind<span class="sign">,</span> 9<span class="sign">:</span><span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">]</span><span class="sign">)</span> <span class="sign">/</span> <span class="sign">(</span>timediff0 <span class="sign">+</span> timediff1<span class="sign">)</span>
<span class="line_number">186 </span>        <span class="sign">}</span>
<span class="line_number">187 </span>        datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> smin
<span class="line_number">188 </span>        datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> smax
<span class="line_number">189 </span>
<span class="line_number">190 </span>    <span class="sign">}</span>
<span class="line_number">191 </span>    <span class="comment"># Remove bad entries</span>
<span class="line_number">192 </span>    <span class="keyword">if</span><span class="sign">(</span><span class="comment">!is.null(badind)) datamat &lt;- datamat[ - badind, ]</span>
<span class="line_number">193 </span>    
<span class="line_number">194 </span>    <span class="keyword">return</span><span class="sign">(</span>datamat<span class="sign">)</span>
<span class="line_number">195 </span><span class="sign">}</span>
</pre>

<hr />
<a name="utility2fA"></a>
<a name="robo67"></a><h2>utility/A [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo9">utility</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>A</strong> --- time in an interval
</pre>
<p class="item_name">FUNCTION</p>
<p>    Computes the amount of time in interval (a[r,s-1], a[r,s]) prior to time t
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">394 </span><strong>A</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>t<span class="sign">,</span> as<span class="sign">,</span> r<span class="sign">,</span> s<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    t      time
    as     matrix of breakpoints
    r      stratum
    s      interval
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">397 </span><span class="sign">{</span>
<span class="line_number">398 </span>    s <span class="sign">&lt;</span><span class="sign">-</span> s <span class="sign">+</span> 1
<span class="line_number">399 </span>    <span class="keyword">if</span><span class="sign">(</span>s <span class="sign">=</span><span class="sign">=</span> 0<span class="sign">)</span><span class="sign">{</span> <span class="keyword">return</span><span class="sign">(</span>0<span class="sign">)</span><span class="sign">}</span>
<span class="line_number">400 </span>    <span class="keyword">if</span><span class="sign">(</span>t <span class="sign">&lt;</span> as<span class="sign">[</span>r<span class="sign">,</span> s <span class="sign">-</span> 1<span class="sign">]</span><span class="sign">)</span><span class="sign">{</span> <span class="keyword">return</span><span class="sign">(</span>0<span class="sign">)</span><span class="sign">}</span>
<span class="line_number">401 </span>    <span class="keyword">if</span><span class="sign">(</span>t <span class="sign">&gt;</span><span class="sign">=</span> as<span class="sign">[</span>r<span class="sign">,</span> s<span class="sign">]</span><span class="sign">)</span><span class="sign">{</span> 
<span class="line_number">402 </span>    <span class="keyword">return</span><span class="sign">(</span>as<span class="sign">[</span>r<span class="sign">,</span> s<span class="sign">]</span> <span class="sign">-</span> as<span class="sign">[</span>r<span class="sign">,</span> s <span class="sign">-</span> 1<span class="sign">]</span><span class="sign">)</span> 
<span class="line_number">403 </span>    <span class="sign">}</span>
<span class="line_number">404 </span>    <span class="keyword">return</span><span class="sign">(</span>t <span class="sign">-</span> as<span class="sign">[</span>r<span class="sign">,</span> s <span class="sign">-</span> 1<span class="sign">]</span><span class="sign">)</span> 
<span class="line_number">405 </span><span class="sign">}</span>
</pre>

<hr />
<a name="utility2fab2g"></a>
<a name="robo68"></a><h2>utility/ab2g [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo9">utility</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>ab2g</strong> --- regression parameter conversion
</pre>
<p class="item_name">FUNCTION</p>
<p>    Convert alphas and betas into a single vector named gamma
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1357 </span><strong>ab2g</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>alphars<span class="sign">,</span> betahat<span class="sign">,</span> K<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    alphars    matrix of baseline hazard parameters 
    betahat    regression coefficient estimates 
    K          number of discretization intervals
</pre>
<p class="item_name">OUTPUTS</p>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1360 </span><span class="sign">{</span>
<span class="line_number">1361 </span>    gamma <span class="sign">&lt;</span><span class="sign">-</span> NULL
<span class="line_number">1362 </span>    <span class="keyword">for</span><span class="sign">(</span>r in 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>K<span class="sign">)</span><span class="sign">)</span> gamma <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>gamma<span class="sign">,</span> alphars<span class="sign">[</span>r<span class="sign">,</span> 1<span class="sign">:</span>K<span class="sign">[</span>r<span class="sign">]</span><span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1363 </span>    gamma <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>gamma<span class="sign">,</span> betahat<span class="sign">)</span>
<span class="line_number">1364 </span>    <span class="keyword">return</span><span class="sign">(</span>gamma<span class="sign">)</span>
<span class="line_number">1365 </span><span class="sign">}</span>
</pre>

<hr />
<a name="utility2fg2ab"></a>
<a name="robo69"></a><h2>utility/g2ab [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo9">utility</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>g2ab</strong> --- regression parameter conversion
</pre>
<p class="item_name">FUNCTION</p>
<p>   Extract alphars and betahat from a single vector named gamma
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1381 </span><strong>g2ab</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>gamma<span class="sign">,</span> K<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    gamma      vector containing all hazard and regression parameters
    K          number of discretization intervals
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    alphars    matrix of baseline hazard parameters 
    betahat    regression coefficient estimates 
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1384 </span><span class="sign">{</span>
<span class="line_number">1385 </span>    ind <span class="sign">&lt;</span><span class="sign">-</span> 1
<span class="line_number">1386 </span>    alphars <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>K<span class="sign">)</span><span class="sign">,</span> max<span class="sign">(</span>K<span class="sign">)</span> <span class="sign">+</span> 1<span class="sign">)</span>
<span class="line_number">1387 </span>    <span class="keyword">for</span><span class="sign">(</span>r in 1<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>K<span class="sign">)</span><span class="sign">)</span><span class="sign">{</span> 
<span class="line_number">1388 </span>        alphars<span class="sign">[</span>r<span class="sign">,</span> 1<span class="sign">:</span>K<span class="sign">[</span>r<span class="sign">]</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> gamma<span class="sign">[</span>ind<span class="sign">:</span><span class="sign">(</span>ind <span class="sign">+</span> K<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">1389 </span>        alphars<span class="sign">[</span>r<span class="sign">,</span> K<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> 1<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 100
<span class="line_number">1390 </span>        ind <span class="sign">&lt;</span><span class="sign">-</span> ind <span class="sign">+</span> K<span class="sign">[</span>r<span class="sign">]</span>
<span class="line_number">1391 </span>    <span class="sign">}</span>
<span class="line_number">1392 </span>    betahat <span class="sign">&lt;</span><span class="sign">-</span> gamma<span class="sign">[</span>ind<span class="sign">:</span><span class="keyword">length</span><span class="sign">(</span>gamma<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">1393 </span>    <span class="keyword">return</span><span class="sign">(</span><span class="keyword">list</span><span class="sign">(</span>alphars <span class="sign">=</span> alphars<span class="sign">,</span> betahat <span class="sign">=</span> betahat<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1394 </span><span class="sign">}</span>
</pre>

<hr />
<a name="utility2fmakeUijframe"></a>
<a name="robo70"></a><h2>utility/makeUijframe [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo9">utility</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    makeUijFrame --- Make Uijmat and Vijmat matrices
</pre>
<p class="item_name">FUNCTION</p>
<p>    Convert vectors of frailties into matrices 
    in order to make them addressable as U[i, j]
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">100 </span><strong>makeUijframe</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> Uij<span class="sign">,</span> Vij<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m      number of clusters
    Ji     cluster sizes
    Uij    vector of length m * Ji containing frailties for event 1
    Vij    vector of length m * Ji containing frailties for event 2
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    Uijmat     matrix of dimension m x max(Ji) containing entries of Uij
    Vijmat     matrix of dimension m x max(Ji) containing entries of Vij
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">103 </span><span class="sign">{</span>
<span class="line_number">104 </span>    <span class="comment"># Allocate matrix storage</span>
<span class="line_number">105 </span>    Uijmat <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> max<span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">106 </span>    Vijmat <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> max<span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">107 </span>    <span class="comment"># Fill matrices row by row</span>
<span class="line_number">108 </span>    <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span>m<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">109 </span>        Uijmat<span class="sign">[</span>i<span class="sign">,</span> 1<span class="sign">:</span>Ji<span class="sign">[</span>i<span class="sign">]</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> Uij<span class="sign">[</span><span class="sign">(</span>c<span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">cumsum</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">:</span><span class="sign">(</span>c<span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">cumsum</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">[</span>i <span class="sign">+</span> 1<span class="sign">]</span><span class="sign">)</span><span class="sign">]</span>
<span class="line_number">110 </span>        Vijmat<span class="sign">[</span>i<span class="sign">,</span> 1<span class="sign">:</span>Ji<span class="sign">[</span>i<span class="sign">]</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> Vij<span class="sign">[</span><span class="sign">(</span>c<span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">cumsum</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> 1<span class="sign">)</span><span class="sign">:</span><span class="sign">(</span>c<span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">cumsum</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">[</span>i <span class="sign">+</span> 1<span class="sign">]</span><span class="sign">)</span><span class="sign">]</span>
<span class="line_number">111 </span>    <span class="sign">}</span>
<span class="line_number">112 </span>    <span class="keyword">return</span><span class="sign">(</span><span class="keyword">list</span><span class="sign">(</span>Uijmat <span class="sign">=</span> Uijmat<span class="sign">,</span> Vijmat <span class="sign">=</span> Vijmat<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">113 </span><span class="sign">}</span>
</pre>

<hr />
<a name="ZZdebug2ffmakemrs"></a>
<a name="robo71"></a><h2>ZZdebug/fmakemrs [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo10">ZZdebug</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>fmakemrs</strong> --- terms for profile likelihood and gradient
</pre>
<p class="item_name">FUNCTION</p>
<p>    Wrapper for FORTRAN function <a href="../src/bivrec_f.html#robo24">fmkmrs</a>, drop-in replacement for <a href="#robo76">makemrs</a>.
    Never called because <a href="#robo34">fmkproflik2</a> and <a href="#robo33">fmkprofgr2</a> call the FORTRAN function
    directly, but kept in the codebase for debugging. 
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1466 </span><strong>fmakemrs</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> as<span class="sign">,</span> betahat<span class="sign">,</span> Uijmat<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m          number of clusters
    Ji         cluster sizes
    datamat    data matrix generated by <a href="#robo37">makedatamat</a> 
    as         matrix of discretization breakpoints 
    betahat    regression coefficient estimates 
    Uijmat     matrix of frailty estimates
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    mrs        matrix of terms needed by the profile likelihood
    mrsgr      array of terms needed by the profile gradient
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1469 </span><span class="sign">{</span>
<span class="line_number">1470 </span>    <span class="comment"># Format data for Fortran</span>
<span class="line_number">1471 </span>    mrs <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1472 </span>    mrsgr <span class="sign">&lt;</span><span class="sign">-</span> array<span class="sign">(</span>0<span class="sign">,</span> c<span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1473 </span>    covs <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>datamat<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 8<span class="sign">)</span>
<span class="line_number">1474 </span>    ncovs <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span>
<span class="line_number">1475 </span>    d <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span>    
<span class="line_number">1476 </span>    index <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span><span class="quote">"i"</span><span class="sign">,</span> <span class="quote">"j"</span><span class="sign">,</span> <span class="quote">"k"</span><span class="sign">,</span> <span class="quote">"r"</span><span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">)</span><span class="sign">]</span>
<span class="line_number">1477 </span>    times <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span><span class="sign">,</span> <span class="quote">"time"</span><span class="sign">]</span>  
<span class="line_number">1478 </span>    <span class="comment"># Submit to Fortran  </span>
<span class="line_number">1479 </span>    out <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">.</span>Fortran<span class="sign">(</span><span class="quote">"<a href="../src/bivrec_f.html#robo24">fmkmrs</a>"</span><span class="sign">,</span>
<span class="line_number">1480 </span>            betahat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1481 </span>            index <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>index<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1482 </span>            times <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>times<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1483 </span>            Z <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1484 </span>            as <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1485 </span>            Uijmat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Uijmat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1486 </span>            d <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>d<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1487 </span>            ncovs <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ncovs<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1488 </span>            nr <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1489 </span>            ns <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1490 </span>            m <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>m<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1491 </span>            maxj <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>max<span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1492 </span>            mrs <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>mrs<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1493 </span>            mrsgr <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>mrsgr<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1494 </span>            mkgr <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1495 </span>    <span class="comment"># Extract output</span>
<span class="line_number">1496 </span>    mrs <span class="sign">=</span> matrix<span class="sign">(</span>out<span class="sign">$</span>mrs<span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1497 </span>    mrsgr <span class="sign">=</span> array<span class="sign">(</span>out<span class="sign">$</span>mrsgr<span class="sign">,</span> c<span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1498 </span>    <span class="keyword">return</span><span class="sign">(</span><span class="keyword">list</span><span class="sign">(</span>mrs <span class="sign">=</span> mrs<span class="sign">,</span> mrsgr <span class="sign">=</span> mrsgr<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1499 </span><span class="sign">}</span>
</pre>

<hr />
<a name="ZZdebug2ffmkprofgr"></a>
<a name="robo72"></a><h2>ZZdebug/fmkprofgr [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo10">ZZdebug</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>fmkprofgr</strong> --- profile likelihood gradient
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute the gradient of the profile likelihood, conditional on the frailties
    and other parameters.
    This is superseded by the faster wrapper <a href="#robo34">fmkproflik2</a>, but is still in the
    code for debugging.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1701 </span><strong>fmkprofgr</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> betahat<span class="sign">,</span> datamat<span class="sign">,</span> as<span class="sign">,</span> Uijmat<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m          number of clusters
    Ji         cluster sizes
    betahat    regression coefficient estimates 
    datamat    data matrix generated by <a href="#robo37">makedatamat</a> 
    as         matrix of discretization breakpoints 
    Uijmat     matrix of frailty estimates
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    likgr      gradient of profile loglikelihood of betahat conditional 
               on the other parameters
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1704 </span><span class="sign">{</span>
<span class="line_number">1705 </span>    <span class="comment"># Prepare data for Fortran computation</span>
<span class="line_number">1706 </span>    gr <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1707 </span>    covs <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>datamat<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 8<span class="sign">)</span>
<span class="line_number">1708 </span>    ncovs <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span>
<span class="line_number">1709 </span>    d <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span>    
<span class="line_number">1710 </span>    index <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span><span class="quote">"i"</span><span class="sign">,</span> <span class="quote">"j"</span><span class="sign">,</span> <span class="quote">"k"</span><span class="sign">,</span> <span class="quote">"r"</span><span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">)</span><span class="sign">]</span>
<span class="line_number">1711 </span>    delta <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span><span class="sign">,</span> <span class="quote">"delta"</span><span class="sign">]</span>
<span class="line_number">1712 </span>    times <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span><span class="sign">,</span> <span class="quote">"time"</span><span class="sign">]</span>    
<span class="line_number">1713 </span>    <span class="comment"># Fortran call</span>
<span class="line_number">1714 </span>    out <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">.</span>Fortran<span class="sign">(</span><span class="quote">"<a href="../src/bivrec_f.html#robo28">fprofgr</a>"</span><span class="sign">,</span>
<span class="line_number">1715 </span>            betahat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1716 </span>            index <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>index<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1717 </span>            delta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>delta<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1718 </span>            times <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>times<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1719 </span>            Z <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1720 </span>            as <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1721 </span>            Uijmat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Uijmat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1722 </span>            d <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>d<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1723 </span>            ncovs <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ncovs<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1724 </span>            nr <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1725 </span>            ns <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1726 </span>            m <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>m<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1727 </span>            maxj <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>max<span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1728 </span>            gr <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>gr<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1729 </span>    <span class="keyword">return</span><span class="sign">(</span>out<span class="sign">$</span>gr<span class="sign">)</span>  
<span class="line_number">1730 </span><span class="sign">}</span>
</pre>

<hr />
<a name="ZZdebug2ffmkproflik"></a>
<a name="robo73"></a><h2>ZZdebug/fmkproflik [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo10">ZZdebug</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>fmkproflik</strong> --- compute profile likelihood
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute profile likelihood of regression parameters for a single process,
    conditional on the frailties and other parameters.
    This is superseded by the faster wrapper <a href="#robo34">fmkproflik2</a>, but is still in the
    code for debugging.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1567 </span><strong>fmkproflik</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> betahat<span class="sign">,</span> datamat<span class="sign">,</span> as<span class="sign">,</span> Uijmat<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m          number of clusters
    Ji         cluster sizes
    betahat    regression coefficient estimates 
    datamat    data matrix generated by <a href="#robo37">makedatamat</a> 
    as         matrix of discretization breakpoints 
    Uijmat     matrix of frailty estimates
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    loglik     profile loglikelihood of betahat conditional on the other parameters
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1570 </span><span class="sign">{</span>
<span class="line_number">1571 </span>    loglik <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">1572 </span>    covs <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>datamat<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 8<span class="sign">)</span>
<span class="line_number">1573 </span>    ncovs <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span>
<span class="line_number">1574 </span>    d <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span>    
<span class="line_number">1575 </span>    index <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span><span class="quote">"i"</span><span class="sign">,</span> <span class="quote">"j"</span><span class="sign">,</span> <span class="quote">"k"</span><span class="sign">,</span> <span class="quote">"r"</span><span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">)</span><span class="sign">]</span>
<span class="line_number">1576 </span>    delta <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span><span class="sign">,</span> <span class="quote">"delta"</span><span class="sign">]</span>
<span class="line_number">1577 </span>    times <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span><span class="sign">,</span> <span class="quote">"time"</span><span class="sign">]</span>    
<span class="line_number">1578 </span>    
<span class="line_number">1579 </span>    out <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">.</span>Fortran<span class="sign">(</span><span class="quote">"<a href="../src/bivrec_f.html#robo29">fproflik</a>"</span><span class="sign">,</span>
<span class="line_number">1580 </span>            betahat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1581 </span>            index <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>index<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1582 </span>            delta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>delta<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1583 </span>            time <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>times<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1584 </span>            Z <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1585 </span>            as <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1586 </span>            Uijmat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Uijmat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1587 </span>            d <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>d<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1588 </span>            ncovs <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ncovs<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1589 </span>            nr <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1590 </span>            ns <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1591 </span>            m <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>m<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1592 </span>            maxj <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>max<span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">1593 </span>            lik <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>loglik<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1594 </span>    <span class="keyword">return</span><span class="sign">(</span>out<span class="sign">$</span>lik<span class="sign">)</span>   
<span class="line_number">1595 </span><span class="sign">}</span>
</pre>

<hr />
<a name="ZZdebug2ffupdatefrailties3"></a>
<a name="robo74"></a><h2>ZZdebug/fupdatefrailties3 [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo10">ZZdebug</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>fupdatefrailties3</strong> --- update frailty estimates
</pre>
<p class="item_name">FUNCTION</p>
<p>    Drop-in replacement for <a href="#robo13">fupdatefrailties4</a>, which updates the frailties
    using only Fortran calls to low-level functionality like <a href="../src/bivrec_f.html#robo31">fsmuij</a>. See
    <a href="#robo13">fupdatefrailties4</a> for details.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">417 </span><strong>fupdatefrailties3</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> datamatd<span class="sign">,</span> alphars<span class="sign">,</span> alpharsd<span class="sign">,</span> as<span class="sign">,</span> asd<span class="sign">,</span> betahat<span class="sign">,</span> betadhat<span class="sign">,</span> dispparams<span class="sign">)</span>
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">420 </span><span class="sign">{</span>
<span class="line_number">421 </span>  <span class="comment">#  cat("\tUpdating frailty estimates\n")</span>
<span class="line_number">422 </span>        
<span class="line_number">423 </span>    <span class="comment">## Extract dispersion parameter estimates</span>
<span class="line_number">424 </span>    sigma2hat <span class="sign">&lt;</span><span class="sign">-</span> dispparams<span class="sign">$</span>sigma2hat
<span class="line_number">425 </span>    sigma2dhat <span class="sign">&lt;</span><span class="sign">-</span> dispparams<span class="sign">$</span>sigma2dhat
<span class="line_number">426 </span>    nu2hat <span class="sign">&lt;</span><span class="sign">-</span> dispparams<span class="sign">$</span>nu2hat
<span class="line_number">427 </span>    nu2dhat <span class="sign">&lt;</span><span class="sign">-</span> dispparams<span class="sign">$</span>nu2dhat
<span class="line_number">428 </span>    thetahat <span class="sign">&lt;</span><span class="sign">-</span> dispparams<span class="sign">$</span>thetahat
<span class="line_number">429 </span>    
<span class="line_number">430 </span>    <span class="comment">## Initialize frailty vectors</span>
<span class="line_number">431 </span>    Uihat <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span><span class="sign">;</span>Vihat <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">432 </span>    Uijhat <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>Vijhat <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">;</span>
<span class="line_number">433 </span>
<span class="line_number">434 </span>   <span class="comment">## Initialize matrices for storage of pi, qi, pij, qij, etc.</span>
<span class="line_number">435 </span>    jimax <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>Ji<span class="sign">)</span>
<span class="line_number">436 </span>    pi <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span><span class="sign">;</span>qi <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span><span class="sign">;</span>ri <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span><span class="sign">;</span>si <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span>
<span class="line_number">437 </span>    piprime <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span><span class="sign">;</span>qiprime <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">438 </span>    riprime <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span><span class="sign">;</span>siprime <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">439 </span>    wi <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">)</span>
<span class="line_number">440 </span>    pij <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>pijprime <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">441 </span>    qij <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>qijprime <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">442 </span>    rij <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>rijprime <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">443 </span>    sij <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>sijprime <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">444 </span>    wij <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>zij <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">445 </span>
<span class="line_number">446 </span>    Smu <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>Sdelta <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">447 </span>    Seta <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>SDelta <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">448 </span>  
<span class="line_number">449 </span>    covs <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>datamat<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 8<span class="sign">)</span>
<span class="line_number">450 </span>    ncovs <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span>
<span class="line_number">451 </span>    d <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span>
<span class="line_number">452 </span>    index <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span><span class="quote">"i"</span><span class="sign">,</span> <span class="quote">"j"</span><span class="sign">,</span> <span class="quote">"k"</span><span class="sign">,</span> <span class="quote">"r"</span><span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">)</span><span class="sign">]</span>
<span class="line_number">453 </span>    delta <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span><span class="sign">,</span> <span class="quote">"delta"</span><span class="sign">]</span>
<span class="line_number">454 </span>    
<span class="line_number">455 </span>    Sm <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span><span class="sign">.</span>Fortran<span class="sign">(</span><span class="quote">"<a href="../src/bivrec_f.html#robo31">fsmuij</a>"</span><span class="sign">,</span> 
<span class="line_number">456 </span>        betahat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">457 </span>        index <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>index<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">458 </span>        delta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>delta<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">459 </span>        Z <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">460 </span>        alphars <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>alphars<span class="sign">)</span><span class="sign">,</span> 
<span class="line_number">461 </span>        as <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">462 </span>        d <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>d<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">463 </span>        ncovs <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ncovs<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">464 </span>        nr <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>alphars<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">465 </span>        ns <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>alphars<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">466 </span>        m <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>m<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">467 </span>        maxj <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>max<span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">468 </span>        Smu <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Smu<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">469 </span>        Sdelta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Sdelta<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">470 </span>    Smu <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>Sm<span class="sign">$</span>Smu<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number">471 </span>    Sdelta <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>Sm<span class="sign">$</span>Sdelta<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number">472 </span>    
<span class="line_number">473 </span>    covs <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>datamatd<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamatd<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamatd<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 8<span class="sign">)</span>
<span class="line_number">474 </span>    ncovs <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span>
<span class="line_number">475 </span>    d <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span>
<span class="line_number">476 </span>    index <span class="sign">&lt;</span><span class="sign">-</span> datamatd<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span><span class="quote">"i"</span><span class="sign">,</span> <span class="quote">"j"</span><span class="sign">,</span> <span class="quote">"k"</span><span class="sign">,</span> <span class="quote">"r"</span><span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">)</span><span class="sign">]</span>
<span class="line_number">477 </span>    Delta <span class="sign">&lt;</span><span class="sign">-</span> datamatd<span class="sign">[</span><span class="sign">,</span> <span class="quote">"delta"</span><span class="sign">]</span>
<span class="line_number">478 </span>    
<span class="line_number">479 </span>    Se <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span><span class="sign">.</span>Fortran<span class="sign">(</span><span class="quote">"<a href="../src/bivrec_f.html#robo31">fsmuij</a>"</span><span class="sign">,</span>
<span class="line_number">480 </span>         betahat <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>betadhat<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">481 </span>         index <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>index<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">482 </span>         delta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Delta<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">483 </span>         Z <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>covs<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">484 </span>         alphars <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>alpharsd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">485 </span>         as <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>asd<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">486 </span>         d <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>d<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">487 </span>         ncovs <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>ncovs<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">488 </span>         nr <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>alpharsd<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">489 </span>         ns <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>alpharsd<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">490 </span>         m <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>m<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">491 </span>         maxj <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>max<span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span><span class="sign">,</span>
<span class="line_number">492 </span>         Smu <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Seta<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">493 </span>         Sdelta <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>SDelta<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">494 </span>    Seta <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>Se<span class="sign">$</span>Smu<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number">495 </span>    SDelta <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>Se<span class="sign">$</span>Sdelta<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span>
<span class="line_number">496 </span>
<span class="line_number">497 </span>    
<span class="line_number">498 </span>    <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span>m<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">499 </span>        <span class="keyword">for</span><span class="sign">(</span>j in 1<span class="sign">:</span>Ji<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">500 </span>            <a href="#robo81">Smuij</a> <span class="sign">&lt;</span><span class="sign">-</span> Smu<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span>
<span class="line_number">501 </span>            Setaij <span class="sign">&lt;</span><span class="sign">-</span> Seta<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span>
<span class="line_number">502 </span>            Sdeltaij <span class="sign">&lt;</span><span class="sign">-</span> Sdelta<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span>
<span class="line_number">503 </span>            SDeltaij <span class="sign">&lt;</span><span class="sign">-</span> SDelta<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span>
<span class="line_number">504 </span>            
<span class="line_number">505 </span>            wij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> nu2hat <span class="sign">-</span> thetahat<span class="sign">^</span>2 <span class="sign">*</span> Setaij <span class="sign">/</span> <span class="sign">(</span>1 <span class="sign">+</span> nu2dhat <span class="sign">*</span> Setaij<span class="sign">)</span>
<span class="line_number">506 </span>            zij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> nu2dhat <span class="sign">-</span> thetahat<span class="sign">^</span>2 <span class="sign">*</span> <a href="#robo81">Smuij</a> <span class="sign">/</span> <span class="sign">(</span>1 <span class="sign">+</span> nu2hat <span class="sign">*</span> <a href="#robo81">Smuij</a><span class="sign">)</span>
<span class="line_number">507 </span>            pij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo81">Smuij</a> <span class="sign">/</span> <span class="sign">(</span>1 <span class="sign">+</span> wij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">*</span> <a href="#robo81">Smuij</a><span class="sign">)</span>
<span class="line_number">508 </span>            qij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>thetahat <span class="sign">*</span> <a href="#robo81">Smuij</a> <span class="sign">*</span> Setaij <span class="sign">/</span> <span class="sign">(</span><span class="sign">(</span>1 <span class="sign">+</span> nu2hat <span class="sign">*</span> <a href="#robo81">Smuij</a><span class="sign">)</span> <span class="sign">*</span> 
<span class="line_number">509 </span>                <span class="sign">(</span>1 <span class="sign">+</span> nu2dhat <span class="sign">*</span> Setaij<span class="sign">)</span> <span class="sign">-</span> thetahat<span class="sign">^</span>2 <span class="sign">*</span> <a href="#robo81">Smuij</a> <span class="sign">*</span> Setaij<span class="sign">)</span>
<span class="line_number">510 </span>            rij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> qij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span>
<span class="line_number">511 </span>            sij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> Setaij <span class="sign">/</span> <span class="sign">(</span>1 <span class="sign">+</span> zij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">*</span> Setaij<span class="sign">)</span>
<span class="line_number">512 </span>            pijprime<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> Sdeltaij <span class="sign">/</span> <span class="sign">(</span>1 <span class="sign">+</span> wij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">*</span> <a href="#robo81">Smuij</a><span class="sign">)</span>
<span class="line_number">513 </span>            qijprime<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>thetahat <span class="sign">*</span> <a href="#robo81">Smuij</a> <span class="sign">*</span> SDeltaij <span class="sign">/</span> 
<span class="line_number">514 </span>                <span class="sign">(</span><span class="sign">(</span>1 <span class="sign">+</span> nu2hat <span class="sign">*</span> <a href="#robo81">Smuij</a><span class="sign">)</span> <span class="sign">*</span> <span class="sign">(</span>1 <span class="sign">+</span> nu2dhat <span class="sign">*</span> Setaij<span class="sign">)</span> <span class="sign">-</span> 
<span class="line_number">515 </span>                thetahat<span class="sign">^</span>2 <span class="sign">*</span> <a href="#robo81">Smuij</a> <span class="sign">*</span> Setaij<span class="sign">)</span>
<span class="line_number">516 </span>            rijprime<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>thetahat <span class="sign">*</span> Sdeltaij <span class="sign">*</span> Setaij <span class="sign">/</span> 
<span class="line_number">517 </span>                <span class="sign">(</span><span class="sign">(</span>1 <span class="sign">+</span> nu2hat <span class="sign">*</span> <a href="#robo81">Smuij</a><span class="sign">)</span> <span class="sign">*</span> <span class="sign">(</span>1 <span class="sign">+</span> nu2dhat <span class="sign">*</span> Setaij<span class="sign">)</span> <span class="sign">-</span> 
<span class="line_number">518 </span>                thetahat<span class="sign">^</span>2 <span class="sign">*</span> <a href="#robo81">Smuij</a> <span class="sign">*</span> Setaij<span class="sign">)</span>
<span class="line_number">519 </span>            sijprime<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> SDeltaij <span class="sign">/</span> <span class="sign">(</span>1 <span class="sign">+</span> zij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">*</span> Setaij<span class="sign">)</span>
<span class="line_number">520 </span>        <span class="sign">}</span>
<span class="line_number">521 </span>        <span class="comment">## Compute pi, qi, etc, as well as wi.</span>
<span class="line_number">522 </span>        piprime<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>pijprime<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">]</span><span class="sign">)</span>
<span class="line_number">523 </span>        qiprime<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>qijprime<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">]</span><span class="sign">)</span>
<span class="line_number">524 </span>        riprime<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>rijprime<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">]</span><span class="sign">)</span>
<span class="line_number">525 </span>        siprime<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>sijprime<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">]</span><span class="sign">)</span>
<span class="line_number">526 </span>        
<span class="line_number">527 </span>        pi<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>pij<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">]</span><span class="sign">)</span>
<span class="line_number">528 </span>        qi<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>qij<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">]</span><span class="sign">)</span>
<span class="line_number">529 </span>        ri<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>rij<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">]</span><span class="sign">)</span>
<span class="line_number">530 </span>        si<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>sij<span class="sign">[</span>i<span class="sign">,</span> <span class="sign">]</span><span class="sign">)</span>
<span class="line_number">531 </span>        
<span class="line_number">532 </span>        wi<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 1 <span class="sign">/</span> <span class="sign">(</span><span class="sign">(</span>1 <span class="sign">+</span> sigma2hat <span class="sign">*</span> pi<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span> 
<span class="line_number">533 </span>            <span class="sign">(</span>1 <span class="sign">+</span> sigma2dhat <span class="sign">*</span> si<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span> <span class="sign">-</span> sigma2hat <span class="sign">*</span> sigma2dhat <span class="sign">*</span> ri<span class="sign">[</span>i<span class="sign">]</span><span class="sign">^</span>2<span class="sign">)</span>
<span class="line_number">534 </span>    
<span class="line_number">535 </span>        <span class="comment">## Compute cluster frailty estimates</span>
<span class="line_number">536 </span>        Uihat<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 1 <span class="sign">+</span> sigma2hat <span class="sign">*</span> wi<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">*</span> <span class="sign">(</span><span class="sign">(</span>1 <span class="sign">+</span> sigma2dhat <span class="sign">*</span> si<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span> 
<span class="line_number">537 </span>            <span class="sign">(</span>piprime<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">-</span> pi<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> qiprime<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">-</span> qi<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span> <span class="sign">-</span> sigma2dhat <span class="sign">*</span> ri<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">*</span> 
<span class="line_number">538 </span>            <span class="sign">(</span>riprime<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">-</span> ri<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> siprime<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">-</span> si<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">539 </span>        Vihat<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 1 <span class="sign">+</span> sigma2dhat <span class="sign">*</span> wi<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">*</span> <span class="sign">(</span><span class="sign">(</span>1 <span class="sign">+</span> sigma2hat <span class="sign">*</span> pi<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span>
<span class="line_number">540 </span>            <span class="sign">(</span>riprime<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">-</span> ri<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> siprime<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">-</span> si<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span> <span class="sign">-</span> sigma2hat <span class="sign">*</span> ri<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">*</span>
<span class="line_number">541 </span>            <span class="sign">(</span>piprime<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">-</span> pi<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> qiprime<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">-</span> qi<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">542 </span>        
<span class="line_number">543 </span>        <span class="comment">## Compute individual frailty estimates</span>
<span class="line_number">544 </span>        Jicum <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">cumsum</span><span class="sign">(</span>Ji<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">545 </span>        <span class="keyword">for</span><span class="sign">(</span>j in 1<span class="sign">:</span>jimax<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">546 </span>            Uijhat<span class="sign">[</span>Jicum<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> Uihat<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">-</span> <span class="sign">(</span>nu2hat <span class="sign">*</span> pij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> thetahat <span class="sign">*</span>
<span class="line_number">547 </span>                rij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span> Uihat<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">-</span> <span class="sign">(</span>nu2hat <span class="sign">*</span> qij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> thetahat <span class="sign">*</span> sij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span>
<span class="line_number">548 </span>                Vihat<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> nu2hat <span class="sign">*</span> <span class="sign">(</span>pijprime<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> qijprime<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span><span class="sign">)</span> <span class="sign">+</span> thetahat <span class="sign">*</span>
<span class="line_number">549 </span>                <span class="sign">(</span>rijprime<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> sijprime<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">550 </span>            Vijhat<span class="sign">[</span>Jicum<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> Vihat<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">-</span> <span class="sign">(</span>thetahat <span class="sign">*</span> qij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> nu2dhat <span class="sign">*</span>
<span class="line_number">551 </span>                sij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span> Vihat<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">-</span> <span class="sign">(</span>thetahat <span class="sign">*</span> pij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> nu2dhat <span class="sign">*</span> rij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span>
<span class="line_number">552 </span>                Uihat<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">+</span> thetahat <span class="sign">*</span> <span class="sign">(</span>pijprime<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> qijprime<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span><span class="sign">)</span> <span class="sign">+</span> nu2dhat <span class="sign">*</span>
<span class="line_number">553 </span>                <span class="sign">(</span>rijprime<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> sijprime<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">554 </span>        <span class="sign">}</span>      
<span class="line_number">555 </span>    <span class="sign">}</span>
<span class="line_number">556 </span>    
<span class="line_number">557 </span>    Uijhat<span class="sign">[</span>Uijhat<span class="sign">&lt;</span><span class="sign">.</span>01<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">.</span>01<span class="sign">;</span> Vijhat<span class="sign">[</span>Vijhat <span class="sign">&lt;</span> 0<span class="sign">.</span>01<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">.</span>01
<span class="line_number">558 </span>    
<span class="line_number">559 </span>    Uijframe <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo70">makeUijframe</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> Uijhat<span class="sign">,</span> Vijhat<span class="sign">)</span>
<span class="line_number">560 </span>    
<span class="line_number">561 </span>    <span class="keyword">cat</span><span class="sign">(</span><span class="quote">"mean(Uijhat): "</span><span class="sign">,</span> mean<span class="sign">(</span>Uijhat<span class="sign">)</span><span class="sign">,</span> <span class="quote">"   mean(Vijhat): "</span><span class="sign">,</span> mean<span class="sign">(</span>Vijhat<span class="sign">)</span><span class="sign">,</span> <span class="quote">"\n"</span><span class="sign">)</span>
<span class="line_number">562 </span>    <span class="keyword">if</span><span class="sign">(</span>mean<span class="sign">(</span>Uijhat<span class="sign">)</span><span class="sign">&lt;</span><span class="sign">.</span>5 <span class="sign">|</span> mean<span class="sign">(</span>Vijhat<span class="sign">)</span><span class="sign">&lt;</span><span class="sign">.</span>5<span class="sign">)</span> browser<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">563 </span>
<span class="line_number">564 </span>    <span class="keyword">return</span><span class="sign">(</span><span class="keyword">list</span><span class="sign">(</span>Uihat <span class="sign">=</span> Uihat<span class="sign">,</span>
<span class="line_number">565 </span>                Vihat <span class="sign">=</span> Vihat<span class="sign">,</span>
<span class="line_number">566 </span>                Uijhat <span class="sign">=</span> Uijhat<span class="sign">,</span>
<span class="line_number">567 </span>                Vijhat <span class="sign">=</span> Vijhat<span class="sign">,</span>
<span class="line_number">568 </span>                pqrs <span class="sign">=</span> <span class="keyword">list</span><span class="sign">(</span>pij <span class="sign">=</span> pij<span class="sign">,</span> qij <span class="sign">=</span> qij<span class="sign">,</span> rij <span class="sign">=</span> rij<span class="sign">,</span> sij <span class="sign">=</span> sij<span class="sign">,</span>
<span class="line_number">569 </span>                    pijprime <span class="sign">=</span> pijprime<span class="sign">,</span> qijprime <span class="sign">=</span> qijprime<span class="sign">,</span>
<span class="line_number">570 </span>                    rijprime <span class="sign">=</span> rijprime<span class="sign">,</span> sijprime <span class="sign">=</span> sijprime<span class="sign">,</span>
<span class="line_number">571 </span>                    pi <span class="sign">=</span> pi<span class="sign">,</span> qi <span class="sign">=</span> qi<span class="sign">,</span> ri <span class="sign">=</span> ri<span class="sign">,</span> si <span class="sign">=</span> si<span class="sign">,</span>
<span class="line_number">572 </span>                    piprime <span class="sign">=</span> piprime<span class="sign">,</span> qiprime <span class="sign">=</span> qiprime<span class="sign">,</span>
<span class="line_number">573 </span>                    riprime <span class="sign">=</span> riprime<span class="sign">,</span> siprime <span class="sign">=</span> siprime<span class="sign">,</span>
<span class="line_number">574 </span>                    wi <span class="sign">=</span> wi<span class="sign">,</span> zij <span class="sign">=</span> zij<span class="sign">,</span> wij <span class="sign">=</span> wij<span class="sign">)</span><span class="sign">,</span>
<span class="line_number">575 </span>                Uijframe <span class="sign">=</span> Uijframe<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">576 </span><span class="sign">}</span>
</pre>

<hr />
<a name="ZZdebug2fmakealphars2"></a>
<a name="robo75"></a><h2>ZZdebug/makealphars2 [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo10">ZZdebug</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>makealphars2</strong> --- make baseline hazard
</pre>
<p class="item_name">FUNCTION</p>
<p>   Compute the MLEs for the baseline hazard parameters alphars, 
   given estimates of regression parameters andf frailties, for
   a single recurrent event process.
</p>

<p>   This is never called, and is for debugging purposes only. See
   fmkalphars2 and the Fortran implementation.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">210 </span><strong>makealphars2</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> betahat<span class="sign">,</span> as<span class="sign">,</span> Uijmat<span class="sign">)</span>
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">213 </span><span class="sign">{</span>
<span class="line_number">214 </span>    <span class="comment"># Allocate storage space</span>
<span class="line_number">215 </span>    alphars <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">216 </span>    <span class="comment"># drs will contain the numerator, Srs the denominator</span>
<span class="line_number">217 </span>    drs <span class="sign">&lt;</span><span class="sign">-</span> alphars
<span class="line_number">218 </span>    Srs <span class="sign">&lt;</span><span class="sign">-</span> alphars
<span class="line_number">219 </span>    
<span class="line_number">220 </span>    <span class="keyword">for</span><span class="sign">(</span>ind in 1<span class="sign">:</span><span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">221 </span>        i <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"i"</span><span class="sign">]</span>
<span class="line_number">222 </span>        j <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"j"</span><span class="sign">]</span>
<span class="line_number">223 </span>        k <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"k"</span><span class="sign">]</span>
<span class="line_number">224 </span>        smin <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">]</span>
<span class="line_number">225 </span>        smax <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">]</span>
<span class="line_number">226 </span>        r <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"r"</span><span class="sign">]</span>
<span class="line_number">227 </span>        time <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"time"</span><span class="sign">]</span>
<span class="line_number">228 </span>        Z <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span>
<span class="line_number">229 </span>        <span class="comment"># the numerator is just the sum of the event indicators</span>
<span class="line_number">230 </span>        drs<span class="sign">[</span>r<span class="sign">,</span> smax<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> drs<span class="sign">[</span>r<span class="sign">,</span> smax<span class="sign">]</span> <span class="sign">+</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"delta"</span><span class="sign">]</span>
<span class="line_number">231 </span>        <span class="comment"># Computing the denominator requires looping over all at - risk intervals</span>
<span class="line_number">232 </span>        <span class="keyword">for</span><span class="sign">(</span>s in smin<span class="sign">:</span>smax<span class="sign">)</span> 
<span class="line_number">233 </span>            Srs<span class="sign">[</span>r<span class="sign">,</span> s<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> Srs<span class="sign">[</span>r<span class="sign">,</span> s<span class="sign">]</span> <span class="sign">+</span> Uijmat<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">*</span> 
<span class="line_number">234 </span>            <span class="keyword">exp</span><span class="sign">(</span>as<span class="sign">.</span>matrix<span class="sign">(</span>Z<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>as<span class="sign">.</span>matrix<span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">)</span> <span class="sign">*</span> <a href="../src/bivrec_f.html#robo20">A</a><span class="sign">(</span>time<span class="sign">,</span> as<span class="sign">,</span> r<span class="sign">,</span> s<span class="sign">)</span>
<span class="line_number">235 </span>    <span class="sign">}</span>
<span class="line_number">236 </span>    alphars <span class="sign">&lt;</span><span class="sign">-</span> drs <span class="sign">/</span> Srs
<span class="line_number">237 </span>    alphars<span class="sign">[</span>is<span class="sign">.</span>nan<span class="sign">(</span>alphars<span class="sign">)</span><span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 100 <span class="comment"># Not needed since bugs fixed!</span>
<span class="line_number">238 </span>    <span class="keyword">return</span><span class="sign">(</span>alphars<span class="sign">)</span>  
<span class="line_number">239 </span><span class="sign">}</span>
</pre>

<hr />
<a name="ZZdebug2fmakemrs"></a>
<a name="robo76"></a><h2>ZZdebug/makemrs [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo10">ZZdebug</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>makemrs</strong> --- terms for profile likelihood
</pre>
<p class="item_name">FUNCTION</p>
<p>     Compute terms needed in the profile likelihood and gradient.
     This is an R implementation of the FORTRAN routine <a href="../src/bivrec_f.html#robo24">fmkmrs</a>, used for 
     debugging only.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1416 </span><strong>makemrs</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> as<span class="sign">,</span> betahat<span class="sign">,</span> Uijmat<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m          number of clusters
    Ji         cluster sizes
    datamat    data matrix generated by <a href="#robo37">makedatamat</a> 
    as         matrix of discretization breakpoints 
    betahat    regression coefficient estimates 
    Uijmat     matrix of frailty estimates
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    mrs        matrix of terms needed by the profile likelihood
    mrsgr      array of terms needed by the profile gradient
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1419 </span><span class="sign">{</span>
<span class="line_number">1420 </span>    <span class="comment"># Initialize matrices</span>
<span class="line_number">1421 </span>    mrs <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 1<span class="sign">)</span>
<span class="line_number">1422 </span>    mrsgr <span class="sign">&lt;</span><span class="sign">-</span> array<span class="sign">(</span>0<span class="sign">,</span> c<span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 1<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1423 </span>    covs <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>matrix<span class="sign">(</span>datamat<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span>c<span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1424 </span>    <span class="comment"># Loop through the data matrix</span>
<span class="line_number">1425 </span>    <span class="keyword">for</span><span class="sign">(</span>ind in 1<span class="sign">:</span><span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1426 </span>    <span class="sign">{</span>
<span class="line_number">1427 </span>        i <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"i"</span><span class="sign">]</span>
<span class="line_number">1428 </span>        j <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"j"</span><span class="sign">]</span>
<span class="line_number">1429 </span>        k <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"k"</span><span class="sign">]</span>
<span class="line_number">1430 </span>        smax <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">]</span>
<span class="line_number">1431 </span>        smin <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">]</span>
<span class="line_number">1432 </span>        r <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"r"</span><span class="sign">]</span>
<span class="line_number">1433 </span>        time <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"time"</span><span class="sign">]</span>
<span class="line_number">1434 </span>        <span class="keyword">for</span><span class="sign">(</span>s in smin<span class="sign">:</span>smax<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1435 </span>            <span class="comment"># At each entry in the data matrix, add the term to the </span>
<span class="line_number">1436 </span>            <span class="comment"># appropriate component of the output matrices</span>
<span class="line_number">1437 </span>            pred <span class="sign">&lt;</span><span class="sign">-</span> Uijmat<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">*</span> <span class="keyword">exp</span><span class="sign">(</span>as<span class="sign">.</span>matrix<span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>covs<span class="sign">[</span>ind<span class="sign">,</span> <span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span> 
<span class="line_number">1438 </span>                <a href="../src/bivrec_f.html#robo20">A</a><span class="sign">(</span>time<span class="sign">,</span> as<span class="sign">,</span> r<span class="sign">,</span> s<span class="sign">)</span>
<span class="line_number">1439 </span>            mrs<span class="sign">[</span>r<span class="sign">,</span> s<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> mrs<span class="sign">[</span>r<span class="sign">,</span> s<span class="sign">]</span> <span class="sign">+</span> pred
<span class="line_number">1440 </span>            mrsgr<span class="sign">[</span>r<span class="sign">,</span> s<span class="sign">,</span> <span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> mrsgr<span class="sign">[</span>r<span class="sign">,</span> s<span class="sign">,</span> <span class="sign">]</span> <span class="sign">+</span> covs<span class="sign">[</span>ind<span class="sign">,</span> <span class="sign">]</span> <span class="sign">*</span> pred
<span class="line_number">1441 </span>        <span class="sign">}</span>
<span class="line_number">1442 </span>    <span class="sign">}</span>
<span class="line_number">1443 </span>    <span class="comment"># Format for output</span>
<span class="line_number">1444 </span>    <span class="keyword">return</span><span class="sign">(</span><span class="keyword">list</span><span class="sign">(</span>mrs <span class="sign">=</span> mrs<span class="sign">,</span> mrsgr <span class="sign">=</span> mrsgr<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1445 </span><span class="sign">}</span>
</pre>

<hr />
<a name="ZZdebug2fmakeSens2"></a>
<a name="robo77"></a><h2>ZZdebug/makeSens2 [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo10">ZZdebug</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>makeSens2</strong> -- construct sensitivity matrix
</pre>
<p class="item_name">FUNCTION</p>
<p>    Construct the sensitivity matrix at the end of the procedure. This is an R
    implementation of the <a href="../src/bivrec_f.html#robo25">fmksens2</a> FORTRAN routine used for debugging.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1913 </span><strong>makeSens2</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> datamatd<span class="sign">,</span> alphars<span class="sign">,</span> alpharsd<span class="sign">,</span> betahat<span class="sign">,</span> betadhat<span class="sign">,</span>
<span class="line_number">1914 </span>            as<span class="sign">,</span> asd<span class="sign">,</span> frailtyoutput<span class="sign">,</span> dispersionoutput<span class="sign">,</span> K<span class="sign">,</span> Kd<span class="sign">,</span> full <span class="sign">=</span> FALSE<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m              number of clusters
    Ji             cluster sizes
    datamat        data matrix generated by <a href="#robo37">makedatamat</a> for event 1
    datamatd       data matrix generated by <a href="#robo37">makedatamat</a> for event 2
    alphars            matrix of baseline hazard parameters for event 1
    alpharsd           matrix of baseline hazard parameters for event 2
    betahat            regression coefficient estimates for event 
    betadhat           regression coefficient estimates for event 2
    as                 matrix of discretization breakpoints for event 1
    asd                matrix of discretization breakpoints for event 2
    frailtyoutput  output from <a href="#robo13">fupdatefrailties4</a>
    dispersionoutput  output from one of the dispersion <a href="#robo6">estimation</a> routines
    K                  number of discretization intervals for event 1
    Kd                 number of discretization intervals for event 2
    full           boolean indicating whether full matrix should be computed.
                   If FALSE, only the sensitivity for betahat is returned. 
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    S              Sensitivity matrix
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1917 </span><span class="sign">{</span>
<span class="line_number">1918 </span>    <span class="comment"># Extract intermediate values from output</span>
<span class="line_number">1919 </span>    pi <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>pi<span class="sign">;</span> qi <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>qi<span class="sign">;</span>
<span class="line_number">1920 </span>    ri <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>ri<span class="sign">;</span> si <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>si<span class="sign">;</span>
<span class="line_number">1921 </span>    wij <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>wij<span class="sign">;</span>zij <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>zij<span class="sign">;</span>
<span class="line_number">1922 </span>    wi <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>pqrs<span class="sign">$</span>wi
<span class="line_number">1923 </span>    sigma2hat <span class="sign">&lt;</span><span class="sign">-</span> dispersionoutput<span class="sign">$</span>sigma2hat<span class="sign">;</span>
<span class="line_number">1924 </span>    sigma2dhat <span class="sign">&lt;</span><span class="sign">-</span> dispersionoutput<span class="sign">$</span>sigma2dhat
<span class="line_number">1925 </span>    nu2hat <span class="sign">&lt;</span><span class="sign">-</span> dispersionoutput<span class="sign">$</span>nu2hat<span class="sign">;</span> nu2dhat <span class="sign">&lt;</span><span class="sign">-</span> dispersionoutput<span class="sign">$</span>nu2dhat
<span class="line_number">1926 </span>    thetahat <span class="sign">&lt;</span><span class="sign">-</span> dispersionoutput<span class="sign">$</span>thetahat
<span class="line_number">1927 </span>   
<span class="line_number">1928 </span>    ncovs <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">length</span><span class="sign">(</span>betahat<span class="sign">)</span>
<span class="line_number">1929 </span>
<span class="line_number">1930 </span>    Kcum <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">cumsum</span><span class="sign">(</span>c<span class="sign">(</span>1<span class="sign">,</span> K<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1931 </span>    Kdcum <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">cumsum</span><span class="sign">(</span>c<span class="sign">(</span>1<span class="sign">,</span> Kd<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1932 </span>    <span class="keyword">if</span><span class="sign">(</span>full<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1933 </span>        betaind <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>K<span class="sign">)</span> <span class="sign">+</span> 1<span class="sign">:</span>ncovs
<span class="line_number">1934 </span>        betadind <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">sum</span><span class="sign">(</span>Kd<span class="sign">)</span> <span class="sign">+</span> 1<span class="sign">:</span>ncovs
<span class="line_number">1935 </span>    <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">1936 </span>        betaind <span class="sign">&lt;</span><span class="sign">-</span> 1<span class="sign">:</span>ncovs
<span class="line_number">1937 </span>        betadind <span class="sign">&lt;</span><span class="sign">-</span> 1<span class="sign">:</span>ncovs
<span class="line_number">1938 </span>    <span class="sign">}</span>
<span class="line_number">1939 </span>    
<span class="line_number">1940 </span>    <span class="comment"># Allocate storage</span>
<span class="line_number">1941 </span>    <span class="keyword">if</span><span class="sign">(</span>full<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1942 </span>    S <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">(</span>K<span class="sign">)</span> <span class="sign">+</span> <span class="keyword">sum</span><span class="sign">(</span>Kd<span class="sign">)</span> <span class="sign">+</span> 2 <span class="sign">*</span> ncovs<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">(</span>K<span class="sign">)</span> <span class="sign">+</span> <span class="keyword">sum</span><span class="sign">(</span>Kd<span class="sign">)</span> <span class="sign">+</span> 2 <span class="sign">*</span> ncovs<span class="sign">)</span>
<span class="line_number">1943 </span>    <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">1944 </span>    S <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> 2 <span class="sign">*</span> ncovs<span class="sign">,</span> 2 <span class="sign">*</span> ncovs<span class="sign">)</span>
<span class="line_number">1945 </span>    <span class="sign">}</span>
<span class="line_number">1946 </span>    
<span class="line_number">1947 </span>    <span class="comment"># The sensitivity matrix is expressed as the sum of matrices corresponding</span>
<span class="line_number">1948 </span>    <span class="comment"># to each cluster</span>
<span class="line_number">1949 </span>    <span class="keyword">for</span><span class="sign">(</span>i in 1<span class="sign">:</span>m<span class="sign">)</span>
<span class="line_number">1950 </span>    <span class="sign">{</span>    
<span class="line_number">1951 </span>        <span class="comment"># Allocate storage for intermediate matrices</span>
<span class="line_number">1952 </span>        <a href="#robo81">Smuij</a> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> Ji<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">;</span> Setaij <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> Ji<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1953 </span>        <span class="keyword">if</span><span class="sign">(</span>full<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1954 </span>            Smuxij <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> Ji<span class="sign">[</span>i<span class="sign">]</span><span class="sign">,</span> <span class="keyword">sum</span><span class="sign">(</span>K<span class="sign">)</span> <span class="sign">+</span> ncovs<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1955 </span>            Setaxijd <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> Ji<span class="sign">[</span>i<span class="sign">]</span><span class="sign">,</span> <span class="keyword">sum</span><span class="sign">(</span>Kd<span class="sign">)</span> <span class="sign">+</span> ncovs<span class="sign">)</span>
<span class="line_number">1956 </span>            S11 <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">(</span>K<span class="sign">)</span> <span class="sign">+</span> ncovs<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">(</span>K<span class="sign">)</span> <span class="sign">+</span> ncovs<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1957 </span>            S12 <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">(</span>K<span class="sign">)</span> <span class="sign">+</span> ncovs<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">(</span>Kd<span class="sign">)</span> <span class="sign">+</span> ncovs<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1958 </span>            S13 <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">(</span>Kd<span class="sign">)</span> <span class="sign">+</span> ncovs<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">(</span>Kd<span class="sign">)</span> <span class="sign">+</span> ncovs<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1959 </span>            S21 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">(</span>K<span class="sign">)</span> <span class="sign">+</span> ncovs<span class="sign">)</span><span class="sign">;</span> S22 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">(</span>Kd<span class="sign">)</span> <span class="sign">+</span> ncovs<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1960 </span>            S31 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">(</span>K<span class="sign">)</span> <span class="sign">+</span> ncovs<span class="sign">)</span><span class="sign">;</span> S32 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">sum</span><span class="sign">(</span>Kd<span class="sign">)</span> <span class="sign">+</span> ncovs<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1961 </span>        <span class="sign">}</span><span class="keyword">else</span><span class="sign">{</span>
<span class="line_number">1962 </span>            Smuxij <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> Ji<span class="sign">[</span>i<span class="sign">]</span><span class="sign">,</span> ncovs<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1963 </span>            Setaxijd <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> Ji<span class="sign">[</span>i<span class="sign">]</span><span class="sign">,</span> ncovs<span class="sign">)</span>
<span class="line_number">1964 </span>            S11 <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> ncovs<span class="sign">,</span> ncovs<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1965 </span>            S12 <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> ncovs<span class="sign">,</span> ncovs<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1966 </span>            S13 <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> ncovs<span class="sign">,</span> ncovs<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1967 </span>            S21 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> ncovs<span class="sign">)</span><span class="sign">;</span> S22 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> ncovs<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1968 </span>            S31 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> ncovs<span class="sign">)</span><span class="sign">;</span> S32 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> ncovs<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1969 </span>        <span class="sign">}</span>
<span class="line_number">1970 </span>                
<span class="line_number">1971 </span>        <span class="comment"># Find the index of the data matrices where cluster i begins</span>
<span class="line_number">1972 </span>        iind0 <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">(</span>i<span class="sign">,</span> datamat<span class="sign">[</span><span class="sign">,</span> <span class="quote">"i"</span><span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1973 </span>        <span class="keyword">if</span><span class="sign">(</span>i <span class="sign">&lt;</span> m<span class="sign">)</span> iind1 <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">(</span>i <span class="sign">+</span> 1<span class="sign">,</span> datamat<span class="sign">[</span><span class="sign">,</span> <span class="quote">"i"</span><span class="sign">]</span><span class="sign">)</span> <span class="keyword">else</span> 
<span class="line_number">1974 </span>            iind1 <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span> <span class="sign">+</span> 1
<span class="line_number">1975 </span>        iind0d <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">(</span>i<span class="sign">,</span> datamatd<span class="sign">[</span><span class="sign">,</span> <span class="quote">"i"</span><span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1976 </span>        <span class="keyword">if</span><span class="sign">(</span>i <span class="sign">&lt;</span> m<span class="sign">)</span> iind1d <span class="sign">&lt;</span><span class="sign">-</span> match<span class="sign">(</span>i <span class="sign">+</span> 1<span class="sign">,</span> datamatd<span class="sign">[</span><span class="sign">,</span> <span class="quote">"i"</span><span class="sign">]</span><span class="sign">)</span> <span class="keyword">else</span> 
<span class="line_number">1977 </span>            iind1d <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">dim</span><span class="sign">(</span>datamatd<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span> <span class="sign">+</span> 1
<span class="line_number">1978 </span>        
<span class="line_number">1979 </span>        <span class="comment"># Compute <a href="#robo81">Smuij</a>, Setaij, Smuxij, Setaxijd (first pass)</span>
<span class="line_number">1980 </span>        <span class="keyword">for</span><span class="sign">(</span>ind in iind0<span class="sign">:</span><span class="sign">(</span>iind1 <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1981 </span>        <span class="sign">{</span>
<span class="line_number">1982 </span>            Z <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> ncovs<span class="sign">,</span> 1<span class="sign">)</span>
<span class="line_number">1983 </span>            bZ <span class="sign">&lt;</span><span class="sign">-</span> t<span class="sign">(</span>Z<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>as<span class="sign">.</span>matrix<span class="sign">(</span>betahat<span class="sign">)</span>
<span class="line_number">1984 </span>            r <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"r"</span><span class="sign">]</span>
<span class="line_number">1985 </span>            smax <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">]</span>
<span class="line_number">1986 </span>            k <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"k"</span><span class="sign">]</span>
<span class="line_number">1987 </span>            j <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"j"</span><span class="sign">]</span>
<span class="line_number">1988 </span>            time <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"time"</span><span class="sign">]</span>
<span class="line_number">1989 </span>             <span class="keyword">if</span><span class="sign">(</span>smax <span class="sign">&gt;</span> 0<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1990 </span>                <span class="keyword">for</span><span class="sign">(</span>s in 1<span class="sign">:</span>smax<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1991 </span>                    mu <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>bZ<span class="sign">)</span> <span class="sign">*</span> alphars<span class="sign">[</span>r<span class="sign">,</span> s<span class="sign">]</span> <span class="sign">*</span> <a href="../src/bivrec_f.html#robo20">A</a><span class="sign">(</span>time<span class="sign">,</span> as<span class="sign">,</span> r<span class="sign">,</span> s<span class="sign">)</span>
<span class="line_number">1992 </span>                    <a href="#robo81">Smuij</a><span class="sign">[</span>j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo81">Smuij</a><span class="sign">[</span>j<span class="sign">]</span> <span class="sign">+</span> mu
<span class="line_number">1993 </span>                    Smuxij<span class="sign">[</span>j<span class="sign">,</span> betaind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> Smuxij<span class="sign">[</span>j<span class="sign">,</span> betaind<span class="sign">]</span> <span class="sign">+</span> mu <span class="sign">*</span> as<span class="sign">.</span>vector<span class="sign">(</span>Z<span class="sign">)</span>    
<span class="line_number">1994 </span>                    <span class="keyword">if</span><span class="sign">(</span>full<span class="sign">)</span> Smuxij<span class="sign">[</span>j<span class="sign">,</span> Kcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 
<span class="line_number">1995 </span>                        Smuxij<span class="sign">[</span>j<span class="sign">,</span> Kcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">+</span> mu        
<span class="line_number">1996 </span>                <span class="sign">}</span>
<span class="line_number">1997 </span>            <span class="sign">}</span>
<span class="line_number">1998 </span>        <span class="sign">}</span>
<span class="line_number">1999 </span>        <span class="keyword">for</span><span class="sign">(</span>ind in iind0d<span class="sign">:</span><span class="sign">(</span>iind1d <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2000 </span>        <span class="sign">{</span>     
<span class="line_number">2001 </span>            Z <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>datamatd<span class="sign">[</span>ind<span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> ncovs<span class="sign">,</span> 1<span class="sign">)</span>
<span class="line_number">2002 </span>            bdZ <span class="sign">&lt;</span><span class="sign">-</span> t<span class="sign">(</span>Z<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>as<span class="sign">.</span>matrix<span class="sign">(</span>betadhat<span class="sign">)</span>
<span class="line_number">2003 </span>            r <span class="sign">&lt;</span><span class="sign">-</span> datamatd<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"r"</span><span class="sign">]</span>
<span class="line_number">2004 </span>            smaxd <span class="sign">&lt;</span><span class="sign">-</span> datamatd<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">]</span>
<span class="line_number">2005 </span>            k <span class="sign">&lt;</span><span class="sign">-</span> datamatd<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"k"</span><span class="sign">]</span>
<span class="line_number">2006 </span>            j <span class="sign">&lt;</span><span class="sign">-</span> datamatd<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"j"</span><span class="sign">]</span>
<span class="line_number">2007 </span>            time <span class="sign">&lt;</span><span class="sign">-</span> datamatd<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"time"</span><span class="sign">]</span>
<span class="line_number">2008 </span>             <span class="keyword">if</span><span class="sign">(</span>smaxd <span class="sign">&gt;</span> 0<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2009 </span>                <span class="keyword">for</span><span class="sign">(</span>s in 1<span class="sign">:</span>smaxd<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2010 </span>                    eta <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>bdZ<span class="sign">)</span> <span class="sign">*</span> alpharsd<span class="sign">[</span>r<span class="sign">,</span> s<span class="sign">]</span> <span class="sign">*</span> <a href="../src/bivrec_f.html#robo20">A</a><span class="sign">(</span>time<span class="sign">,</span> asd<span class="sign">,</span> r<span class="sign">,</span> s<span class="sign">)</span>
<span class="line_number">2011 </span>                    Setaij<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> Setaij<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">+</span> eta
<span class="line_number">2012 </span>                    Setaxijd<span class="sign">[</span>j<span class="sign">,</span> betadind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> Setaxijd<span class="sign">[</span>j<span class="sign">,</span> betadind<span class="sign">]</span> <span class="sign">+</span> eta <span class="sign">*</span> as<span class="sign">.</span>vector<span class="sign">(</span>Z<span class="sign">)</span>
<span class="line_number">2013 </span>                    <span class="keyword">if</span><span class="sign">(</span>full<span class="sign">)</span> Setaxijd<span class="sign">[</span>j<span class="sign">,</span> Kdcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 
<span class="line_number">2014 </span>                        Setaxijd<span class="sign">[</span>j<span class="sign">,</span> Kdcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">+</span> eta        
<span class="line_number">2015 </span>                <span class="sign">}</span>
<span class="line_number">2016 </span>            <span class="sign">}</span>
<span class="line_number">2017 </span>        <span class="sign">}</span>  
<span class="line_number">2018 </span>        
<span class="line_number">2019 </span>        phi <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> Ji<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2020 </span>        <span class="keyword">for</span><span class="sign">(</span>j in 1<span class="sign">:</span>Ji<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2021 </span>            phi<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">(</span>1 <span class="sign">+</span> nu2hat <span class="sign">*</span> <a href="#robo81">Smuij</a><span class="sign">[</span>j<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span> <span class="sign">(</span>1 <span class="sign">+</span> nu2dhat <span class="sign">*</span> Setaij<span class="sign">[</span>j<span class="sign">]</span><span class="sign">)</span> <span class="sign">-</span> 
<span class="line_number">2022 </span>                thetahat<span class="sign">^</span>2 <span class="sign">*</span> <a href="#robo81">Smuij</a><span class="sign">[</span>j<span class="sign">]</span> <span class="sign">*</span> Setaij<span class="sign">[</span>j<span class="sign">]</span>
<span class="line_number">2023 </span>        <span class="sign">}</span>         
<span class="line_number">2024 </span>        
<span class="line_number">2025 </span>        
<span class="line_number">2026 </span>        <span class="comment">## Compute the various components of the matrix (second pass) </span>
<span class="line_number">2027 </span>        <span class="keyword">for</span><span class="sign">(</span>ind in iind0<span class="sign">:</span><span class="sign">(</span>iind1 <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2028 </span>        <span class="sign">{</span>
<span class="line_number">2029 </span>            Z <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> ncovs<span class="sign">,</span> 1<span class="sign">)</span>
<span class="line_number">2030 </span>            bZ <span class="sign">&lt;</span><span class="sign">-</span> t<span class="sign">(</span>Z<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>as<span class="sign">.</span>matrix<span class="sign">(</span>betahat<span class="sign">)</span>
<span class="line_number">2031 </span>            Z2 <span class="sign">&lt;</span><span class="sign">-</span> Z<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>t<span class="sign">(</span>Z<span class="sign">)</span>
<span class="line_number">2032 </span>            Z <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>vector<span class="sign">(</span>Z<span class="sign">)</span>
<span class="line_number">2033 </span>            r <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"r"</span><span class="sign">]</span>
<span class="line_number">2034 </span>            smax <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">]</span>
<span class="line_number">2035 </span>            k <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"k"</span><span class="sign">]</span>     
<span class="line_number">2036 </span>            j <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"j"</span><span class="sign">]</span>
<span class="line_number">2037 </span>            time <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"time"</span><span class="sign">]</span>
<span class="line_number">2038 </span>            <span class="keyword">if</span><span class="sign">(</span>smax <span class="sign">&gt;</span> 0<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2039 </span>                <span class="keyword">for</span><span class="sign">(</span>s in 1<span class="sign">:</span>smax<span class="sign">)</span><span class="sign">{</span>   
<span class="line_number">2040 </span>                    mu <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>bZ<span class="sign">)</span> <span class="sign">*</span> alphars<span class="sign">[</span>r<span class="sign">,</span> s<span class="sign">]</span> <span class="sign">*</span> <a href="../src/bivrec_f.html#robo20">A</a><span class="sign">(</span>time<span class="sign">,</span> as<span class="sign">,</span> r<span class="sign">,</span> s<span class="sign">)</span>
<span class="line_number">2041 </span>                    S11<span class="sign">[</span>betaind<span class="sign">,</span> betaind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> S11<span class="sign">[</span>betaind<span class="sign">,</span> betaind<span class="sign">]</span> <span class="sign">+</span> 
<span class="line_number">2042 </span>                        as<span class="sign">.</span>vector<span class="sign">(</span>mu<span class="sign">)</span> <span class="sign">*</span> Z2
<span class="line_number">2043 </span>                    <span class="keyword">if</span><span class="sign">(</span>full<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2044 </span>                        S11<span class="sign">[</span>Kcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">,</span> Kcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 
<span class="line_number">2045 </span>                            S11<span class="sign">[</span>Kcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">,</span> Kcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">+</span> mu
<span class="line_number">2046 </span>                        S11<span class="sign">[</span>Kcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">,</span> betaind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 
<span class="line_number">2047 </span>                            S11<span class="sign">[</span>Kcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">,</span> betaind<span class="sign">]</span> <span class="sign">+</span> mu <span class="sign">*</span> Z
<span class="line_number">2048 </span>                        S11<span class="sign">[</span>betaind<span class="sign">,</span> Kcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 
<span class="line_number">2049 </span>                            S11<span class="sign">[</span>betaind<span class="sign">,</span> Kcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">+</span> mu <span class="sign">*</span> Z
<span class="line_number">2050 </span>                    <span class="sign">}</span>
<span class="line_number">2051 </span>                    w <span class="sign">&lt;</span><span class="sign">-</span> 1 <span class="sign">/</span> <span class="sign">(</span>1 <span class="sign">+</span> wij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">*</span> <a href="#robo81">Smuij</a><span class="sign">[</span>j<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2052 </span>                    S21<span class="sign">[</span>betaind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> S21<span class="sign">[</span>betaind<span class="sign">]</span> <span class="sign">+</span> w <span class="sign">*</span> mu <span class="sign">*</span> Z
<span class="line_number">2053 </span>                    <span class="keyword">if</span><span class="sign">(</span>full<span class="sign">)</span> S21<span class="sign">[</span>Kcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> S21<span class="sign">[</span>Kcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">+</span> w <span class="sign">*</span> mu
<span class="line_number">2054 </span>                    
<span class="line_number">2055 </span>                    w<span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>thetahat <span class="sign">*</span> Setaij<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">/</span> phi<span class="sign">[</span>j<span class="sign">]</span>
<span class="line_number">2056 </span>                    S31<span class="sign">[</span>betaind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> S31<span class="sign">[</span>betaind<span class="sign">]</span> <span class="sign">+</span> w <span class="sign">*</span> mu <span class="sign">*</span> Z 
<span class="line_number">2057 </span>                    <span class="keyword">if</span><span class="sign">(</span>full<span class="sign">)</span> S31<span class="sign">[</span>Kcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> S31<span class="sign">[</span>Kcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">+</span> w <span class="sign">*</span> mu
<span class="line_number">2058 </span>                <span class="sign">}</span>
<span class="line_number">2059 </span>            <span class="sign">}</span>
<span class="line_number">2060 </span>        <span class="sign">}</span>
<span class="line_number">2061 </span>        <span class="keyword">for</span><span class="sign">(</span>ind in iind0d<span class="sign">:</span><span class="sign">(</span>iind1d <span class="sign">-</span> 1<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2062 </span>        <span class="sign">{</span>
<span class="line_number">2063 </span>           Z <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>datamatd<span class="sign">[</span>ind<span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> ncovs<span class="sign">,</span> 1<span class="sign">)</span>
<span class="line_number">2064 </span>           bdZ <span class="sign">&lt;</span><span class="sign">-</span> t<span class="sign">(</span>Z<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>as<span class="sign">.</span>matrix<span class="sign">(</span>betadhat<span class="sign">)</span>
<span class="line_number">2065 </span>           Z2 <span class="sign">&lt;</span><span class="sign">-</span> Z<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>t<span class="sign">(</span>Z<span class="sign">)</span>
<span class="line_number">2066 </span>           Z <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>vector<span class="sign">(</span>Z<span class="sign">)</span>
<span class="line_number">2067 </span>           r <span class="sign">&lt;</span><span class="sign">-</span> datamatd<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"r"</span><span class="sign">]</span>
<span class="line_number">2068 </span>           smaxd <span class="sign">&lt;</span><span class="sign">-</span> datamatd<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">]</span>
<span class="line_number">2069 </span>           k <span class="sign">&lt;</span><span class="sign">-</span> datamatd<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"k"</span><span class="sign">]</span>     
<span class="line_number">2070 </span>           j <span class="sign">&lt;</span><span class="sign">-</span> datamatd<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"j"</span><span class="sign">]</span>
<span class="line_number">2071 </span>           time <span class="sign">&lt;</span><span class="sign">-</span> datamatd<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"time"</span><span class="sign">]</span>
<span class="line_number">2072 </span>           <span class="keyword">if</span><span class="sign">(</span>smaxd <span class="sign">&gt;</span> 0<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2073 </span>                <span class="keyword">for</span><span class="sign">(</span>s in 1<span class="sign">:</span>smaxd<span class="sign">)</span><span class="sign">{</span>   
<span class="line_number">2074 </span>                    eta <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span>bdZ<span class="sign">)</span> <span class="sign">*</span> alpharsd<span class="sign">[</span>r<span class="sign">,</span> s<span class="sign">]</span> <span class="sign">*</span> <a href="../src/bivrec_f.html#robo20">A</a><span class="sign">(</span>time<span class="sign">,</span> asd<span class="sign">,</span> r<span class="sign">,</span> s<span class="sign">)</span>
<span class="line_number">2075 </span>                    S13<span class="sign">[</span>betadind<span class="sign">,</span> betadind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> S13<span class="sign">[</span>betadind<span class="sign">,</span> betadind<span class="sign">]</span> <span class="sign">+</span>
<span class="line_number">2076 </span>                        as<span class="sign">.</span>vector<span class="sign">(</span>eta<span class="sign">)</span> <span class="sign">*</span> Z2
<span class="line_number">2077 </span>                    <span class="keyword">if</span><span class="sign">(</span>full<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2078 </span>                        S13<span class="sign">[</span>Kdcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">,</span> Kdcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> 
<span class="line_number">2079 </span>                            S13<span class="sign">[</span>Kdcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">,</span> Kdcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">+</span> eta
<span class="line_number">2080 </span>                        S13<span class="sign">[</span>Kdcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">,</span> betadind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span>
<span class="line_number">2081 </span>                            S13<span class="sign">[</span>Kdcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">,</span> betadind<span class="sign">]</span> <span class="sign">+</span> eta <span class="sign">*</span> Z
<span class="line_number">2082 </span>                        S13<span class="sign">[</span>betadind<span class="sign">,</span> Kdcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span>
<span class="line_number">2083 </span>                            S13<span class="sign">[</span>betadind<span class="sign">,</span> Kdcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">+</span> eta <span class="sign">*</span> Z
<span class="line_number">2084 </span>                    <span class="sign">}</span>
<span class="line_number">2085 </span>                    w<span class="sign">&lt;</span><span class="sign">-</span> <span class="sign">-</span>thetahat <span class="sign">*</span> <a href="#robo81">Smuij</a><span class="sign">[</span>j<span class="sign">]</span> <span class="sign">/</span> phi<span class="sign">[</span>j<span class="sign">]</span>
<span class="line_number">2086 </span>                    S22<span class="sign">[</span>betadind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> S22<span class="sign">[</span>betadind<span class="sign">]</span> <span class="sign">+</span> w <span class="sign">*</span> eta <span class="sign">*</span> Z
<span class="line_number">2087 </span>                    <span class="keyword">if</span><span class="sign">(</span>full<span class="sign">)</span> S22<span class="sign">[</span>Kdcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> S22<span class="sign">[</span>Kdcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">+</span> w <span class="sign">*</span> eta
<span class="line_number">2088 </span>                    
<span class="line_number">2089 </span>                    w <span class="sign">&lt;</span><span class="sign">-</span> 1 <span class="sign">/</span> <span class="sign">(</span>1 <span class="sign">+</span> zij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">*</span> Setaij<span class="sign">[</span>j<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2090 </span>                    S32<span class="sign">[</span>betadind<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> S32<span class="sign">[</span>betadind<span class="sign">]</span> <span class="sign">+</span> w <span class="sign">*</span> eta <span class="sign">*</span> Z
<span class="line_number">2091 </span>                    <span class="keyword">if</span><span class="sign">(</span>full<span class="sign">)</span> S32<span class="sign">[</span>Kdcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> S32<span class="sign">[</span>Kdcum<span class="sign">[</span>r<span class="sign">]</span> <span class="sign">+</span> s <span class="sign">-</span> 1<span class="sign">]</span> <span class="sign">+</span> w <span class="sign">*</span> eta
<span class="line_number">2092 </span>                <span class="sign">}</span>
<span class="line_number">2093 </span>            <span class="sign">}</span>
<span class="line_number">2094 </span>        <span class="sign">}</span>
<span class="line_number">2095 </span>        
<span class="line_number">2096 </span>        <span class="keyword">for</span><span class="sign">(</span>j in 1<span class="sign">:</span>Ji<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">2097 </span>            S11 <span class="sign">&lt;</span><span class="sign">-</span> S11 <span class="sign">-</span> wij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">/</span> <span class="sign">(</span>1 <span class="sign">+</span> wij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">*</span> <a href="#robo81">Smuij</a><span class="sign">[</span>j<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span> 
<span class="line_number">2098 </span>                Smuxij<span class="sign">[</span>j<span class="sign">,</span> <span class="sign">]</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>t<span class="sign">(</span>Smuxij<span class="sign">[</span>j<span class="sign">,</span> <span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2099 </span>            S12 <span class="sign">&lt;</span><span class="sign">-</span> S12 <span class="sign">-</span> thetahat <span class="sign">/</span> phi<span class="sign">[</span>j<span class="sign">]</span> <span class="sign">*</span> Smuxij<span class="sign">[</span>j<span class="sign">,</span> <span class="sign">]</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>t<span class="sign">(</span>Setaxijd<span class="sign">[</span>j<span class="sign">,</span> <span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2100 </span>            S13 <span class="sign">&lt;</span><span class="sign">-</span> S13 <span class="sign">-</span> zij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">/</span> <span class="sign">(</span>1 <span class="sign">+</span> zij<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">*</span> Setaij<span class="sign">[</span>j<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span> 
<span class="line_number">2101 </span>                Setaxijd<span class="sign">[</span>j<span class="sign">,</span> <span class="sign">]</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>t<span class="sign">(</span>Setaxijd<span class="sign">[</span>j<span class="sign">,</span> <span class="sign">]</span><span class="sign">)</span>
<span class="line_number">2102 </span>        <span class="sign">}</span>
<span class="line_number">2103 </span>        
<span class="line_number">2104 </span>        S2 <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>S21<span class="sign">,</span> S22<span class="sign">)</span>
<span class="line_number">2105 </span>        S3 <span class="sign">&lt;</span><span class="sign">-</span> c<span class="sign">(</span>S31<span class="sign">,</span> S32<span class="sign">)</span>
<span class="line_number">2106 </span>                
<span class="line_number">2107 </span>        S <span class="sign">&lt;</span><span class="sign">-</span> S <span class="sign">-</span> <span class="keyword">rbind</span><span class="sign">(</span><span class="keyword">cbind</span><span class="sign">(</span>S11<span class="sign">,</span> S12<span class="sign">)</span><span class="sign">,</span> <span class="keyword">cbind</span><span class="sign">(</span>t<span class="sign">(</span>S12<span class="sign">)</span><span class="sign">,</span> S13<span class="sign">)</span><span class="sign">)</span> <span class="sign">+</span>
<span class="line_number">2108 </span>            wi<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">*</span> <span class="sign">(</span>sigma2hat <span class="sign">*</span> <span class="sign">(</span>1 <span class="sign">+</span> sigma2dhat <span class="sign">*</span> si<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span> S2<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>t<span class="sign">(</span>S2<span class="sign">)</span> <span class="sign">-</span>
<span class="line_number">2109 </span>            sigma2hat <span class="sign">*</span> sigma2dhat <span class="sign">*</span> qi<span class="sign">[</span>i<span class="sign">]</span> <span class="sign">*</span> <span class="sign">(</span>S3<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>t<span class="sign">(</span>S2<span class="sign">)</span> <span class="sign">+</span> S2<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>t<span class="sign">(</span>S3<span class="sign">)</span><span class="sign">)</span> <span class="sign">+</span> 
<span class="line_number">2110 </span>            sigma2dhat <span class="sign">*</span> <span class="sign">(</span>1 <span class="sign">+</span> sigma2hat <span class="sign">*</span> pi<span class="sign">[</span>i<span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span> S3<span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>t<span class="sign">(</span>S3<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">2111 </span>    <span class="sign">}</span>
<span class="line_number">2112 </span>    <span class="keyword">return</span><span class="sign">(</span>S<span class="sign">)</span>
<span class="line_number">2113 </span><span class="sign">}</span>
</pre>

<hr />
<a name="ZZdebug2fmkprofgr"></a>
<a name="robo78"></a><h2>ZZdebug/mkprofgr [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo10">ZZdebug</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mkprofgr</strong> --- profile likelihood gradient
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute the gradient of the profile likelihood. 
    This is an R implementation for debugging only.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1659 </span><strong>mkprofgr</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> betahat<span class="sign">,</span> datamat<span class="sign">,</span> as<span class="sign">,</span> Uijmat<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m          number of clusters
    Ji         cluster sizes
    betahat    regression coefficient estimates 
    datamat    data matrix generated by <a href="#robo37">makedatamat</a> 
    as         matrix of discretization breakpoints 
    Uijmat     matrix of frailty estimates
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    likgr      gradient of profile loglikelihood of betahat conditional 
               on the other parameters
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1662 </span><span class="sign">{</span>
<span class="line_number">1663 </span>    <span class="comment"># Compute all m_rs and gradients</span>
<span class="line_number">1664 </span>    mrss <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo76">makemrs</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> as<span class="sign">,</span> betahat<span class="sign">,</span> Uijmat<span class="sign">)</span>
<span class="line_number">1665 </span>    mrs <span class="sign">&lt;</span><span class="sign">-</span> mrss<span class="sign">$</span>mrs
<span class="line_number">1666 </span>    mrsgr <span class="sign">&lt;</span><span class="sign">-</span> mrss<span class="sign">$</span>mrsgr
<span class="line_number">1667 </span>    <span class="comment"># Initialize vectors</span>
<span class="line_number">1668 </span>    likgr <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">rep</span><span class="sign">(</span>0<span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1669 </span>    covs <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>matrix<span class="sign">(</span>datamat<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span>c<span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1670 </span>    <span class="keyword">for</span><span class="sign">(</span>ind in 1<span class="sign">:</span><span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1671 </span>        smax <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">]</span>
<span class="line_number">1672 </span>        r <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"r"</span><span class="sign">]</span>
<span class="line_number">1673 </span>        delta <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"delta"</span><span class="sign">]</span>
<span class="line_number">1674 </span>        <span class="comment"># For each row in the data matrix, add the corresponding term to the gradient</span>
<span class="line_number">1675 </span>        likgr <span class="sign">&lt;</span><span class="sign">-</span> likgr <span class="sign">+</span> delta <span class="sign">*</span> <span class="sign">(</span>covs<span class="sign">[</span>ind<span class="sign">,</span> <span class="sign">]</span> <span class="sign">-</span> mrsgr<span class="sign">[</span>r<span class="sign">,</span> smax<span class="sign">,</span> <span class="sign">]</span> <span class="sign">/</span> mrs<span class="sign">[</span>r<span class="sign">,</span> smax<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1676 </span>    <span class="sign">}</span> 
<span class="line_number">1677 </span>    <span class="keyword">return</span><span class="sign">(</span>likgr<span class="sign">)</span>   
<span class="line_number">1678 </span><span class="sign">}</span>
</pre>

<hr />
<a name="ZZdebug2fmkproflik"></a>
<a name="robo79"></a><h2>ZZdebug/mkproflik [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo10">ZZdebug</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>mkproflik</strong> --- compute profile likelihood
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute profile likelihood of regression parameters for a single process.
    This is an R implementation of the Fortran routine <a href="../src/bivrec_f.html#robo29">fproflik</a> and is for
    debugging only.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1520 </span><strong>mkproflik</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> betahat<span class="sign">,</span> datamat<span class="sign">,</span> as<span class="sign">,</span> Uijmat<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m          number of clusters
    Ji         cluster sizes
    betahat    regression coefficient estimates 
    datamat    data matrix generated by <a href="#robo37">makedatamat</a> 
    as         matrix of discretization breakpoints 
    Uijmat     matrix of frailty estimates
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    loglik     profile loglikelihood of betahat conditional on the other parameters
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1523 </span><span class="sign">{</span>
<span class="line_number">1524 </span>    <span class="comment"># Compute mrs using <a href="#robo76">makemrs</a> function</span>
<span class="line_number">1525 </span>    mrss <span class="sign">&lt;</span><span class="sign">-</span> <a href="#robo76">makemrs</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> as<span class="sign">,</span> betahat<span class="sign">,</span> Uijmat<span class="sign">)</span>
<span class="line_number">1526 </span>    mrs <span class="sign">&lt;</span><span class="sign">-</span> mrss<span class="sign">$</span>mrs
<span class="line_number">1527 </span>    loglik <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">1528 </span>    covs <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>matrix<span class="sign">(</span>datamat<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span>c<span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1529 </span>    <span class="comment"># Loop over the entries in the data matrix, but do not loop over the s </span>
<span class="line_number">1530 </span>    <span class="comment"># values (delta can only be 1 on smax)</span>
<span class="line_number">1531 </span>    <span class="keyword">for</span><span class="sign">(</span>ind in 1<span class="sign">:</span><span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1532 </span>        i <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"i"</span><span class="sign">]</span>
<span class="line_number">1533 </span>        j <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"j"</span><span class="sign">]</span>
<span class="line_number">1534 </span>        k <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"k"</span><span class="sign">]</span>
<span class="line_number">1535 </span>        smax <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">]</span>
<span class="line_number">1536 </span>        smin <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">]</span>
<span class="line_number">1537 </span>        r <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"r"</span><span class="sign">]</span>
<span class="line_number">1538 </span>        delta <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"delta"</span><span class="sign">]</span>
<span class="line_number">1539 </span>        <span class="comment"># Add the term corresponding to each row in the data matrix </span>
<span class="line_number">1540 </span>        <span class="comment"># to the loglikelihood</span>
<span class="line_number">1541 </span>        loglik <span class="sign">&lt;</span><span class="sign">-</span> loglik <span class="sign">+</span> delta <span class="sign">*</span> <span class="sign">(</span>log<span class="sign">(</span>Uijmat<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span><span class="sign">)</span> <span class="sign">-</span> log<span class="sign">(</span>mrs<span class="sign">[</span>r<span class="sign">,</span> smax<span class="sign">]</span><span class="sign">)</span> <span class="sign">+</span>
<span class="line_number">1542 </span>            as<span class="sign">.</span>matrix<span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>covs<span class="sign">[</span>ind<span class="sign">,</span> <span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1543 </span>    <span class="sign">}</span> 
<span class="line_number">1544 </span>    <span class="keyword">return</span><span class="sign">(</span>loglik<span class="sign">)</span>   
<span class="line_number">1545 </span><span class="sign">}</span>
</pre>

<hr />
<a name="ZZdebug2fSmud2"></a>
<a name="robo80"></a><h2>ZZdebug/Smud2 [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo10">ZZdebug</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>Smud2</strong> --- compute cross and squared event counts
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute the sums of mu_rijks * delta_rijks and
    mu_rijks^2 for every (i,j). 
    This is an R implementation
    of the corresponding FORTRAN function used for debugging only.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1318 </span><strong>Smud2</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> alphars<span class="sign">,</span> as<span class="sign">,</span> betahat<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m          number of clusters
    Ji         cluster sizes
    datamat    data matrix generated by <a href="#robo37">makedatamat</a> 
    alphars    matrix of baseline hazard parameters 
    as         matrix of discretization breakpoints 
    betahat    regression coefficient estimates 
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    Smud       matrix containing sum of mu_rijks * delta_rijks for every (i,j)
    Smu2       matrix containing sum of mu_rijks^2 for every (i,j)
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1321 </span><span class="sign">{</span>
<span class="line_number">1322 </span>    jimax <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>Ji<span class="sign">)</span>
<span class="line_number">1323 </span>    covs <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>matrix<span class="sign">(</span>datamat<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span>c<span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1324 </span>    Smud <span class="sign">&lt;</span><span class="sign">-</span> 0<span class="sign">;</span>Smu2 <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">1325 </span>    <span class="keyword">for</span><span class="sign">(</span>ind in 1<span class="sign">:</span><span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1326 </span>    <span class="sign">{</span>
<span class="line_number">1327 </span>        i <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"i"</span><span class="sign">]</span>
<span class="line_number">1328 </span>        j <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"j"</span><span class="sign">]</span>
<span class="line_number">1329 </span>        r <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"r"</span><span class="sign">]</span>
<span class="line_number">1330 </span>        smax <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">]</span>
<span class="line_number">1331 </span>        smin <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">]</span>
<span class="line_number">1332 </span>        delta <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"delta"</span><span class="sign">]</span>
<span class="line_number">1333 </span>        <span class="keyword">for</span><span class="sign">(</span>s in smin<span class="sign">:</span>smax<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1334 </span>            mu <span class="sign">&lt;</span><span class="sign">-</span> 1 <span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span><span class="sign">-</span><span class="keyword">exp</span><span class="sign">(</span>as<span class="sign">.</span>matrix<span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>covs<span class="sign">[</span>ind<span class="sign">,</span> <span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span> 
<span class="line_number">1335 </span>                alphars<span class="sign">[</span>r<span class="sign">,</span> s<span class="sign">]</span> <span class="sign">*</span> <span class="sign">(</span>as<span class="sign">[</span>r<span class="sign">,</span> s <span class="sign">+</span> 1<span class="sign">]</span> <span class="sign">-</span> as<span class="sign">[</span>r<span class="sign">,</span> s<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1336 </span>            <span class="keyword">if</span><span class="sign">(</span>s <span class="sign">=</span><span class="sign">=</span> smax<span class="sign">)</span> deltat <span class="sign">&lt;</span><span class="sign">-</span> delta <span class="keyword">else</span> deltat <span class="sign">&lt;</span><span class="sign">-</span> 0
<span class="line_number">1337 </span>            Smud <span class="sign">&lt;</span><span class="sign">-</span> Smud <span class="sign">+</span> <span class="sign">(</span>mu <span class="sign">-</span> deltat<span class="sign">)</span><span class="sign">^</span>2
<span class="line_number">1338 </span>            Smu2 <span class="sign">&lt;</span><span class="sign">-</span> Smu2 <span class="sign">+</span> mu<span class="sign">^</span>2
<span class="line_number">1339 </span>        <span class="sign">}</span>
<span class="line_number">1340 </span>    <span class="sign">}</span>
<span class="line_number">1341 </span>    <span class="keyword">return</span><span class="sign">(</span><span class="keyword">list</span><span class="sign">(</span>Smud <span class="sign">=</span> Smud<span class="sign">,</span> Smu2 <span class="sign">=</span> Smu2<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1342 </span><span class="sign">}</span>
</pre>

<hr />
<a name="ZZdebug2fSmuij"></a>
<a name="robo81"></a><h2>ZZdebug/Smuij [ Functions ]</h2>

<p>[ <a href="#robo_top_of_doc">Top</a> ] [ <a href="#robo10">ZZdebug</a> ] [ <a href="../robo_functions.html#robo_top_of_doc">Functions</a> ]</p>
<p class="item_name">NAME</p>
<pre>    <strong>Smuij</strong> --- compute expected and observed event sums
</pre>
<p class="item_name">FUNCTION</p>
<p>    Compute the sums of mu_rijks and delta_rijks for every (i,j). 
    This is an R implementation
    of the corresponding FORTRAN function used for debugging only.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1273 </span><strong>Smuij</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> alphars<span class="sign">,</span> as<span class="sign">,</span> betahat<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m          number of clusters
    Ji         cluster sizes
    datamat    data matrix generated by <a href="#robo37">makedatamat</a> 
    alphars    matrix of baseline hazard parameters 
    as         matrix of discretization breakpoints 
    betahat    regression coefficient estimates 
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    Smu        matrix containing sum of mu_rijks for every (i,j)
    Sdelta     matrix containing sum of delta_rijks for every (i,j)
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1276 </span><span class="sign">{</span>
<span class="line_number">1277 </span>    jimax <span class="sign">&lt;</span><span class="sign">-</span> max<span class="sign">(</span>Ji<span class="sign">)</span>
<span class="line_number">1278 </span>    covs <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span>matrix<span class="sign">(</span>datamat<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span>c<span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">length</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1279 </span>    Smu <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>Sdelta <span class="sign">&lt;</span><span class="sign">-</span> matrix<span class="sign">(</span>0<span class="sign">,</span> m<span class="sign">,</span> jimax<span class="sign">)</span><span class="sign">;</span>
<span class="line_number">1280 </span>    <span class="keyword">for</span><span class="sign">(</span>ind in 1<span class="sign">:</span><span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span>
<span class="line_number">1281 </span>    <span class="sign">{</span>
<span class="line_number">1282 </span>        i <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"i"</span><span class="sign">]</span>
<span class="line_number">1283 </span>        j <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"j"</span><span class="sign">]</span>
<span class="line_number">1284 </span>        r <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"r"</span><span class="sign">]</span>
<span class="line_number">1285 </span>        smax <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">]</span>
<span class="line_number">1286 </span>        smin <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">]</span>
<span class="line_number">1287 </span>        delta <span class="sign">&lt;</span><span class="sign">-</span> datamat<span class="sign">[</span>ind<span class="sign">,</span> <span class="quote">"delta"</span><span class="sign">]</span>
<span class="line_number">1288 </span>        <span class="keyword">for</span><span class="sign">(</span>s in smin<span class="sign">:</span>smax<span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1289 </span>            mu <span class="sign">&lt;</span><span class="sign">-</span> 1 <span class="sign">-</span> <span class="keyword">exp</span><span class="sign">(</span><span class="sign">-</span><span class="keyword">exp</span><span class="sign">(</span>as<span class="sign">.</span>matrix<span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">%</span><span class="sign">*</span><span class="sign">%</span>covs<span class="sign">[</span>ind<span class="sign">,</span> <span class="sign">]</span><span class="sign">)</span> <span class="sign">*</span> alphars<span class="sign">[</span>r<span class="sign">,</span> s<span class="sign">]</span> <span class="sign">*</span> <span class="sign">(</span>as<span class="sign">[</span>r<span class="sign">,</span> s <span class="sign">+</span> 1<span class="sign">]</span> <span class="sign">-</span> as<span class="sign">[</span>r<span class="sign">,</span> s<span class="sign">]</span><span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1290 </span>            Smu<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> Smu<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> mu
<span class="line_number">1291 </span>        <span class="sign">}</span>
<span class="line_number">1292 </span>        Sdelta<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">&lt;</span><span class="sign">-</span> Sdelta<span class="sign">[</span>i<span class="sign">,</span> j<span class="sign">]</span> <span class="sign">+</span> delta
<span class="line_number">1293 </span>    <span class="sign">}</span>
<span class="line_number">1294 </span>    <span class="keyword">return</span><span class="sign">(</span><span class="keyword">list</span><span class="sign">(</span>Smu <span class="sign">=</span> Smu<span class="sign">,</span> Sdelta <span class="sign">=</span> Sdelta<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1295 </span><span class="sign">}</span>
</pre>

</div> <!-- content -->
<div id="footer">
<p>Generated from ./blupsurv/R/bivrec.r with <a href="http://www.xs4all.nl/~rfsber/Robo/robodoc.html">ROBODoc</a> V4.99.36 on Thu Jun 19 2008 17:25:40
</p>
</div> <!-- footer -->
</body>
</html>
