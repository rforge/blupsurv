<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-type" content="text/html; charset=ISO-8859-1" />
<link rel="stylesheet" href="../robodoc.css" type="text/css" />
<title>./blupsurv/R/bivrec.r</title>
<!-- Source: ./blupsurv/R/bivrec.r -->
<!-- Generated with ROBODoc Version 4.99.36 (Jun 17 2008) -->
</head>
<body>
<div id="logo">

<a name="robo_top_of_doc" href="http://blupsurv.r-forge.r-project.org/">blupsurv</a>
</div> <!-- logo -->
<div id="navigation">
<a class="menuitem" href="./bivrec_rbivrecFit2Festimation.html#robo6">estimation</a><a class="menuitem" href="../robo_functions.html#robo_top_of_doc">Functions</a></div> <!-- navigation -->
<div id="content">
<h3>TABLE OF CONTENTS</h3>
<ul>
<li>1. <a href="#robo19">estimation/updateregprof</a></li>
</ul>
<hr />
<a name="estimation2fupdateregprof"></a>
<a name="robo19"></a><h2>estimation/updateregprof [ Functions ]</h2>

<p class="item_name">NAME</p>
<pre>    <strong>updateregprof</strong> --- update regression coefficients (profile likelihood)
</pre>
<p class="item_name">FUNCTION</p>
<p>    Update regression coefficients beta1 and beta1 by maximizing the condition
    profile loglikelihood given all the other parameters. Give the regression
    coefficients, the baseline hazard coefficients are then updated.
</p>
<p class="item_name">SYNOPSIS</p>
<pre class="source"><span class="line_number">1876 </span><strong>updateregprof</strong> <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">function</span><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> datamatd<span class="sign">,</span> alphars<span class="sign">,</span> alpharsd<span class="sign">,</span> as<span class="sign">,</span> asd<span class="sign">,</span> 
<span class="line_number">1877 </span>    betahat<span class="sign">,</span> betadhat<span class="sign">,</span> K<span class="sign">,</span> Kd<span class="sign">,</span> frailtyoutput<span class="sign">,</span> dispersionoutput<span class="sign">,</span> smooth<span class="sign">)</span>
</pre>
<p class="item_name">INPUTS</p>
<pre>    m              number of clusters
    Ji             cluster sizes
    datamat        data matrix generated by <a href="./bivrec_rinitialization2Fmakedatamat.html#robo37">makedatamat</a> for event 1
    datamatd       data matrix generated by <a href="./bivrec_rinitialization2Fmakedatamat.html#robo37">makedatamat</a> for event 2
    alphars            matrix of baseline hazard parameters for event 1
    alpharsd           matrix of baseline hazard parameters for event 2
    as                 matrix of discretization breakpoints for event 1
    asd                matrix of discretization breakpoints for event 2
    betahat            regression coefficient estimates for event 
    betadhat           regression coefficient estimates for event 2
    K                  number of discretization intervals for event 1
    Kd                 number of discretization intervals for event 2
    frailtyoutput  output from <a href="./bivrec_restimation2Ffupdatefrailties4.html#robo13">fupdatefrailties4</a>
    dispersionoutput  output from one of the dispersion <a href="./bivrec_rbivrecFit2Festimation.html#robo6">estimation</a> routines
    smooth         boolean, indicating whether hazard estimates should be smoothed
</pre>
<p class="item_name">OUTPUTS</p>
<pre>    betahat            regression coefficient estimates for event 
    betadhat           regression coefficient estimates for event 2
    alphars            matrix of baseline hazard parameters for event 1
    alpharsd           matrix of baseline hazard parameters for event 2
    as                 matrix of discretization breakpoints for event 1
    asd                matrix of discretization breakpoints for event 2
    loglik         loglikelihood ( = loglik1 + loglik2 )
    loglik1        profile loglikelihood of betahat
    loglik2        profile loglikelihood of betadhat
</pre>
<p class="item_name">SOURCE</p>
<pre class="source"><span class="line_number">1880 </span><span class="sign">{</span>
<span class="line_number">1881 </span>    
<span class="line_number">1882 </span>    <span class="comment"># Prepare vectors and matrices for direct submission into Fortran, </span>
<span class="line_number">1883 </span>    <span class="comment"># without requiring type conversions</span>
<span class="line_number">1884 </span>    Uijhatframe <span class="sign">&lt;</span><span class="sign">-</span> frailtyoutput<span class="sign">$</span>Uijframe
<span class="line_number">1885 </span>    fUijmat <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Uijhatframe<span class="sign">$</span>Uijmat<span class="sign">)</span>  <span class="comment"># Frailty matrices</span>
<span class="line_number">1886 </span>    fVijmat <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>Uijhatframe<span class="sign">$</span>Vijmat<span class="sign">)</span>    
<span class="line_number">1887 </span>    fas <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>as<span class="sign">)</span>    <span class="comment"># Baseline hazard parameters</span>
<span class="line_number">1888 </span>    fasd <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>asd<span class="sign">)</span>
<span class="line_number">1889 </span>    <span class="comment"># Covariates for event 1</span>
<span class="line_number">1890 </span>    Z <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>matrix<span class="sign">(</span>datamat<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 8<span class="sign">)</span><span class="sign">)</span> 
<span class="line_number">1891 </span>    ncovs <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">length</span><span class="sign">(</span>betahat<span class="sign">)</span><span class="sign">)</span>   <span class="comment"># number of covariates</span>
<span class="line_number">1892 </span>    d1 <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>datamat<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span>     <span class="comment"># data matrix dimension (event 1)</span>
<span class="line_number">1893 </span>    index <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>datamat<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span><span class="quote">"i"</span><span class="sign">,</span> <span class="quote">"j"</span><span class="sign">,</span> <span class="quote">"k"</span><span class="sign">,</span> <span class="quote">"r"</span><span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">)</span><span class="sign">]</span><span class="sign">)</span>   
<span class="line_number">1894 </span>    delta <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>datamat<span class="sign">[</span><span class="sign">,</span> <span class="quote">"delta"</span><span class="sign">]</span><span class="sign">)</span>     <span class="comment"># recurrent event indicators</span>
<span class="line_number">1895 </span>    times <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>datamat<span class="sign">[</span><span class="sign">,</span> <span class="quote">"time"</span><span class="sign">]</span><span class="sign">)</span>     <span class="comment"># recurrent event times</span>
<span class="line_number">1896 </span>    <span class="comment"># Covariates for event 2</span>
<span class="line_number">1897 </span>    Zd <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>matrix<span class="sign">(</span>datamatd<span class="sign">[</span><span class="sign">,</span> <span class="sign">-</span><span class="sign">(</span>1<span class="sign">:</span>8<span class="sign">)</span><span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamatd<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">,</span> <span class="keyword">dim</span><span class="sign">(</span>datamatd<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span> <span class="sign">-</span> 8<span class="sign">)</span><span class="sign">)</span> 
<span class="line_number">1898 </span>    d2 <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>datamatd<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span>     <span class="comment"># data matrix dimension (event 2)</span>
<span class="line_number">1899 </span>    indexd <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span>datamatd<span class="sign">[</span><span class="sign">,</span> c<span class="sign">(</span><span class="quote">"i"</span><span class="sign">,</span> <span class="quote">"j"</span><span class="sign">,</span> <span class="quote">"k"</span><span class="sign">,</span> <span class="quote">"r"</span><span class="sign">,</span> <span class="quote">"smin"</span><span class="sign">,</span> <span class="quote">"smax"</span><span class="sign">)</span><span class="sign">]</span><span class="sign">)</span>  
<span class="line_number">1900 </span>    deltad <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>datamatd<span class="sign">[</span><span class="sign">,</span> <span class="quote">"delta"</span><span class="sign">]</span><span class="sign">)</span>  <span class="comment"># terminal event indicators</span>
<span class="line_number">1901 </span>    timesd <span class="sign">&lt;</span><span class="sign">-</span> as<span class="sign">.</span><span class="keyword">double</span><span class="sign">(</span>datamatd<span class="sign">[</span><span class="sign">,</span> <span class="quote">"time"</span><span class="sign">]</span><span class="sign">)</span>   <span class="comment"># terminal event times</span>
<span class="line_number">1902 </span>    nr <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>1<span class="sign">]</span><span class="sign">)</span>    <span class="comment"># Maximum value of r (number of strata)</span>
<span class="line_number">1903 </span>    ns <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>as<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span>    <span class="comment"># Maximum value of s (recurrent) + 1</span>
<span class="line_number">1904 </span>    nsd <span class="sign">=</span> as<span class="sign">.</span><span class="keyword">integer</span><span class="sign">(</span><span class="keyword">dim</span><span class="sign">(</span>asd<span class="sign">)</span><span class="sign">[</span>2<span class="sign">]</span><span class="sign">)</span>  <span class="comment"># Maximum value of s (terminal)  + 1 </span>
<span class="line_number">1905 </span>
<span class="line_number">1906 </span>    <span class="comment"># Update regression parameters betahat, betadhat using the profile likelihood. </span>
<span class="line_number">1907 </span>    <span class="comment"># Use the built-in  optim method with the BFGS algorithm.</span>
<span class="line_number">1908 </span>    <span class="comment"># The loglikelihood is computed via fmkproflik2and the gradient </span>
<span class="line_number">1909 </span>    <span class="comment"># via <a href="./bivrec_rfortranwrappers2Ffmkprofgr2.html#robo33">fmkprofgr2</a>. Conditionally on the frailties, the processes are </span>
<span class="line_number">1910 </span>    <span class="comment"># independent and can be fit separately </span>
<span class="line_number">1911 </span>    opt <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span>optim<span class="sign">(</span>betahat<span class="sign">,</span> fn <span class="sign">=</span> <a href="./bivrec_rfortranwrappers2Ffmkproflik2.html#robo34">fmkproflik2</a><span class="sign">,</span> gr <span class="sign">=</span> <a href="./bivrec_rfortranwrappers2Ffmkprofgr2.html#robo33">fmkprofgr2</a><span class="sign">,</span>
<span class="line_number">1912 </span>        control <span class="sign">=</span> <span class="keyword">list</span><span class="sign">(</span>fnscale<span class="sign">=</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">,</span> method <span class="sign">=</span> <span class="quote">"BFGS"</span><span class="sign">,</span>
<span class="line_number">1913 </span>        m <span class="sign">=</span> m<span class="sign">,</span> Ji <span class="sign">=</span> Ji<span class="sign">,</span> index <span class="sign">=</span> index<span class="sign">,</span> Z <span class="sign">=</span> Z<span class="sign">,</span> delta <span class="sign">=</span> delta<span class="sign">,</span> times <span class="sign">=</span> times<span class="sign">,</span> as <span class="sign">=</span> fas<span class="sign">,</span> 
<span class="line_number">1914 </span>        Uijmat <span class="sign">=</span> fUijmat<span class="sign">,</span> ncovs <span class="sign">=</span> ncovs<span class="sign">,</span> d <span class="sign">=</span> d1<span class="sign">,</span> nr <span class="sign">=</span> nr<span class="sign">,</span> ns <span class="sign">=</span> ns<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1915 </span>    optd <span class="sign">&lt;</span><span class="sign">-</span> <span class="keyword">try</span><span class="sign">(</span>optim<span class="sign">(</span>betadhat<span class="sign">,</span> fn <span class="sign">=</span> <a href="./bivrec_rfortranwrappers2Ffmkproflik2.html#robo34">fmkproflik2</a><span class="sign">,</span> gr <span class="sign">=</span> <a href="./bivrec_rfortranwrappers2Ffmkprofgr2.html#robo33">fmkprofgr2</a><span class="sign">,</span> 
<span class="line_number">1916 </span>    control <span class="sign">=</span> <span class="keyword">list</span><span class="sign">(</span>fnscale<span class="sign">=</span><span class="sign">-</span>1<span class="sign">)</span><span class="sign">,</span> method <span class="sign">=</span> <span class="quote">"BFGS"</span><span class="sign">,</span> 
<span class="line_number">1917 </span>        m <span class="sign">=</span> m<span class="sign">,</span> Ji <span class="sign">=</span> Ji<span class="sign">,</span> index <span class="sign">=</span> indexd<span class="sign">,</span> Z <span class="sign">=</span> Zd<span class="sign">,</span> delta <span class="sign">=</span> deltad<span class="sign">,</span> times <span class="sign">=</span> timesd<span class="sign">,</span> 
<span class="line_number">1918 </span>        as <span class="sign">=</span> fasd<span class="sign">,</span> Uijmat <span class="sign">=</span> fVijmat<span class="sign">,</span> ncovs <span class="sign">=</span> ncovs<span class="sign">,</span> d <span class="sign">=</span> d2<span class="sign">,</span> nr <span class="sign">=</span> nr<span class="sign">,</span> ns <span class="sign">=</span> nsd<span class="sign">)</span><span class="sign">)</span>
<span class="line_number">1919 </span>    <span class="comment"># Check for errors and quit if it didn't converge</span>
<span class="line_number">1920 </span>    <span class="keyword">if</span><span class="sign">(</span>inherits<span class="sign">(</span>opt<span class="sign">,</span> <span class="quote">"try - error"</span><span class="sign">)</span> <span class="sign">|</span> inherits<span class="sign">(</span>optd<span class="sign">,</span> <span class="quote">"try - error"</span><span class="sign">)</span><span class="sign">)</span><span class="sign">{</span>
<span class="line_number">1921 </span>        warning<span class="sign">(</span><span class="quote">"Inner loop did not converge"</span><span class="sign">)</span>
<span class="line_number">1922 </span>          browser<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">1923 </span>        <span class="keyword">return</span><span class="sign">(</span>0<span class="sign">)</span>
<span class="line_number">1924 </span>    <span class="sign">}</span>    
<span class="line_number">1925 </span>    <span class="keyword">if</span><span class="sign">(</span>opt<span class="sign">$</span>convergence <span class="comment">!= 0 | optd$convergence != 0){</span>
<span class="line_number">1926 </span>        warning<span class="sign">(</span><span class="quote">"Inner loop did not converge"</span><span class="sign">)</span>
<span class="line_number">1927 </span>          browser<span class="sign">(</span><span class="sign">)</span>
<span class="line_number">1928 </span>        <span class="keyword">return</span><span class="sign">(</span>0<span class="sign">)</span>
<span class="line_number">1929 </span>    <span class="sign">}</span>       
<span class="line_number">1930 </span>    betahat <span class="sign">&lt;</span><span class="sign">-</span> opt<span class="sign">$</span>par
<span class="line_number">1931 </span>    betadhat <span class="sign">&lt;</span><span class="sign">-</span> optd<span class="sign">$</span>par
<span class="line_number">1932 </span>    loglik1 <span class="sign">&lt;</span><span class="sign">-</span> opt<span class="sign">$</span>value
<span class="line_number">1933 </span>    loglik2 <span class="sign">&lt;</span><span class="sign">-</span> optd<span class="sign">$</span>value
<span class="line_number">1934 </span>    loglik <span class="sign">&lt;</span><span class="sign">-</span> loglik1 <span class="sign">+</span> loglik2
<span class="line_number">1935 </span>    <span class="comment"># Given the updated regression parameters, compute the </span>
<span class="line_number">1936 </span>    <span class="comment"># corresponding baseline hazard parameters</span>
<span class="line_number">1937 </span>    alphars <span class="sign">&lt;</span><span class="sign">-</span> <a href="./bivrec_restimation2Ffmakealphars2.html#robo12">fmakealphars2</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamat<span class="sign">,</span> betahat<span class="sign">,</span> as<span class="sign">,</span> fUijmat<span class="sign">,</span> smooth<span class="sign">)</span>
<span class="line_number">1938 </span>    alpharsd <span class="sign">&lt;</span><span class="sign">-</span> <a href="./bivrec_restimation2Ffmakealphars2.html#robo12">fmakealphars2</a><span class="sign">(</span>m<span class="sign">,</span> Ji<span class="sign">,</span> datamatd<span class="sign">,</span> betadhat<span class="sign">,</span> asd<span class="sign">,</span> fVijmat<span class="sign">,</span> smooth<span class="sign">)</span>
<span class="line_number">1939 </span>    
<span class="line_number">1940 </span>    <span class="comment"># Format for output</span>
<span class="line_number">1941 </span>    <span class="keyword">return</span><span class="sign">(</span><span class="keyword">list</span><span class="sign">(</span>betahat <span class="sign">=</span> betahat<span class="sign">,</span> betadhat <span class="sign">=</span> betadhat<span class="sign">,</span>
<span class="line_number">1942 </span>                alphars <span class="sign">=</span> alphars<span class="sign">,</span> alpharsd <span class="sign">=</span> alpharsd<span class="sign">,</span>
<span class="line_number">1943 </span>                as <span class="sign">=</span> as<span class="sign">,</span> asd <span class="sign">=</span> asd<span class="sign">,</span>
<span class="line_number">1944 </span>                loglik <span class="sign">=</span> loglik<span class="sign">,</span> loglik1 <span class="sign">=</span> loglik1<span class="sign">,</span> loglik2 <span class="sign">=</span> loglik2<span class="sign">)</span><span class="sign">)</span>  
<span class="line_number">1945 </span><span class="sign">}</span>
</pre>

</div> <!-- content -->
<div id="footer">
<p>Generated from ./blupsurv/R/bivrec.r with <a href="http://www.xs4all.nl/~rfsber/Robo/robodoc.html">ROBODoc</a> V4.99.36 on Wed Jul 16 2008 11:47:16
</p>
</div> <!-- footer -->

<!-- Start of StatCounter Code -->
<script type="text/javascript">
var sc_project=3825293; 
var sc_invisible=1; 
var sc_partition=34; 
var sc_click_stat=1; 
var sc_security="2dd2334a"; 
</script>

<script type="text/javascript"
src="http://www.statcounter.com/counter/counter_xhtml.js"></script><noscript><div
class="statcounter"><a href="http://www.statcounter.com/"
target="_blank"><img class="statcounter"
src="http://c.statcounter.com/3825293/0/2dd2334a/1/" alt="free html hit
counter" ></a></div></noscript>
<!-- End of StatCounter Code -->
</body>

</html>
